<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DETION ARENA: LEAGUE OF DUNGEONEERS</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #2D2D2D;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        /* Contenedor principal */
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Fondo */
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }
        
        /* Panel de configuración */
        .config-panel {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        #nivel-panel {
            top: 43%;
            left: 10.6%;
            transform: translate(-50%, -50%);
        }
        
        #apuesta-panel {
            top: 43%;
            right: 15.4%;
            transform: translate(50%, -50%);
        }
        
        .config-label {
            background-color: transparent;
            color: black;
            font-weight: bold;
            font-size: 50px;
            min-width: 80px;
            text-align: center;
        }
        
        /* Botones */
        .btn {
            background-color: #2D2D2D;
            border: none;
            width: 80px;
            height: 80px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .btn:hover {
            background-color: #3D3D3D;
        }
        
        .btn:disabled {
            background-color: #555555;
            cursor: not-allowed;
        }
        
        /* Botones principales */
        #main-buttons {
            position: absolute;
            bottom: 6%;
            display: flex;
            gap: 12%;
            width: 70%;
            justify-content: center;
        }
        
        /* Log de eventos */
        #event-log {
            position: absolute;
            top: 41%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1000px;
            height: 300px;
            background-color: transparent;
            color: black;
            border: none;
            font-size: 14px;
            text-align: center;
            overflow: auto;
            padding: 10px;
        }
        
        /* Log de recompensas */
        #reward-log {
            position: absolute;
            top: 73%;
            left: 50%;
            transform: translateX(-50%);
            width: 450px;
            height: 250px;
            background-color: transparent;
            color: black;
            border: none;
            font-size: 10px;
            text-align: center;
            overflow: auto;
            padding: 10px;
            display: none;
        }
        
        /* Estilos de texto para diferentes tipos de mensajes */
        .log-titulo {
            color: #000000;
            font-size: 16px;
            font-weight: bold;
        }
        
        .log-recompensa {
            color: #006400;
            font-size: 13px;
        }
        
        .log-enemigo {
            color: #8B0000;
            font-size: 16px;
            font-weight: bold;
        }
        
        .log-lista {
            color: #000000;
            font-size: 12px;
        }
        
        .log-ronda {
            color: #000000;
            font-size: 14px;
            font-weight: bold;
        }
        
        .log-heroico {
            color: #006400;
            font-size: 13px;
            font-weight: bold;
        }
        
        .log-deshonroso {
            color: #8B0000;
            font-size: 13px;
            font-weight: bold;
        }
        
        .log-publico {
            color: #000000;
            font-size: 13px;
            font-style: italic;
        }
        
        .log-efecto {
            color: #000000;
            font-size: 13px;
        }
        
        .log-critical {
            color: #8B0000;
            font-size: 13px;
            font-weight: bold;
            animation: blink 0.5s infinite;
        }
        
        .log-apuesta {
            color: #006400;
            font-size: 13px;
            font-weight: bold;
        }
        
        .log-center {
            color: #000000;
            font-size: 14px;
        }
        
        .log-speaker {
            color: #8B4513;
            font-size: 14px;
            font-weight: bold;
            font-style: italic;
        }
        
        .log-blink {
            animation: blink 0.5s infinite;
        }
        
        @keyframes blink {
            0% { color: #8b0000; }
            50% { color: #FFCCCB; }
            100% { color: #8b0000; }
        }
        
        /* Scrollbar personalizado */
        #event-log::-webkit-scrollbar, #reward-log::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        
        /* Overlay de inicio para música */
        #music-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #music-overlay p {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #start-audio {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #start-audio:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <!-- Overlay para activar audio -->
    <div id="music-overlay">
        <p>¡Bienvenido a DETION ARENA!</p>
        <p>Haz clic para activar la música de fondo</p>
        <button id="start-audio">Activar Música</button>
    </div>

    <div id="app-container">
        <!-- Fondo -->
        <div id="background"></div>
        
        <!-- Panel de nivel -->
        <div id="nivel-panel" class="config-panel">
            <button id="btn-nivel-down" class="btn"></button>
            <div id="nivel-label" class="config-label">1</div>
            <button id="btn-nivel-up" class="btn"></button>
        </div>
        
        <!-- Panel de apuesta -->
        <div id="apuesta-panel" class="config-panel">
            <button id="btn-apuesta-down" class="btn"></button>
            <div id="apuesta-label" class="config-label">0</div>
            <button id="btn-apuesta-up" class="btn"></button>
        </div>
        
        <!-- Log de eventos -->
        <div id="event-log"></div>
        
        <!-- Log de recompensas -->
        <div id="reward-log"></div>
        
        <!-- Botones principales -->
        <div id="main-buttons">
            <button id="btn-iniciar" class="btn"></button>
            <button id="btn-ronda" class="btn" disabled></button>
            <button id="btn-heroico" class="btn" disabled></button>
            <button id="btn-deshonroso" class="btn" disabled></button>
            <button id="btn-musica-on" class="btn"></button>
            <button id="btn-musica-off" class="btn" style="display:none;"></button>
            <button id="btn-reiniciar" class="btn"></button>
            <button id="btn-reglas" class="btn"></button>
        </div>
    </div>

    <script>
        // Clase principal de la aplicación
        class ArenaApp {
            constructor() {
                this._setupAttributes();
                
                // Configurar el overlay de música primero
                this.setupMusicOverlay();
                
                // Inicializar después de que el usuario interactúe
                document.getElementById('start-audio').addEventListener('click', () => {
                    this.init();
                    document.getElementById('music-overlay').style.display = 'none';
                });
            }
            
            _setupAttributes() {
                // Rutas base
                this.BASE_DIR = window.location.href.replace(/\/[^\/]*$/, '');
                this.IMAGES_DIR = `${this.BASE_DIR}/assets/imagenes`;
                this.AUDIO_DIR = `${this.BASE_DIR}/assets/audio`;
                this.DATA_DIR = `${this.BASE_DIR}/assets/data`;
                
                // Configuraciones
                this.ui_config = null;
                this.estados_config = null;
                this.descansos = null;
                this.recompensas = null;
                this.comportamiento = null;
                
                // Estado del juego
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.moral_grupo = 0;
                this.cordura = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
                
                // Control de música
                this.musica_activada = true;
                this.audioContext = null;
                this.audioElement = null;
                this.audioGain = null;
                
                // Valores de configuración
                this.nivel_valor = 1;
                this.apuesta_valor = 0;
                
                // Efectos
                this.blink_state = false;
                this.blink_interval = null;
                
                // Factores de escala
                this.width_scale = 1.0;
                this.height_scale = 1.0;
                this.scale_factor = 1.0;
            }
            
            setupMusicOverlay() {
                // Esta función ya está implementada con el overlay HTML
                // Solo necesitamos asegurarnos de que esté visible al inicio
                document.getElementById('music-overlay').style.display = 'flex';
            }
            
            async init() {
                await this.cargarConfiguraciones();
                this.inicializarUI();
                this.inicializarEstados();
                this.inicializarMusica();
                this.mostrarMensajeBienvenida();
                this.iniciarEfectoParpadeo();
                this.configurarEventos();
            }
            
            async cargarConfiguraciones() {
                try {
                    // Cargar configuraciones desde archivos JSON
                    const configFiles = [
                        'ui_config.json',
                        'estados.json',
                        'descansos.json',
                        'recompensas.json',
                        'comportamiento.json'
                    ];
                    
                    // Cargar cada archivo de configuración
                    const [uiConfig, estadosConfig, descansosConfig, recompensasConfig, comportamientoConfig] = await Promise.all(
                        configFiles.map(file => 
                            fetch(`${this.DATA_DIR}/${file}`)
                                .then(response => {
                                    if (!response.ok) throw new Error(`No se pudo cargar ${file}`);
                                    return response.json();
                                })
                        )
                    );
                    
                    this.ui_config = uiConfig;
                    this.estados_config = estadosConfig;
                    this.descansos = descansosConfig;
                    this.recompensas = recompensasConfig;
                    this.comportamiento = comportamientoConfig;
                    
                    // Cargar encuentros según el nivel
                    await this.cargarEncuentros();
                    
                } catch (e) {
                    console.error("Error cargando configuraciones:", e);
                    
                    // Configuración de respaldo si no se pueden cargar los archivos
                    this.estados_config = {
                        limites: {
                            moral_max: 10,
                            cordura_max: 10
                        },
                        efectos: {
                            heroico: { moral: 1 },
                            deshonroso: { cordura: -1 }
                        }
                    };
                    
                    this.descansos = {
                        corto: {
                            descripcion: "DESCANSO CORTO",
                            beneficios: [
                                "Los héroes recuperan el aliento",
                                "Curan heridas leves",
                                "Preparan la siguiente ronda"
                            ],
                            efectos: {
                                moral: 1,
                                cordura: "1d4"
                            }
                        }
                    };
                    
                    this.recompensas = {
                        nivel_1_2: {
                            multiplicador_monedas: 1.5,
                            monedas: 100,
                            experiencia: 50,
                            tesoros: ["Poción de curación menor", "Escudo de madera"]
                        },
                        nivel_3_4: {
                            multiplicador_monedas: 2.0,
                            monedas: 200,
                            experiencia: 100,
                            tesoros: ["Espada de acero", "Armadura de cuero"]
                        },
                        nivel_5_6: {
                            multiplicador_monedas: 2.5,
                            monedas: 300,
                            experiencia: 200,
                            tesoros: ["Arco élfico", "Amuleto de protección"]
                        },
                        nivel_7_8: {
                            multiplicador_monedas: 3.0,
                            monedas: 500,
                            experiencia: 400,
                            tesoros: ["Espada legendaria", "Armadura de placas"]
                        }
                    };
                    
                    this.comportamiento = {
                        reacciones_publico: {
                            apoyo: [
                                { id: 1, efecto: "El público vitorea a los héroes" },
                                { id: 4, efecto: "¡Oleada de apoyo! Los héroes se sienten inspirados" },
                                { id: 19, efecto: "El público canta himnos de gloria" }
                            ],
                            desprecio: [
                                { id: 4, efecto: "El público abuchea a los héroes" },
                                { id: 5, efecto: "Gritos de ira afectan la cordura de los héroes" }
                            ]
                        }
                    };
                    
                    // Cargar encuentros de ejemplo
                    this.encuentros = {
                        ronda_1: [
                            { rango: "1-30", enemigos: "Lobos y Jabalíes" },
                            { rango: "31-70", enemigos: "Bandidos y Asaltantes" },
                            { rango: "71-100", enemigos: "Orcos y Goblins" }
                        ],
                        ronda_2: [
                            { rango: "1-25", enemigos: "Trolls y Ogros" },
                            { rango: "26-60", enemigos: "Esqueletos y Zombis" },
                            { rango: "61-100", enemigos: "Magos Oscuros y Necromantes" }
                        ],
                        ronda_3: [
                            { rango: "1-40", enemigos: "Dragón Rojo" },
                            { rango: "41-100", enemigos: "Demonio del Abismo" }
                        ]
                    };
                }
            }
            
            async cargarEncuentros() {
                try {
                    // Determinar archivo según nivel
                    let archivoEncuentros;
                    if (this.nivel_valor >= 1 && this.nivel_valor <= 2) {
                        archivoEncuentros = "nivel_1_2.json";
                    } else if (this.nivel_valor >= 3 && this.nivel_valor <= 4) {
                        archivoEncuentros = "nivel_3_4.json";
                    } else if (this.nivel_valor >= 5 && this.nivel_valor <= 6) {
                        archivoEncuentros = "nivel_5_6.json";
                    } else if (this.nivel_valor >= 7 && this.nivel_valor <= 10) {
                        archivoEncuentros = "nivel_7_8.json";
                    }
                    
                    if (archivoEncuentros) {
                        const response = await fetch(`${this.DATA_DIR}/encuentros/${archivoEncuentros}`);
                        if (response.ok) {
                            this.encuentros = await response.json();
                        } else {
                            throw new Error(`No se pudo cargar ${archivoEncuentros}`);
                        }
                    }
                } catch (e) {
                    console.error("Error cargando encuentros:", e);
                    // Usar encuentros por defecto si hay error
                    this.encuentros = {
                        ronda_1: [
                            { rango: "1-30", enemigos: "Lobos y Jabalíes" },
                            { rango: "31-70", enemigos: "Bandidos y Asaltantes" },
                            { rango: "71-100", enemigos: "Orcos y Goblins" }
                        ],
                        ronda_2: [
                            { rango: "1-25", enemigos: "Trolls y Ogros" },
                            { rango: "26-60", enemigos: "Esqueletos y Zombis" },
                            { rango: "61-100", enemigos: "Magos Oscuros y Necromantes" }
                        ],
                        ronda_3: [
                            { rango: "1-40", enemigos: "Dragón Rojo" },
                            { rango: "41-100", enemigos: "Demonio del Abismo" }
                        ]
                    };
                }
            }
            
            inicializarUI() {
                // Cargar imágenes de fondo y botones
                this.cargarImagenFondo();
                this.cargarImagenesBotones();
                
                // Ajustar inicial de la UI
                this.calcularFactoresEscala();
                this.aplicarEscaladoCompleto();
                
                // Configurar evento de redimensionamiento
                window.addEventListener('resize', () => {
                    this.calcularFactoresEscala();
                    this.aplicarEscaladoCompleto();
                    this.cargarImagenFondo();
                });
            }
            
            cargarImagenFondo() {
                const background = document.getElementById('background');
                // Usar una imagen de fondo por defecto si no existe la específica
                background.style.backgroundImage = `url('${this.IMAGES_DIR}/fondo.png'), url('https://placehold.co/1920x1080/2D2D2D/FFFFFF/png?text=DETION+ARENA')`;
            }
            
            cargarImagenesBotones() {
                // Botones de configuración
                this.cargarImagenBoton('btn-nivel-down', 'btn_nivel_down.png');
                this.cargarImagenBoton('btn-nivel-up', 'btn_nivel_up.png');
                this.cargarImagenBoton('btn-apuesta-down', 'btn_apuesta_down.png');
                this.cargarImagenBoton('btn-apuesta-up', 'btn_apuesta_up.png');
                
                // Botones principales
                this.cargarImagenBoton('btn-iniciar', 'btn_iniciar.png');
                this.cargarImagenBoton('btn-ronda', 'btn_ronda.png');
                this.cargarImagenBoton('btn-heroico', 'btn_heroico.png');
                this.cargarImagenBoton('btn-deshonroso', 'btn_deshonroso.png');
                this.cargarImagenBoton('btn-musica-on', 'btn_con_musica.png');
                this.cargarImagenBoton('btn-musica-off', 'btn_sin_musica.png');
                this.cargarImagenBoton('btn-reiniciar', 'btn_reiniciar.png');
                this.cargarImagenBoton('btn-reglas', 'btn_reglas.png');
            }
            
            cargarImagenBoton(elementId, imageName) {
                const element = document.getElementById(elementId);
                if (element) {
                    // Usar imagen por defecto si no existe la específica
                    element.style.backgroundImage = `url('${this.IMAGES_DIR}/${imageName}'), url('https://placehold.co/80x80/555555/FFFFFF/png?text=${imageName.replace('.png', '')}')`;
                }
            }
            
            inicializarMusica() {
                try {
                    // Crear contexto de audio
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Crear elemento de audio
                    this.audioElement = new Audio();
                    
                    // Configurar para loop
                    this.audioElement.loop = true;
                    
                    // Crear nodo de ganancia para control de volumen
                    this.audioGain = this.audioContext.createGain();
                    this.audioGain.gain.value = 0.7; // 70% de volumen
                    
                    // Conectar la fuente de audio al nodo de ganancia y luego a los altavoces
                    const source = this.audioContext.createMediaElementSource(this.audioElement);
                    source.connect(this.audioGain);
                    this.audioGain.connect(this.audioContext.destination);
                    
                    // Cargar música
                    this.audioElement.src = `${this.AUDIO_DIR}/musica_fondo.mp3`;
                    
                    // Intentar reproducir (ya tenemos interacción del usuario por el overlay)
                    if (this.musica_activada) {
                        this.audioElement.play().catch(e => {
                            console.error("Error al reproducir música:", e);
                            // Si falla, mostrar de nuevo el overlay
                            document.getElementById('music-overlay').style.display = 'flex';
                            document.getElementById('music-overlay').querySelector('p').textContent = 
                                "Error al cargar la música. Haz clic para reintentar.";
                        });
                    }
                } catch (e) {
                    console.error("Error inicializando música:", e);
                    // Mostrar overlay de error
                    document.getElementById('music-overlay').style.display = 'flex';
                    document.getElementById('music-overlay').querySelector('p').textContent = 
                        "Error al inicializar el audio. Haz clic para reintentar.";
                }
            }
            
            activarMusica() {
                this.musica_activada = true;
                document.getElementById('btn-musica-off').style.display = 'none';
                document.getElementById('btn-musica-on').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.play().catch(e => {
                        console.error("Error al reanudar música:", e);
                    });
                }
            }
            
            desactivarMusica() {
                this.musica_activada = false;
                document.getElementById('btn-musica-on').style.display = 'none';
                document.getElementById('btn-musica-off').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.pause();
                }
            }
            
            calcularFactoresEscala() {
                const baseWidth = 1920;
                const baseHeight = 1080;
                
                this.width_scale = window.innerWidth / baseWidth;
                this.height_scale = window.innerHeight / baseHeight;
                this.scale_factor = Math.min(this.width_scale, this.height_scale);
            }
            
            aplicarEscaladoCompleto() {
                // Ajustar tamaño de botones
                const btnSize = 80 * this.scale_factor;
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.style.width = `${btnSize}px`;
                    btn.style.height = `${btnSize}px`;
                });
                
                // Ajustar tamaño de etiquetas
                const labelFontSize = 50 * this.scale_factor;
                document.querySelectorAll('.config-label').forEach(label => {
                    label.style.fontSize = `${labelFontSize}px`;
                    label.style.minWidth = `${btnSize}px`;
                });
                
                // Ajustar log de eventos
                const eventLog = document.getElementById('event-log');
                if (eventLog) {
                    eventLog.style.width = `${1000 * this.scale_factor}px`;
                    eventLog.style.height = `${300 * this.scale_factor}px`;
                    eventLog.style.fontSize = `${14 * this.scale_factor}px`;
                    // Centrar el log
                    eventLog.style.left = '50%';
                    eventLog.style.transform = 'translate(-50%, -50%)';
                }
                
                // Ajustar log de recompensas
                const rewardLog = document.getElementById('reward-log');
                if (rewardLog) {
                    rewardLog.style.width = `${450 * this.width_scale}px`;
                    rewardLog.style.height = `${250 * this.height_scale}px`;
                    rewardLog.style.fontSize = `${10 * this.scale_factor}px`;
                    // Centrar el log
                    rewardLog.style.left = '50%';
                    rewardLog.style.transform = 'translateX(-50%)';
                }
                
                // Reposicionar elementos
                this.reposicionarElementos();
            }
            
            reposicionarElementos() {
                // Panel de nivel
                const nivelPanel = document.getElementById('nivel-panel');
                if (nivelPanel) {
                    nivelPanel.style.left = `${window.innerWidth * 0.106}px`;
                    nivelPanel.style.top = `${window.innerHeight * 0.43}px`;
                }
                
                // Panel de apuesta
                const apuestaPanel = document.getElementById('apuesta-panel');
                if (apuestaPanel) {
                    apuestaPanel.style.right = `${window.innerWidth * 0.154}px`;
                    apuestaPanel.style.top = `${window.innerHeight * 0.43}px`;
                }
                
                // Log de eventos (ya está centrado por CSS)
                const eventLog = document.getElementById('event-log');
                if (eventLog) {
                    eventLog.style.top = `${window.innerHeight * 0.41}px`;
                }
                
                // Log de recompensas (ya está centrado por CSS)
                const rewardLog = document.getElementById('reward-log');
                if (rewardLog && eventLog) {
                    rewardLog.style.top = `${window.innerHeight * 0.73}px`;
                }
            }
            
            configurarEventos() {
                // Botones de nivel
                document.getElementById('btn-nivel-up').addEventListener('click', () => this.incrementarNivel());
                document.getElementById('btn-nivel-down').addEventListener('click', () => this.decrementarNivel());
                
                // Botones de apuesta
                document.getElementById('btn-apuesta-up').addEventListener('click', () => this.incrementarApuesta());
                document.getElementById('btn-apuesta-down').addEventListener('click', () => this.decrementarApuesta());
                
                // Botones principales
                document.getElementById('btn-iniciar').addEventListener('click', () => this.iniciarArena());
                document.getElementById('btn-ronda').addEventListener('click', () => this.siguienteRonda());
                document.getElementById('btn-heroico').addEventListener('click', () => this.evaluarAccion('heroica'));
                document.getElementById('btn-deshonroso').addEventListener('click', () => this.evaluarAccion('deshonrosa'));
                document.getElementById('btn-musica-on').addEventListener('click', () => this.desactivarMusica());
                document.getElementById('btn-musica-off').addEventListener('click', () => this.activarMusica());
                document.getElementById('btn-reiniciar').addEventListener('click', () => this.reiniciarArena());
                document.getElementById('btn-reglas').addEventListener('click', () => this.mostrarReglas());
            }
            
            incrementarNivel() {
                if (this.nivel_valor < 10) {
                    this.nivel_valor++;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                }
            }
            
            decrementarNivel() {
                if (this.nivel_valor > 1) {
                    this.nivel_valor--;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                }
            }
            
            incrementarApuesta() {
                if (this.apuesta_valor < 500) {
                    this.apuesta_valor = Math.min(500, this.apuesta_valor + 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            decrementarApuesta() {
                if (this.apuesta_valor > 0) {
                    this.apuesta_valor = Math.max(0, this.apuesta_valor - 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            iniciarEfectoParpadeo() {
                this.blink_interval = setInterval(() => {
                    this.blink_state = !this.blink_state;
                }, 500);
            }
            
            mostrarMensajeLog(mensaje, tag = 'center') {
                const eventLog = document.getElementById('event-log');
                if (!eventLog) return;
                
                const line = document.createElement('div');
                line.className = `log-${tag}`;
                line.textContent = mensaje;
                
                if (tag === 'critical') {
                    const attentionLine = document.createElement('div');
                    attentionLine.className = 'log-blink';
                    attentionLine.textContent = '¡'.repeat(10) + ' ATENCIÓN ' + '¡'.repeat(10);
                    eventLog.appendChild(attentionLine);
                    
                    eventLog.appendChild(line);
                    
                    const bottomLine = document.createElement('div');
                    bottomLine.className = 'log-blink';
                    bottomLine.textContent = '¡'.repeat(30);
                    eventLog.appendChild(bottomLine);
                } else {
                    eventLog.appendChild(line);
                }
                
                eventLog.scrollTop = eventLog.scrollHeight;
            }
            
            mostrarMensajeBienvenida() {
                this.mostrarMensajeLog('\n=== BIENVENIDO A LA ARENA DE LORAINIA ===', 'titulo');
                this.mostrarMensajeLog('¡Atención, ciudadanos de Lorainia! Aventureros de las Tierras Antiguas,\n' +
                                       'estáis bajo la atenta mirada de los dioses y del gran rey Logan III. Aquí hallaréis muerte o gloria.', 'publico');
                this.mostrarMensajeLog('Reglamento escrito por José Manuel Arena v1.3 y aplicacion por Omar Nieto (DETION)', 'enemigo');
            }
            
            inicializarEstados() {
                const limites = this.estados_config.limites;
                this.moral_grupo = limites.moral_max;
                this.cordura = limites.cordura_max;
                
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
            }
            
            reiniciarArena() {
                const eventLog = document.getElementById('event-log');
                if (eventLog) eventLog.innerHTML = '';
                
                this.inicializarEstados();
                
                const rewardLog = document.getElementById('reward-log');
                if (rewardLog) {
                    rewardLog.innerHTML = '';
                    rewardLog.style.display = 'none';
                }
                
                document.getElementById('btn-iniciar').disabled = false;
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                
                this.musica_activada = true;
                document.getElementById('btn-musica-off').style.display = 'none';
                document.getElementById('btn-musica-on').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.play().catch(e => {
                        console.error("Error al reanudar música:", e);
                    });
                }
                
                this.mostrarMensajeBienvenida();
                this.mostrarMensajeLog('\n=== ARENA REINICIADA ===', 'titulo');
            }
            
            async iniciarArena() {
                const nivel = this.nivel_valor;
                const apuesta = this.apuesta_valor;
                
                try {
                    if (apuesta < 0 || apuesta > 500) {
                        throw new Error("La apuesta debe estar entre 0 y 500");
                    }
                    
                    // Cargar encuentros según el nivel
                    await this.cargarEncuentros();
                    
                    // Determinar configuración según nivel
                    let config_seleccionada = null;
                    if (nivel >= 1 && nivel <= 2) {
                        this.heroes_nivel = "1_2";
                        config_seleccionada = "nivel_1_2";
                    } else if (nivel >= 3 && nivel <= 4) {
                        this.heroes_nivel = "3_4";
                        config_seleccionada = "nivel_3_4";
                    } else if (nivel >= 5 && nivel <= 6) {
                        this.heroes_nivel = "5_6";
                        config_seleccionada = "nivel_5_6";
                    } else if (nivel >= 7 && nivel <= 10) {
                        this.heroes_nivel = "7_8";
                        config_seleccionada = "nivel_7_8";
                    } else {
                        throw new Error("Nivel debe estar entre 1 y 10");
                    }
                    
                    this.apuesta_monedas = apuesta;
                    this.apuesta_activa = apuesta > 0;
                    
                    // Obtener el multiplicador de recompensas
                    const recompensa = this.recompensas[config_seleccionada];
                    const multiplicador = recompensa.multiplicador_monedas;
                    
                    // Mostrar mensaje del speaker sobre la apuesta
                    this.mostrarMensajeLog('\n«¡Atención, nobles espectadores!»', 'speaker');
                    
                    if (this.apuesta_activa) {
                        const ganancia_potencial = Math.floor(this.apuesta_monedas * multiplicador);
                        this.mostrarMensajeLog(`«¡Nuestros valientes héroes han apostado ${this.apuesta_monedas} monedas!»`, 'speaker');
                        this.mostrarMensajeLog(`«Si logran la victoria, obtendrán ${ganancia_potencial} monedas adicionales!»`, 'speaker');
                    } else {
                        this.mostrarMensajeLog('«¡Jajaja nuestros héroes no han apostado o eso quiere decir que solo les queda la vida!»', 'speaker');
                    }
                    
                    // Iniciar la arena
                    this.mostrarMensajeLog('\n=== ARENA INICIADA ===', 'titulo');
                    this.mostrarMensajeLog(`Nivel: ${nivel} | Apuesta: ${apuesta} monedas`, 'center');
                    
                    // Habilitar botones
                    document.getElementById('btn-iniciar').disabled = true;
                    document.getElementById('btn-ronda').disabled = false;
                    
                    // Iniciar primera ronda
                    this.siguienteRonda();
                    
                } catch (e) {
                    this.mostrarMensajeLog(`Error al iniciar arena: ${e.message}`, 'critical');
                }
            }
            
            siguienteRonda() {
                try {
                    // Verificar si hay encuentros disponibles
                    if (!this.encuentros || Object.keys(this.encuentros).length === 0) {
                        throw new Error("No se han cargado encuentros para este nivel");
                    }
                    
                    // Obtener encuentros para la ronda actual
                    const rondaKey = `ronda_${this.ronda_actual}`;
                    const encuentrosRonda = this.encuentros[rondaKey];
                    
                    if (!encuentrosRonda || encuentrosRonda.length === 0) {
                        // Si no hay más rondas, finalizar
                        this.finalizarArena();
                        return;
                    }
                    
                    // Seleccionar un encuentro aleatorio
                    const randomValue = Math.floor(Math.random() * 100) + 1;
                    let encuentroSeleccionado = null;
                    
                    for (const encuentro of encuentrosRonda) {
                        const [min, max] = encuentro.rango.split('-').map(Number);
                        if (randomValue >= min && randomValue <= max) {
                            encuentroSeleccionado = encuentro;
                            break;
                        }
                    }
                    
                    if (!encuentroSeleccionado) {
                        throw new Error("No se pudo seleccionar un encuentro");
                    }
                    
                    this.encuentro_actual = encuentroSeleccionado;
                    
                    // Mostrar información de la ronda
                    this.mostrarMensajeLog('\n=== RONDA ' + this.ronda_actual + ' ===', 'ronda');
                    this.mostrarMensajeLog('Enfrentando: ' + this.encuentro_actual.enemigos, 'enemigo');
                    
                    // Habilitar botones de acción
                    document.getElementById('btn-heroico').disabled = false;
                    document.getElementById('btn-deshonroso').disabled = false;
                    document.getElementById('btn-ronda').disabled = true;
                    
                } catch (e) {
                    this.mostrarMensajeLog(`Error en la ronda: ${e.message}`, 'critical');
                }
            }
            
            async evaluarAccion(tipo) {
                try {
                    // Verificar que tenemos la configuración de comportamiento
                    if (!this.comportamiento) {
                        throw new Error("No se ha cargado la configuración de comportamiento");
                    }
                    
                    // Obtener la reacción del público según el tipo de acción
                    const reacciones = tipo === 'heroica' 
                        ? this.comportamiento.reacciones_publico.apoyo 
                        : this.comportamiento.reacciones_publico.desprecio;
                    
                    // Seleccionar una reacción aleatoria
                    const reaccionAleatoria = reacciones[Math.floor(Math.random() * reacciones.length)];
                    
                    // Mostrar la reacción del público
                    this.mostrarMensajeLog('\n' + reaccionAleatoria.efecto, 'publico');
                    
                    // Aplicar efectos según el tipo de acción
                    if (tipo === 'heroica') {
                        this.acciones_heroicas++;
                        this.moral_grupo = Math.min(this.estados_config.limites.moral_max, this.moral_grupo + 1);
                        this.mostrarMensajeLog('Acción Heroica realizada (+1 Moral)', 'heroico');
                    } else {
                        this.acciones_deshonrosas++;
                        this.cordura = Math.max(0, this.cordura - 1);
                        this.mostrarMensajeLog('Acción Deshonrosa realizada (-1 Cordura)', 'deshonroso');
                    }
                    
                    // Verificar si se activa bonificación crítica
                    if (this.acciones_heroicas >= 3) {
                        this.bonif_critico = true;
                        this.mostrarMensajeLog('¡BONIFICACIÓN CRÍTICA ACTIVADA! (+2 Moral)', 'critical');
                        this.moral_grupo = Math.min(this.estados_config.limites.moral_max, this.moral_grupo + 2);
                        this.acciones_heroicas = 0; // Resetear contador
                    }
                    
                    // Mostrar estado actual
                    this.mostrarMensajeLog(`Moral: ${this.moral_grupo}/${this.estados_config.limites.moral_max} | Cordura: ${this.cordura}/${this.estados_config.limites.cordura_max}`, 'center');
                    
                    // Deshabilitar botones de acción y habilitar botón de ronda
                    document.getElementById('btn-heroico').disabled = true;
                    document.getElementById('btn-deshonroso').disabled = true;
                    document.getElementById('btn-ronda').disabled = false;
                    
                    // Avanzar a la siguiente ronda
                    this.ronda_actual++;
                    
                } catch (e) {
                    this.mostrarMensajeLog(`Error al evaluar acción: ${e.message}`, 'critical');
                }
            }
            
            finalizarArena() {
                this.mostrarMensajeLog('\n=== LA ARENA HA CONCLUIDO ===', 'titulo');
                
                // Determinar resultado
                let resultado = '';
                if (this.moral_grupo >= 7 && this.cordura >= 7) {
                    resultado = 'VICTORIA ÉPICA';
                } else if (this.moral_grupo >= 5 && this.cordura >= 5) {
                    resultado = 'VICTORIA';
                } else if (this.moral_grupo >= 3 && this.cordura >= 3) {
                    resultado = 'VICTORIA PIRRICA';
                } else {
                    resultado = 'DERROTA';
                }
                
                this.mostrarMensajeLog('Resultado: ' + resultado, 'center');
                
                // Calcular recompensas
                this.calcularRecompensas(resultado);
                
                // Deshabilitar botones
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                document.getElementById('btn-iniciar').disabled = false;
            }
            
            calcularRecompensas(resultado) {
                try {
                    // Obtener configuración de recompensas según nivel
                    const nivelKey = `nivel_${this.heroes_nivel}`;
                    const recompensaConfig = this.recompensas[nivelKey];
                    
                    if (!recompensaConfig) {
                        throw new Error("No se encontró configuración de recompensas para el nivel " + this.heroes_nivel);
                    }
                    
                    // Calcular bonificaciones según resultado
                    let multiplicadorResultado = 1.0;
                    let expBonus = 0;
                    
                    switch (resultado) {
                        case 'VICTORIA ÉPICA':
                            multiplicadorResultado = 1.5;
                            expBonus = 50;
                            break;
                        case 'VICTORIA':
                            multiplicadorResultado = 1.2;
                            expBonus = 25;
                            break;
                        case 'VICTORIA PIRRICA':
                            multiplicadorResultado = 0.8;
                            expBonus = 10;
                            break;
                        case 'DERROTA':
                            multiplicadorResultado = 0.5;
                            expBonus = 0;
                            break;
                    }
                    
                    // Calcular recompensas base
                    const monedasBase = recompensaConfig.monedas;
                    const experienciaBase = recompensaConfig.experiencia;
                    
                    // Aplicar multiplicadores
                    const monedasFinal = Math.floor(monedasBase * multiplicadorResultado);
                    const experienciaFinal = Math.floor((experienciaBase + expBonus) * multiplicadorResultado);
                    
                    // Calcular ganancia de apuesta si aplica
                    let gananciaApuesta = 0;
                    if (this.apuesta_activa && resultado !== 'DERROTA') {
                        gananciaApuesta = Math.floor(this.apuesta_monedas * recompensaConfig.multiplicador_monedas);
                    }
                    
                    // Mostrar recompensas en el log principal
                    this.mostrarMensajeLog('\n--- RECOMPENSAS ---', 'titulo');
                    this.mostrarMensajeLog(`Monedas: ${monedasFinal}`, 'recompensa');
                    this.mostrarMensajeLog(`Experiencia: ${experienciaFinal}`, 'recompensa');
                    
                    if (gananciaApuesta > 0) {
                        this.mostrarMensajeLog(`Ganancia por apuesta: +${gananciaApuesta} monedas`, 'apuesta');
                    }
                    
                    // Mostrar tesoros si es victoria
                    if (resultado !== 'DERROTA' && recompensaConfig.tesoros && recompensaConfig.tesoros.length > 0) {
                        this.mostrarMensajeLog('Tesoros obtenidos:', 'recompensa');
                        recompensaConfig.tesoros.forEach(tesoro => {
                            this.mostrarMensajeLog(`- ${tesoro}`, 'lista');
                        });
                    }
                    
                    // Mostrar log de recompensas detallado
                    this.mostrarRecompensasDetalladas({
                        resultado,
                        monedasBase,
                        monedasFinal,
                        experienciaBase,
                        experienciaFinal,
                        expBonus,
                        multiplicadorResultado,
                        gananciaApuesta,
                        tesoros: recompensaConfig.tesoros
                    });
                    
                } catch (e) {
                    this.mostrarMensajeLog(`Error calculando recompensas: ${e.message}`, 'critical');
                }
            }
            
            mostrarRecompensasDetalladas(detalles) {
                const rewardLog = document.getElementById('reward-log');
                if (!rewardLog) return;
                
                // Limpiar y mostrar el log
                rewardLog.innerHTML = '';
                rewardLog.style.display = 'block';
                
                // Añadir título
                const titulo = document.createElement('div');
                titulo.className = 'log-titulo';
                titulo.textContent = 'DETALLE DE RECOMPENSAS';
                rewardLog.appendChild(titulo);
                
                // Añadir resultado
                const resultado = document.createElement('div');
                resultado.className = 'log-center';
                resultado.textContent = `Resultado: ${detalles.resultado}`;
                rewardLog.appendChild(resultado);
                
                // Añadir línea separadora
                rewardLog.appendChild(document.createElement('hr'));
                
                // Añadir monedas
                const monedas = document.createElement('div');
                monedas.className = 'log-recompensa';
                monedas.innerHTML = `<strong>Monedas:</strong> ${detalles.monedasBase} × ${detalles.multiplicadorResultado.toFixed(1)} = ${detalles.monedasFinal}`;
                rewardLog.appendChild(monedas);
                
                // Añadir experiencia
                const exp = document.createElement('div');
                exp.className = 'log-recompensa';
                exp.innerHTML = `<strong>Experiencia:</strong> ${detalles.experienciaBase} + ${detalles.expBonus} × ${detalles.multiplicadorResultado.toFixed(1)} = ${detalles.experienciaFinal}`;
                rewardLog.appendChild(exp);
                
                // Añadir ganancia de apuesta si aplica
                if (detalles.gananciaApuesta > 0) {
                    const apuesta = document.createElement('div');
                    apuesta.className = 'log-apuesta';
                    apuesta.innerHTML = `<strong>Apuesta:</strong> ${this.apuesta_monedas} × ${this.recompensas[`nivel_${this.heroes_nivel}`].multiplicador_monedas} = +${detalles.gananciaApuesta}`;
                    rewardLog.appendChild(apuesta);
                }
                
                // Añadir tesoros si hay
                if (detalles.tesoros && detalles.tesoros.length > 0 && detalles.resultado !== 'DERROTA') {
                    rewardLog.appendChild(document.createElement('hr'));
                    
                    const tesorosTitulo = document.createElement('div');
                    tesorosTitulo.className = 'log-recompensa';
                    tesorosTitulo.innerHTML = '<strong>Tesoros:</strong>';
                    rewardLog.appendChild(tesorosTitulo);
                    
                    detalles.tesoros.forEach(tesoro => {
                        const item = document.createElement('div');
                        item.className = 'log-lista';
                        item.textContent = `• ${tesoro}`;
                        rewardLog.appendChild(item);
                    });
                }
            }
            
            mostrarReglas() {
                this.mostrarMensajeLog('\n=== REGLAS DE LA ARENA ===', 'titulo');
                this.mostrarMensajeLog('1. Selecciona un nivel entre 1 y 10', 'lista');
                this.mostrarMensajeLog('2. Opcionalmente, realiza una apuesta (0-500 monedas)', 'lista');
                this.mostrarMensajeLog('3. Inicia la arena y enfrenta cada ronda', 'lista');
                this.mostrarMensajeLog('4. En cada ronda, elige una acción Heroica o Deshonrosa', 'lista');
                this.mostrarMensajeLog('5. Las acciones afectan tu Moral y Cordura', 'lista');
                this.mostrarMensajeLog('6. 3 acciones heroicas activan una bonificación crítica', 'lista');
                this.mostrarMensajeLog('7. Al finalizar, recibes recompensas según tu resultado', 'lista');
                this.mostrarMensajeLog('8. ¡La apuesta se multiplica si ganas!', 'lista');
            }
        }
        
        // Inicializar la aplicación cuando se carga la página
        window.addEventListener('DOMContentLoaded', () => {
            window.arenaApp = new ArenaApp();
        });
    </script>
</body>
</html>