<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DETION ARENA: LEAGUE OF DUNGEONEERS</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #2D2D2D;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        /* Contenedor principal */
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Contenedor para la imagen de título encima del log */
        #titulo-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, calc(-50% - 55%)); /* Posicionado encima del log de forma proporcional */
            width: 72vw; /* Ancho proporcional al viewport */
            max-width: 3000px;
            height: 28.8vw; /* Altura proporcional (manteniendo relación de aspecto 5:2) */
            max-height: 600px;
            z-index: 7;
            background-image: url('assets/imagenes/titulo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Ajustar el contenedor del log para que use pergamino como fondo */
        #log-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80vw; /* Ancho proporcional */
            max-width: 1800px;
            height: 45vw; /* Altura proporcional (manteniendo relación de aspecto 5:3) */
            max-height: 1000px;
            z-index: 3;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: url('assets/imagenes/pergamino.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Contenedores de nivel y apuesta con posicionamiento simétrico */
        #nivel-container, #apuesta-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 3;
            width: 13vw; /* Tamaño proporcional */
            max-width: 250px;
            height: 13vw;
            max-height: 250px;
            top: 38%; /* Posición vertical centrada */
        }

        /* NUEVO: Estilo para el campo de nivel de arena */
        #nivel-arena-container {
            position: absolute;
            left: 10.6%;
            top: 62%;
            transform: translateY(-40%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 4;
            width: auto; /* Cambiado de 13vw a auto */
            min-width: 120px; /* Ancho mínimo para mantener consistencia */
            max-width: 250px;
            white-space: nowrap; /* Evitar que el texto se divida en múltiples líneas */
        }

        #nivel-arena-label {
            background-color: rgba(139, 69, 19, 0.8);
            color: gold;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2vw;
            max-font-size: 16px;
            border: 2px solid #8B4513;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
            white-space: nowrap; /* Asegurar que el texto no se divida */
        }

        #nivel-container {
            left: 10.6%; /* Posición simétrica izquierda */
            background-image: url('assets/imagenes/heroes.png'), url('https://placehold.co/250x250/555555/FFFFFF/png?text=HEROES');
            top: 38%; /* Ajustado para hacer espacio para el nivel de arena */
        }

        #apuesta-container {
            right: 10.6%; /* Posición simétrica derecha (equivalente a left: 89.4%) */
            background-image: url('assets/imagenes/recompensas.png'), url('https://placehold.co/250x250/555555/FFFFFF/png?text=RECOMPENSAS');
        }

        /* Ajustar el event-log dentro del contenedor */
        #event-log {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -58%);
            background-color: transparent;
            margin: 5px 0;
            color: black;
            border: none;
            text-align: center;
            overflow: auto;
            padding: 2.5%; /* Padding proporcional */
            z-index: 6;
            width: 55%;
            height: 35%;
            font-size: 1.5vw; /* Tamaño de fuente responsive */
            max-font-size: 14px;
         }
        
        /* Paneles de configuración */
        #nivel-panel, #apuesta-panel {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            z-index: 4;
            margin-top: 20px;
        }
        



        /* Fondo */
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }
        
        /* Panel de configuración */
        .config-panel {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .config-label {
            background-color: transparent;
            color: black;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            font-size: 2.6vw; /* Tamaño responsive */
            max-font-size: 50px;
        }
        
        /* Botones */
        .btn {
            background-color: #2D2D2D;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 4.2vw; /* Tamaño responsive */
            max-width: 80px;
            height: 4.2vw;
            max-height: 80px;
        }
        
        .btn:hover {
            background-color: #3D3D3D;
        }
        
        .btn:disabled {
            background-color: #555555;
            cursor: not-allowed;
        }
        
        /* Botones principales */
        #main-buttons {
            position: absolute;
            display: flex;
            gap: 4vw; /* Espaciado responsive */
            width: 70%;
            justify-content: center;
            z-index: 10;
            bottom: 3%; /* Posición desde abajo responsive */
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Estilos de texto para diferentes tipos de mensajes */
        .log-titulo {
            color: #000000;
            font-weight: bold;
        }
        
        .log-recompensa {
            color: #006400;
        }
        
        .log-enemigo {
            color: #8B0000;
            font-weight: bold;
        }
        
        .log-lista {
            color: #000000;
        }
        
        .log-ronda {
            color: #000000;
            font-weight: bold;
        }
        
        .log-heroico {
            color: #006400;
            font-weight: bold;
        }
        
        .log-deshonroso {
            color: #8B0000;
            font-weight: bold;
        }
        
        .log-publico {
            color: #000000;
            font-style: italic;
        }
        
        .log-efecto {
            color: #000000;
        }
        
        .log-critical {
            color: #8B0000;
            font-weight: bold;
            animation: blink 0.5s infinite;
        }
        
        .log-apuesta {
            color: #006400;
            font-weight: bold;
        }
        
        .log-center {
            color: #000000;
        }
        
        .log-speaker {
            color: #8B4513;
            font-weight: bold;
            font-style: italic;
        }
        
        .log-blink {
            animation: blink 0.5s infinite;
        }
        
        @keyframes blink {
            0% { color: #8b0000; }
            50% { color: #FFCCCB; }
            100% { color: #8b0000; }
        }
        
        /* NUEVO: Cuadrícula de posicionamiento de enemigos */
        #grid-container {
            position: fixed;
            cursor: move;
            user-select: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70vmin;
            height: 52.5vmin;
            background-image: url('assets/imagenes/arena_grid.png');
            background-size: cover;
            background-position: center;
            border: 3px solid #8B4513;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            z-index: 100; /* Mayor z-index para estar por encima de todo */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        /* Contenedor interno para el contenido de la cuadrícula */
        #grid-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 2px;
            padding: 1vmin;
        }
        
        #grid-container.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .grid-cell {
            background-color: rgba(139, 69, 19, 0.3);
            border: 1px solid rgba(139, 69, 19, 0.5);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .enemy-token {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8vmin;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
            animation: appear 0.5s ease-out;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .enemy-token:hover {
            transform: scale(1.1);
        }
        
        @keyframes appear {
            from {
                opacity: 0;
                transform: scale(0);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Ajustar el botón de cierre para que esté por encima */
        #close-grid {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #8B0000;
            color: white;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 101; /* Mayor z-index para estar por encima */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
        }

        #close-grid:hover {
            background-color: #FF0000;
        }
        
        /* Media queries para ajustes específicos */
        @media (max-width: 1200px) {
            #event-log {
                font-size: 3vw;
            }
            
            .config-label {
                font-size: 3vw;
            }
        }
        
        @media (max-width: 768px) {
            #titulo-container {
                width: 95vw;
                height: 45,6vw;
                transform: translate(-50%, calc(-50% - 70%));
            }
            
            #log-container {
                width: 95vw;
                height: 28.5vw;
            }
            
            #nivel-container, #apuesta-container {
                width: 20vw;
                height: 20vw;
            }
            
            #event-log {
                font-size: 2.2vw;
                padding: 5%;
            }
            
            .config-label {
                font-size: 4vw;
            }
            
            .btn {
                width: 6vw;
                height: 6vw;
            }
            
            #main-buttons {
                gap: 3vw;
                bottom: 2%;
            }
            
            #grid-container {
                width: 85vmin;
                height: 63.75vmin;
                position: fixed; /* Asegurar que sea fixed en móviles también */
            }

            #nivel-arena-container {
                width: auto; /* Cambiado a auto */
                min-width: 100px;
                top: 65%;
            }
            
            #nivel-arena-label {
                font-size: 2vw;
                white-space: nowrap; /* Mantener en una línea */
            }
            
            #nivel-container {
                top: 35%;
            }

        }
        
        @media (max-width: 480px) {
            #titulo-container {
                width: 90vw;
                height: 43.2vw;
                transform: translate(-50%, calc(-50% - 70%));
            }
            
            #nivel-container, #apuesta-container {
                width: 25vw;
                height: 25vw;
                top: 45%;
            }
            
            #nivel-container {
                left: 5%;
            }
            
            #apuesta-container {
                right: 5%;
            }
            
            #event-log {
                font-size: 2.5vw;
            }
            
            .config-label {
                font-size: 5vw;
            }
            
            .btn {
                width: 8vw;
                height: 8vw;
            }
            
            #main-buttons {
                gap: 2vw;
                bottom: 1%;
            }
            
            #grid-container {
                width: 95vmin;
                height: 71.25vmin;
                position: fixed; /* Asegurar que sea fixed en móviles también */
            }

            #nivel-arena-container {
                width: auto; /* Cambiado a auto */
                min-width: 80px;
                top: 68%
            }
            
            #nivel-arena-label {
                font-size: 2.5vw;
                white-space: nowrap; /* Mantener en una línea */
            }
            
            #nivel-container {
                top: 32%;
            }
        }
    </style>
</head>
<body>
    
    <!-- Fondo -->
    <div id="background"></div>

    <!-- Contenedor del log con fondo de pergamino -->
    <div id="log-container">
        <div id="event-log"></div>
    </div>

    <!-- NUEVO: Cuadrícula de posicionamiento de enemigos -->
    <div id="grid-container">
        <div id="close-grid">X</div>
        <div id="grid-content">
            <!-- Las celdas se generarán dinámicamente con JavaScript -->
        </div>
    </div>

    <!-- Contenedor para la imagen de título -->
    <div id="titulo-container"></div>
        
    <!-- Panel de nivel -->
    <div id="nivel-container">
        <div id="nivel-panel" class="config-panel">
            <button id="btn-nivel-down" class="btn"></button>
            <div id="nivel-label" class="config-label">1</div>
            <button id="btn-nivel-up" class="btn"></button>
        </div>
    </div>

    <!-- NUEVO: Contenedor para el nivel de arena -->
    <div id="nivel-arena-container">
        <div id="nivel-arena-label">Nivel arena COBRE</div>
    </div>

    <!-- Panel de apuesta -->
    <div id="apuesta-container">
        <div id="apuesta-panel" class="config-panel">
            <button id="btn-apuesta-down" class="btn"></button>
            <div id="apuesta-label" class="config-label">0</div>
            <button id="btn-apuesta-up" class="btn"></button>
        </div>
    </div>
        
    <!-- Botones principales -->
    <div id="main-buttons">
        <button id="btn-iniciar" class="btn"></button>
        <button id="btn-ronda" class="btn" disabled></button>
        <button id="btn-heroico" class="btn" disabled></button>
        <button id="btn-deshonroso" class="btn" disabled></button>
        <button id="btn-musica-on" class="btn"></button>
        <button id="btn-musica-off" class="btn" style="display:none;"></button>
        <button id="btn-reiniciar" class="btn"></button>
        <button id="btn-reglas" class="btn"></button>
    </div>

    <script>
        // Clase principal de la aplicación
        class ArenaApp {
            constructor() {
                this._setupAttributes();
                this.init();  
            }
            
            _setupAttributes() {
                // Rutas base
                this.BASE_DIR = window.location.href.replace(/\/[^\/]*$/, '');
                this.IMAGES_DIR = `${this.BASE_DIR}/assets/imagenes`;
                this.AUDIO_DIR = `${this.BASE_DIR}/assets/audio`;
                this.DATA_DIR = `${this.BASE_DIR}/assets/data`;
                
                // Configuraciones
                this.ui_config = null;
                this.estados_config = null;
                this.descansos = null;
                this.recompensas = null;
                this.comportamiento = null;
                
                // Estado del juego
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.moral_grupo = 0;
                this.cordura = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
                this.exp_total_acumulada = 0;
                
                // Control de música
                this.musica_activada = true;
                this.audioContext = null;
                this.audioElement = null;
                this.audioGain = null;
                
                // Valores de configuración
                this.nivel_valor = 1;
                this.apuesta_valor = 0;
                
                // Efectos
                this.blink_state = false;
                this.blink_interval = null;
                
                // NUEVO: Para la cuadrícula
                this.gridVisible = false;
                this.enemyTokens = [];
                this.enemigosProcesados = [];
            }
            
            async init() {
                try {
                    await this.cargarConfiguraciones();
                    this.inicializarUI();
                    this.inicializarEstados();
                    this.inicializarMusica();
                    this.mostrarMensajeBienvenida();
                    this.iniciarEfectoParpadeo();
                    this.configurarEventos();
                    
                    // Configurar evento de redimensionamiento
                    window.addEventListener('resize', () => {
                        this.ajustarUIResponsive();
                    });
                    
                    // Ajustar UI inicialmente
                    this.ajustarUIResponsive();
                    
                    // NUEVO: Inicializar la cuadrícula
                    this.inicializarGrid();

                    // NUEVO: Actualizar nivel de arena inicial
                    this.actualizarNivelArena();
                    
                } catch (error) {
                    console.error("Error inicializando la aplicación:", error);
                    this.mostrarMensajeLog(`Error al inicializar: ${error.message}`, 'enemigo');
                }
            }
            
            // NUEVO: Inicializar la cuadrícula - CORREGIDO
            inicializarGrid() {
                const gridContainer = document.getElementById('grid-container');
                const closeButton = document.getElementById('close-grid');
                
                // Variables para el arrastre
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                
                // Crear las 48 celdas (8x6) dentro del grid-content
                const gridContent = document.getElementById('grid-content');
                for (let i = 0; i < 48; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = i;
                    gridContent.appendChild(cell);
                }
                
                // Evento para cerrar la cuadrícula - FIXED
                closeButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evitar que el evento se propague al contenedor
                    this.ocultarGrid();
                });
                
                // Eventos para hacer la cuadrícula arrastrable
                gridContainer.addEventListener('mousedown', (e) => {
                    // Solo iniciar arrastre si se hace clic en áreas no interactivas
                    if (e.target === gridContainer || e.target === gridContent) {
                        this.isDragging = true;
                        this.dragOffset = {
                            x: e.clientX - gridContainer.offsetLeft,
                            y: e.clientY - gridContainer.offsetTop
                        };
                        gridContainer.style.cursor = 'grabbing';
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (this.isDragging) {
                        gridContainer.style.left = (e.clientX - this.dragOffset.x) + 'px';
                        gridContainer.style.top = (e.clientY - this.dragOffset.y) + 'px';
                        gridContainer.style.transform = 'none'; // Eliminar transform al arrastrar
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    gridContainer.style.cursor = 'move';
                });
                
                // También soporte para dispositivos táctiles
                gridContainer.addEventListener('touchstart', (e) => {
                    if (e.target === gridContainer || e.target === gridContent) {
                        this.isDragging = true;
                        const touch = e.touches[0];
                        this.dragOffset = {
                            x: touch.clientX - gridContainer.offsetLeft,
                            y: touch.clientY - gridContainer.offsetTop
                        };
                        e.preventDefault(); // Prevenir scroll no deseado
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (this.isDragging) {
                        const touch = e.touches[0];
                        gridContainer.style.left = (touch.clientX - this.dragOffset.x) + 'px';
                        gridContainer.style.top = (touch.clientY - this.dragOffset.y) + 'px';
                        gridContainer.style.transform = 'none'; // Eliminar transform al arrastrar
                        e.preventDefault(); // Prevenir scroll no deseado
                    }
                });
                
                document.addEventListener('touchend', () => {
                    this.isDragging = false;
                });
            }

            // NUEVO: Mostrar la cuadrícula con enemigos - CORREGIDO
            mostrarGridConEnemigos(enemigos) {
                this.limpiarGrid();
                this.enemigosProcesados = enemigos;
                
                // Posicionar la cuadrícula en el centro al mostrarla
                const gridContainer = document.getElementById('grid-container');
                gridContainer.style.left = '50%';
                gridContainer.style.top = '50%';
                gridContainer.style.transform = 'translate(-50%, -50%)';
                
                // Colocar enemigos en posiciones aleatorias
                const posicionesDisponibles = Array.from({length: 48}, (_, i) => i);
                
                enemigos.forEach(enemigo => {
                    if (posicionesDisponibles.length === 0) return;
                    
                    // Colocar cada unidad individualmente
                    for (let i = 0; i < enemigo.cantidad; i++) {
                        if (posicionesDisponibles.length === 0) break;
                        
                        const posIndex = Math.floor(Math.random() * posicionesDisponibles.length);
                        const cellIndex = posicionesDisponibles.splice(posIndex, 1)[0];
                        const cell = document.querySelector(`.grid-cell[data-index="${cellIndex}"]`);
                        
                        if (cell) {
                            const token = document.createElement('div');
                            token.className = 'enemy-token';
                            
                            // Asignar color según el tipo de enemigo
                            const tipo = this.obtenerTipoEnemigo(enemigo.nombre);
                            token.style.backgroundColor = this.obtenerColorPorTipo(tipo);
                            token.textContent = this.obtenerAbreviatura(enemigo.nombre);
                            token.title = enemigo.nombre;
                            
                            cell.appendChild(token);
                            this.enemyTokens.push(token);
                        }
                    }
                });
                
                // Mostrar la cuadrícula
                document.getElementById('grid-container').classList.add('visible');
                this.gridVisible = true;
            }

            // NUEVO: Limpiar la cuadrícula - CORREGIDO
            limpiarGrid() {
                this.enemyTokens.forEach(token => token.remove());
                this.enemyTokens = [];
                
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    while (cell.firstChild) {
                        cell.removeChild(cell.firstChild);
                    }
                });
            }// NUEVO: Inicializar la cuadrícula - CORREGIDO
            inicializarGrid() {
                const gridContainer = document.getElementById('grid-container');
                const closeButton = document.getElementById('close-grid');
                
                // Variables para el arrastre
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                
                // Crear las 48 celdas (8x6) dentro del grid-content
                const gridContent = document.getElementById('grid-content');
                for (let i = 0; i < 48; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = i;
                    gridContent.appendChild(cell);
                }
                
                // Evento para cerrar la cuadrícula - FIXED
                closeButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evitar que el evento se propague al contenedor
                    this.ocultarGrid();
                });
                
                // Eventos para hacer la cuadrícula arrastrable
                gridContainer.addEventListener('mousedown', (e) => {
                    // Solo iniciar arrastre si se hace clic en áreas no interactivas
                    if (e.target === gridContainer || e.target === gridContent) {
                        this.isDragging = true;
                        this.dragOffset = {
                            x: e.clientX - gridContainer.offsetLeft,
                            y: e.clientY - gridContainer.offsetTop
                        };
                        gridContainer.style.cursor = 'grabbing';
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (this.isDragging) {
                        gridContainer.style.left = (e.clientX - this.dragOffset.x) + 'px';
                        gridContainer.style.top = (e.clientY - this.dragOffset.y) + 'px';
                        gridContainer.style.transform = 'none'; // Eliminar transform al arrastrar
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    gridContainer.style.cursor = 'move';
                });
                
                // También soporte para dispositivos táctiles
                gridContainer.addEventListener('touchstart', (e) => {
                    if (e.target === gridContainer || e.target === gridContent) {
                        this.isDragging = true;
                        const touch = e.touches[0];
                        this.dragOffset = {
                            x: touch.clientX - gridContainer.offsetLeft,
                            y: touch.clientY - gridContainer.offsetTop
                        };
                        e.preventDefault(); // Prevenir scroll no deseado
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (this.isDragging) {
                        const touch = e.touches[0];
                        gridContainer.style.left = (touch.clientX - this.dragOffset.x) + 'px';
                        gridContainer.style.top = (touch.clientY - this.dragOffset.y) + 'px';
                        gridContainer.style.transform = 'none'; // Eliminar transform al arrastrar
                        e.preventDefault(); // Prevenir scroll no deseado
                    }
                });
                
                document.addEventListener('touchend', () => {
                    this.isDragging = false;
                });
            }

            // NUEVO: Mostrar la cuadrícula con enemigos - CORREGIDO
            mostrarGridConEnemigos(enemigos) {
                this.limpiarGrid();
                this.enemigosProcesados = enemigos;
                
                // Posicionar la cuadrícula en el centro al mostrarla
                const gridContainer = document.getElementById('grid-container');
                gridContainer.style.left = '50%';
                gridContainer.style.top = '50%';
                gridContainer.style.transform = 'translate(-50%, -50%)';
                
                // Colocar enemigos en posiciones aleatorias
                const posicionesDisponibles = Array.from({length: 48}, (_, i) => i);
                
                enemigos.forEach(enemigo => {
                    if (posicionesDisponibles.length === 0) return;
                    
                    // Colocar cada unidad individualmente
                    for (let i = 0; i < enemigo.cantidad; i++) {
                        if (posicionesDisponibles.length === 0) break;
                        
                        const posIndex = Math.floor(Math.random() * posicionesDisponibles.length);
                        const cellIndex = posicionesDisponibles.splice(posIndex, 1)[0];
                        const cell = document.querySelector(`.grid-cell[data-index="${cellIndex}"]`);
                        
                        if (cell) {
                            const token = document.createElement('div');
                            token.className = 'enemy-token';
                            
                            // Asignar color según el tipo de enemigo
                            const tipo = this.obtenerTipoEnemigo(enemigo.nombre);
                            token.style.backgroundColor = this.obtenerColorPorTipo(tipo);
                            token.textContent = this.obtenerAbreviatura(enemigo.nombre);
                            token.title = enemigo.nombre;
                            
                            cell.appendChild(token);
                            this.enemyTokens.push(token);
                        }
                    }
                });
                
                // Mostrar la cuadrícula
                document.getElementById('grid-container').classList.add('visible');
                this.gridVisible = true;
            }

            // NUEVO: Limpiar la cuadrícula - CORREGIDO
            limpiarGrid() {
                this.enemyTokens.forEach(token => token.remove());
                this.enemyTokens = [];
                
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    while (cell.firstChild) {
                        cell.removeChild(cell.firstChild);
                    }
                });
            }
            
            // NUEVO: Obtener tipo de enemigo basado en su nombre
            obtenerTipoEnemigo(nombre) {
                nombre = nombre.toLowerCase();
                
                if (nombre.includes('goblin') || nombre.includes('orco') || nombre.includes('ogro')) {
                    return 'humanoide';
                } else if (nombre.includes('esqueleto') || nombre.includes('zombi') || nombre.includes('muerto')) {
                    return 'no-muerto';
                } else if (nombre.includes('dragón') || nombre.includes('wyvern') || nombre.includes('grifo')) {
                    return 'dragón';
                } else if (nombre.includes('demonio') || nombre.includes('diablo') || nombre.includes('infernal')) {
                    return 'demonio';
                } else if (nombre.includes('lobo') || nombre.includes('rata') || nombre.includes('araña')) {
                    return 'bestia';
                } else if (nombre.includes('hechicero') || nombre.includes('mago') || nombre.includes('brujo')) {
                    return 'magico';
                } else {
                    return 'otros';
                }
            }
            
            // NUEVO: Obtener color según el tipo de enemigo
            obtenerColorPorTipo(tipo) {
                const colores = {
                    'humanoide': '#8B4513',      // Marrón
                    'no-muerto': '#696969',      // Gris oscuro
                    'dragón': '#B22222',         // Rojo fuego
                    'demonio': '#4B0082',        // Índigo
                    'bestia': '#556B2F',         // Verde oscuro
                    'magico': '#9370DB',         // Púrpura medio
                    'otros': '#2F4F4F'           // Gris pizarra oscuro
                };
                
                return colores[tipo] || '#2F4F4F';
            }
            
            // NUEVO: Obtener abreviatura para el token
            obtenerAbreviatura(nombre) {
                if (nombre.length <= 3) return nombre.substring(0, 3);
                
                // Intentar obtener la primera letra de cada palabra
                const palabras = nombre.split(' ');
                if (palabras.length > 1) {
                    return palabras.map(p => p[0]).join('').toUpperCase().substring(0, 3);
                }
                
                // Si es una sola palabra, tomar las primeras tres letras
                return nombre.substring(0, 3).toUpperCase();
            }
            
            // NUEVO: Limpiar la cuadrícula
            limpiarGrid() {
                this.enemyTokens.forEach(token => token.remove());
                this.enemyTokens = [];
                
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    while (cell.firstChild) {
                        cell.removeChild(cell.firstChild);
                    }
                });
            }
            
            // NUEVO: Ocultar la cuadrícula
            ocultarGrid() {
                document.getElementById('grid-container').classList.remove('visible');
                this.gridVisible = false;
            }
            
            ajustarUIResponsive() {
                // Los estilos CSS se encargan ahora del responsive design
                // Este método se mantiene para posibles ajustes adicionales
                
                // Ajustar tamaño de fuente máximo para el log de eventos
                const eventLog = document.getElementById('event-log');
                if (window.innerWidth > 1000) {
                    eventLog.style.fontSize = '14px';
                }
            }
            
            async cargarConfiguraciones() {
                try {
                    // Rutas base
                    this.BASE_DIR = window.location.href.replace(/\/[^\/]*$/, '');
                    this.IMAGES_DIR = `${this.BASE_DIR}/assets/imagenes`;
                    this.AUDIO_DIR = `${this.BASE_DIR}/assets/audio`;
                    this.DATA_DIR = `${this.BASE_DIR}/assets/data`;
                    
                    // Cargar configuraciones desde archivos JSON
                    const configFiles = [
                        'ui_config.json',
                        'estados.json',
                        'descansos.json',
                        'recompensas.json',
                        'comportamiento.json'
                    ];
                    
                    const [uiConfig, estadosConfig, descansosConfig, recompensasConfig, comportamientoConfig] = await Promise.all(
                        configFiles.map(file => 
                            fetch(`${this.DATA_DIR}/${file}`)
                                .then(response => {
                                    if (!response.ok) throw new Error(`No se pudo cargar ${file}`);
                                    return response.json();
                                })
                                .catch(error => {
                                    console.error(`Error cargando ${file}:`, error);
                                    // Usar configuraciones por defecto si hay error
                                    return {};
                                })
                        )
                    );
                    
                    this.ui_config = uiConfig || {};
                    this.estados_config = estadosConfig || {limites: {moral_max: 100, cordura_max: 100}};
                    this.descansos = descansosConfig || {};
                    this.recompensas = recompensasConfig || {};
                    this.comportamiento = comportamientoConfig || {};
                    
                    // Debug: mostrar recompensas cargadas
                    console.log("Recompensas cargadas:", this.recompensas);
                    console.log("Niveles disponibles en recompensas:", Object.keys(this.recompensas));
                    
                    // Cargar encuentros según el nivel
                    await this.cargarEncuentros();
                    
                    // Cargar experiencia de monstruos
                    await this.cargarExperienciaMonstruos();
                    
                    // Debug: mostrar monstruos cargados
                    console.log("Monstruos cargados:", this.monstruos_exp.monstruos ? this.monstruos_exp.monstruos.length : 0);
                    if (this.monstruos_exp.monstruos && this.monstruos_exp.monstruos.length > 0) {
                        console.log("Ejemplos de monstruos:", this.monstruos_exp.monstruos.slice(0, 5).map(m => m.nombre));
                    }
                    
                } catch (e) {
                    console.error("Error cargando configuraciones:", e);
                    this.mostrarMensajeLog(`Error: ${e.message}`, 'enemigo');
                    
                    // Usar configuraciones por defecto
                    this.ui_config = {};
                    this.estados_config = {limites: {moral_max: 100, cordura_max: 100}};
                    this.descansos = {};
                    this.recompensas = {};
                    this.comportamiento = {};
                    this.monstruos_exp = {monstruos: []};
                }
            }
            
            
           async cargarEncuentros() {
                try {
                    // Determinar archivo según nivel
                    let archivoEncuentros = '';
                    if (this.nivel_valor <= 2) {
                        archivoEncuentros = 'nivel_1_2.json';
                    } else if (this.nivel_valor <= 4) {
                        archivoEncuentros = 'nivel_3_4.json';
                    } else if (this.nivel_valor <= 6) {
                        archivoEncuentros = 'nivel_5_6.json';
                    } else {
                        archivoEncuentros = 'nivel_7_8.json';
                    }
                    
                    const response = await fetch(`${this.DATA_DIR}/encuentros/${archivoEncuentros}`);
                    if (!response.ok) throw new Error(`No se pudo cargar ${archivoEncuentros}`);
                    
                    this.encuentros = await response.json();
                    console.log(`Encuentros cargados para nivel ${this.nivel_valor}:`, Object.keys(this.encuentros));
                    
                } catch (e) {
                    console.error("Error cargando encuentros:", e);
                    this.mostrarMensajeLog(`No se pudo cargar los encuentros: ${e.message}`, 'enemigo');
                    this.encuentros = {};
                }
            }

            async cargarExperienciaMonstruos() {
                try {
                    const response = await fetch(`${this.DATA_DIR}/encuentros/monstruos-exp.json`);
                    if (!response.ok) throw new Error("No se pudo cargar monstruos-exp.json");
                    
                    this.monstruos_exp = await response.json();
                    
                } catch (e) {
                    console.error("Error cargando experiencia de monstruos:", e);
                    this.monstruos_exp = {monstruos: []};
                }
            }

            inicializarUI() {
                // Cargar imágenes de botones
                this.cargarImagenesBotones();
                
                // Configurar eventos de botones
                this.configurarEventosBotones();
                
                // Cargar fondo
                this.cargarFondo();
            }
            
            cargarImagenesBotones() {
                // Configurar botones con imágenes
                const botonesConfig = {
                    'btn-nivel-down': 'btn_nivel_down.png',
                    'btn-nivel-up': 'btn_nivel_up.png',
                    'btn-apuesta-down': 'btn_apuesta_down.png',
                    'btn-apuesta-up': 'btn_apuesta_up.png',
                    'btn-iniciar': 'btn_iniciar.png',
                    'btn-ronda': 'btn_ronda.png',
                    'btn-heroico': 'btn_heroico.png',
                    'btn-deshonroso': 'btn_deshonroso.png',
                    'btn-musica-on': 'btn_con_musica.png',
                    'btn-musica-off': 'btn_sin_musica.png',
                    'btn-reiniciar': 'btn_reiniciar.png',
                    'btn-reglas': 'btn_reglas.png'
                };
                
                for (const [id, imagen] of Object.entries(botonesConfig)) {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.style.backgroundImage = `url('${this.IMAGES_DIR}/${imagen}')`;
                    }
                }
            }
            
            configurarEventosBotones() {
                // Botones de nivel
                document.getElementById('btn-nivel-up').addEventListener('click', () => this.incrementarNivel());
                document.getElementById('btn-nivel-down').addEventListener('click', () => this.decrementarNivel());
                
                // Botones de apuesta
                document.getElementById('btn-apuesta-up').addEventListener('click', () => this.incrementarApuesta());
                document.getElementById('btn-apuesta-down').addEventListener('click', () => this.decrementarApuesta());
                
                // Botones principales
                document.getElementById('btn-iniciar').addEventListener('click', () => this.iniciarArena());
                document.getElementById('btn-ronda').addEventListener('click', () => this.siguienteRonda());
                document.getElementById('btn-heroico').addEventListener('click', () => this.evaluarAccion('heroica'));
                document.getElementById('btn-deshonroso').addEventListener('click', () => this.evaluarAccion('deshonrosa'));
                document.getElementById('btn-reiniciar').addEventListener('click', () => this.reiniciarArena());
                document.getElementById('btn-reglas').addEventListener('click', () => this.mostrarReglas());
                
                // Botones de música
                document.getElementById('btn-musica-on').addEventListener('click', () => this.desactivarMusica());
                document.getElementById('btn-musica-off').addEventListener('click', () => this.activarMusica());
            }
            
            cargarFondo() {
                const fondo = document.getElementById('background');
                fondo.style.backgroundImage = `url('${this.IMAGES_DIR}/fondo.png')`;
            }
            
            inicializarEstados() {
                // Usar valores de configuración si están disponibles
                const limites = this.estados_config.limites || {};
                this.moral_grupo = limites.moral_max || 10;
                this.cordura = limites.cordura_max || 10;
                
                // Reiniciar otros estados
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
            }
            
            inicializarMusica() {
                // Inicializar música
                this.audioElement = new Audio(`${this.AUDIO_DIR}/musica_fondo.mp3`);
                this.audioElement.loop = true;
                this.audioElement.volume = 0.7;
                
                // Reproducir automáticamente sin esperar interacción del usuario
                this.audioElement.play().catch(e => {
                    console.log("Error al reproducir música automáticamente:", e);
                });
            }
            
            mostrarMensajeBienvenida() {
                this.mostrarMensajeLog("\n=== BIENVENIDO A LA ARENA DE LORAINIA ===", 'titulo');
                this.mostrarMensajeLog("¡Atención, ciudadanos de Lorainia! Aventureros de las Tierras Antiguas,\n"
                                     + "estáis bajo la atenta mirada de los dioses y del gran rey Logan III.", 'publico');
                this.mostrarMensajeLog("Reglamento escrito por José Manuel Arena v1.4 y aplicacion por Omar Nieto (DETION)", 'enemigo');
            }
            
            iniciarEfectoParpadeo() {
                this.blink_interval = setInterval(() => {
                    this.blink_state = !this.blink_state;
                }, 500);
            }
            
            configurarEventos() {
                // Ya configurado en configurarEventosBotones()
            }
            
            incrementarNivel() {
                if (this.nivel_valor < 10) {
                    this.nivel_valor++;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                    this.actualizarNivelArena();
                }
            }
            
            decrementarNivel() {
                if (this.nivel_valor > 1) {
                    this.nivel_valor--;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                    this.actualizarNivelArena();
                }
            }

            actualizarNivelArena() {
                let nivelArena = "";
                let color = "";
                
                if (this.nivel_valor <= 2) {
                    nivelArena = "COBRE";
                    color = "#CD7F32"; // Bronze color
                } else if (this.nivel_valor <= 4) {
                    nivelArena = "BRONCE";
                    color = "#B87333"; // Copper color
                } else if (this.nivel_valor <= 6) {
                    nivelArena = "PLATA";
                    color = "#C0C0C0"; // Silver color
                } else {
                    nivelArena = "ORO";
                    color = "#FFD700"; // Gold color
                }
                
                const nivelArenaLabel = document.getElementById('nivel-arena-label');
                nivelArenaLabel.textContent = `Nivel arena ${nivelArena}`;
                nivelArenaLabel.style.color = color;
            }
            
            incrementarApuesta() {
                if (this.apuesta_valor < 500) {
                    this.apuesta_valor = Math.min(500, this.apuesta_valor + 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            decrementarApuesta() {
                if (this.apuesta_valor > 0) {
                    this.apuesta_valor = Math.max(0, this.apuesta_valor - 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            mostrarMensajeLog(mensaje, tipo) {
                const eventLog = document.getElementById('event-log');
                const p = document.createElement('p');
                p.className = `log-${tipo}`;
                p.textContent = mensaje;
                eventLog.appendChild(p);
                
                // Scroll al final
                eventLog.scrollTop = eventLog.scrollHeight;
            }
            
            activarMusica() {
                this.musica_activada = true;
                document.getElementById('btn-musica-off').style.display = 'none';
                document.getElementById('btn-musica-on').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.play().catch(e => {
                        console.log("Error al reactivar música:", e);
                    });
                }
            }
            
            desactivarMusica() {
                this.musica_activada = false;
                document.getElementById('btn-musica-on').style.display = 'none';
                document.getElementById('btn-musica-off').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.pause();
                }
            }
            
            reiniciarArena() {
                const eventLog = document.getElementById('event-log');
                eventLog.innerHTML = '';
                
                this.inicializarEstados();
                
                // Reiniciar estados de botones
                document.getElementById('btn-iniciar').disabled = false;
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                
                // Reiniciar valores
                this.nivel_valor = 1;
                this.apuesta_valor = 0;
                document.getElementById('nivel-label').textContent = this.nivel_valor;
                document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                
                // Ocultar la cuadrícula si está visible
                if (this.gridVisible) {
                    this.ocultarGrid();
                }
                
                this.mostrarMensajeBienvenida();
            }
            
            mostrarReglas() {
                this.mostrarMensajeLog("\n=== REGLAS DE LA ARENA ===", 'titulo');
                this.mostrarMensajeLog("1. Selecciona el nivel de tus héroes y la apuesta inicial", 'lista');
                this.mostrarMensajeLog("2. Haz clic en 'Iniciar Arena' para comenzar", 'lista');
                this.mostrarMensajeLog("3. En cada ronda, enfrentarás enemigos aleatorios", 'lista');
                this.mostrarMensajeLog("4. Después de cada encuentro, puedes realizar acciones heroicas o deshonrosas", 'lista');
                this.mostrarMensajeLog("5. Gana experiencia y recompensas al completar rondas", 'lista');
                this.mostrarMensajeLog("6. ¡Cuidado con la moral y cordura de tu grupo!", 'lista');
            }
            
            async iniciarArena() {
                // Establecer el nivel de los héroes (IMPORTANTE)
                this.heroes_nivel = this.nivel_valor;

                // Cargar encuentros según el nivel
                await this.cargarEncuentros();
                
                // Deshabilitar botón de inicio
                document.getElementById('btn-iniciar').disabled = true;
                document.getElementById('btn-ronda').disabled = false;
                
                // Registrar apuesta si existe
                if (this.apuesta_valor > 0) {
                    this.apuesta_activa = true;
                    this.apuesta_monedas = this.apuesta_valor;
                    this.mostrarMensajeLog(`\nHas apostado ${this.apuesta_valor} monedas de oro. ¡Buena suerte!`, 'apuesta');
                }
                
                this.mostrarMensajeLog(`\n=== INICIANDO ARENA NIVEL ${this.nivel_valor} ===`, 'titulo');
                this.mostrarMensajeLog(`Ronda ${this.ronda_actual}`, 'ronda');
                
                // Generar primer encuentro
                this.ejecutarRonda(this.ronda_actual);
            }
            
            ejecutarRonda(ronda) {
                this.ronda_actual = ronda;
                const tipo_ronda = ronda === 1 ? "Calentamiento" : ronda === 2 ? "Desafío" : "Jefe Final";
                
                // MOSTRAR DESCANSO CORTO AL INICIO DE RONDAS 2 Y 3
                if (ronda === 2 || ronda === 3) {
                    this.mostrarDescansoCorto();
                }
                
                const encuentros_ronda = this.encuentros[`ronda_${ronda}`];
                if (!encuentros_ronda) {
                    this.mostrarMensajeLog(`No se encontraron encuentros para la ronda ${ronda}`, 'enemigo');
                    return;
                }
                
                const tirada = Math.floor(Math.random() * 100) + 1;
                
                for (const encuentro of encuentros_ronda) {
                    const [rango_min, rango_max] = encuentro.rango.split('-').map(Number);
                    if (tirada >= rango_min && tirada <= rango_max) {
                        this.encuentro_actual = encuentro.enemigos;
                        break;
                    }
                }
                
                // Si no se encuentra encuentro, usar el último
                if (!this.encuentro_actual && encuentros_ronda.length > 0) {
                    this.encuentro_actual = encuentros_ronda[encuentros_ronda.length - 1].enemigos;
                }
                
                this.mostrarMensajeLog(`\n=== RONDA ${ronda}: ${tipo_ronda.toUpperCase()} ===`, 'ronda');
                this.mostrarMensajeLog(`Tirada: ${tirada}`, 'enemigo');
                
                // CAPTURAR LA EXPERIENCIA RETORNADA POR mostrarEnemigos()
                const expTotal = this.mostrarEnemigos();
                this.bonif_critico = false;
            }

            mostrarEnemigos() {
                if (!this.encuentro_actual) {
                    this.mostrarMensajeLog("No hay enemigos en esta ronda", 'enemigo');
                    return 0;
                }
                
                // Procesar la expresión para obtener la cantidad real
                const encuentroProcesado = this.procesarExpresionDados(this.encuentro_actual);
                const gruposEnemigos = encuentroProcesado.split(" y ");
                
                this.mostrarMensajeLog("\nENEMIGOS EN LA ARENA:", 'enemigo');
                
                // Diccionario de iconos para tipos de enemigos
                const iconos_enemigos = {
                    "Hechicero": "🧙", "Escudo": "🛡️", "Espada": "⚔️", "Hacha": "⚔️",
                    "Nigromante": "🧙", "Brujo": "🧙", "Chamán": "🧙", "Psíquico": "🧠",
                    "Acechador": "👁️", "Lobo": "🐺", "Rata": "🐀", "Araña": "🕷️",
                    "Ogro": "👹", "Orco": "👹", "Goblin": "👺", "Esqueleto": "💀",
                    "Zombi": "🧟", "Demonio": "😈", "Dragón": "🐲", "Troll": "👹",
                    "Gigante": "👣", "Sátiro": "🐐", "Gárgola": "🗿", "Hidra": "🐍",
                    "Grifo": "🦅", "Wyvern": "🐉", "Vampiro": "🦇", "Momia": "🧟"
                };
                
                let expTotal = 0;
                let expDesglose = [];
                let enemigosParaGrid = [];
                
                for (const grupo of gruposEnemigos) {
                    const grupoTrim = grupo.trim();
                    
                    // Extraer cantidad y nombre
                    let cantidad = 1;
                    let nombreCompleto = grupoTrim;
                    
                    // Buscar patrones como "2 Goblins" o "1d6 Goblins (ya procesado)"
                    const matchCantidad = grupoTrim.match(/^(\d+)\s+(.+)$/);
                    if (matchCantidad) {
                        cantidad = parseInt(matchCantidad[1]);
                        nombreCompleto = matchCantidad[2];
                    }
                    
                    // Limpiar el nombre (eliminar información entre paréntesis y después de "+")
                    let nombreLimpio = nombreCompleto.replace(/\s*\(.*\)$/, '')
                        .replace(/\s*\+.*$/, '')
                        .trim();
                    
                    // BÚSQUEDA MEJORADA DE EXPERIENCIA
                    const monstruoInfo = this.buscarMonstruoPorNombre(nombreLimpio);
                    
                    let expMonstruo = 0;
                    if (monstruoInfo) {
                        expMonstruo = monstruoInfo.exp * cantidad;
                        expTotal += expMonstruo;
                        expDesglose.push({
                            nombre: nombreLimpio, 
                            cantidad: cantidad,
                            expIndividual: monstruoInfo.exp,
                            expTotal: expMonstruo
                        });
                    } else {
                        console.log("No se encontró EXP para:", nombreLimpio);
                        // Asignar experiencia por defecto basada en el nivel
                        const expPorDefecto = this.nivel_valor * 100;
                        expMonstruo = expPorDefecto * cantidad;
                        expTotal += expMonstruo;
                    }
                    
                    // Añadir a la lista para la cuadrícula
                    enemigosParaGrid.push({
                        nombre: nombreLimpio,
                        cantidad: cantidad
                    });
                    
                    // Buscar icono
                    let icono = "👹"; // Por defecto
                    for (const [tipo, emoji] of Object.entries(iconos_enemigos)) {
                        if (nombreLimpio.includes(tipo)) {
                            icono = emoji;
                            break;
                        }
                    }
                    
                    // Mostrar información del enemigo con su experiencia individual
                    if (monstruoInfo) {
                        this.mostrarMensajeLog(
                            `${icono} ${cantidad} ${nombreLimpio} (EXP: ${expMonstruo} = ${cantidad} × ${monstruoInfo.exp})`, 
                            'enemigo'
                        );
                    } else {
                        this.mostrarMensajeLog(
                            `${icono} ${cantidad} ${nombreLimpio} (EXP: ${expMonstruo})`, 
                            'enemigo'
                        );
                    }
                }
                
                // Mostrar la cuadrícula con los enemigos
                this.mostrarGridConEnemigos(enemigosParaGrid);
                
                // Actualizar experiencia acumulada
                if (expTotal > 0) {
                    this.exp_total_acumulada += expTotal;
                    this.exp_encuentro_actual = expTotal;
                }
                
                return expTotal;
            }

            // Añadir nuevo método para mostrar descanso corto
            mostrarDescansoCorto() {
                const descanso = this.descansos["corto"];
                
                if (!descanso) {
                    this.mostrarMensajeLog("No se encontró información de descanso corto", 'enemigo');
                    return;
                }
                
                this.mostrarMensajeLog("\n=== DESCANSO CORTO ===", 'titulo');
                this.mostrarMensajeLog(descanso.descripcion || "Los héroes toman un breve descanso", 'efecto');
                this.mostrarMensajeLog(`Duración: ${descanso.duracion}`, 'efecto');
                
                // Mostrar beneficios
                this.mostrarMensajeLog("\nBENEFICIOS:", 'titulo');
                if (descanso.beneficios && Array.isArray(descanso.beneficios)) {
                    descanso.beneficios.forEach(beneficio => {
                        this.mostrarMensajeLog(`• ${beneficio}`, 'lista');
                    });
                }
                
                // Aplicar efectos del descanso corto
                this.aplicarEfectosDescanso(descanso.efectos);
            }

            // Añadir método para aplicar efectos del descanso
            aplicarEfectosDescanso(efectos) {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                if (efectos.moral) {
                    this.moral_grupo = Math.min(moral_max, this.moral_grupo + efectos.moral);
                    this.mostrarMensajeLog(`\nMoral del grupo +${efectos.moral}`, 'recompensa');
                }
                
                if (efectos.cordura === "1d3") {
                    const recuperacionCordura = Math.floor(Math.random() * 3) + 1;
                    this.cordura = Math.min(cordura_max, this.cordura + recuperacionCordura);
                    this.mostrarMensajeLog(`Cordura +${recuperacionCordura} (1d3)`, 'recompensa');
                } else if (typeof efectos.cordura === "number") {
                    this.cordura = Math.min(cordura_max, this.cordura + efectos.cordura);
                    this.mostrarMensajeLog(`Cordura +${efectos.cordura}`, 'recompensa');
                }
                
                this.mostrarEstadosActuales();
            }
            
            procesarExpresionDados(expresion, mostrarDetalle = true) {
                // Primero buscar expresiones con dados (1d6+2)
                const regexDados = /(\d+)d(\d+)([+-]\d+)?/g;
                let resultado = expresion;
                let match;
                
                // Procesar todas las expresiones de dados
                while ((match = regexDados.exec(expresion)) !== null) {
                    const cantidad = parseInt(match[1]);
                    const caras = parseInt(match[2]);
                    const modificador = match[3] ? parseInt(match[3]) : 0;
                    
                    let total = 0;
                    let tiradas = [];
                    for (let i = 0; i < cantidad; i++) {
                        const tirada = Math.floor(Math.random() * caras) + 1;
                        tiradas.push(tirada);
                        total += tirada;
                    }
                    total += modificador;
                    
                    let textoReemplazo = `${total}`;
                    if (mostrarDetalle && cantidad > 1) {
                        textoReemplazo = `${total} [${match[0]}: ${tiradas.join("+")}${modificador ? modificador : ""}]`;
                    }
                    
                    resultado = resultado.replace(match[0], textoReemplazo);
                }
                
                // Ahora buscar cantidades fijas (2 Goblins) y asegurarse de que se procesen
                const regexCantidadFija = /^(\d+)\s+([^0-9].*)$/;
                const matchFijo = resultado.match(regexCantidadFija);
                
                if (matchFijo && !resultado.includes('d')) {
                    // Es una cantidad fija, asegurarnos de que se mantenga
                    const cantidad = parseInt(matchFijo[1]);
                    const nombre = matchFijo[2];
                    resultado = `${cantidad} ${nombre}`;
                }
                
                return resultado;
            }

            buscarMonstruoPorNombre(nombreBuscado) {
                if (!this.monstruos_exp.monstruos || this.monstruos_exp.monstruos.length === 0) {
                    return null;
                }
                
                const nombreLimpio = nombreBuscado.trim().toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Eliminar tildes
                    .replace(/[^a-z0-9\s]/g, "") // Eliminar caracteres especiales
                    .replace(/\s+/g, ' '); // Espacios múltiples a uno
                
                // Primero: búsqueda exacta
                let monstruo = this.monstruos_exp.monstruos.find(m => {
                    const nombreMonstruo = m.nombre.toLowerCase()
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        .replace(/[^a-z0-9\s]/g, "")
                        .replace(/\s+/g, ' ');
                    return nombreMonstruo === nombreLimpio;
                });
                
                if (monstruo) return monstruo;
                
                // Segundo: búsqueda por contenido (si el nombre del monstruo está contenido en el nombre buscado)
                monstruo = this.monstruos_exp.monstruos.find(m => {
                    const nombreMonstruo = m.nombre.toLowerCase()
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        .replace(/[^a-z0-9\s]/g, "")
                        .replace(/\s+/g, ' ');
                    
                    return nombreLimpio.includes(nombreMonstruo) || 
                        nombreMonstruo.includes(nombreLimpio);
                });
                
                if (monstruo) return monstruo;
                
                // Tercero: búsqueda por palabras clave comunes
                const palabrasClave = {
                    'goblin': 'Goblin',
                    'zombi': 'Zombi',
                    'lobo': 'Lobo Gigante',
                    'bandido': 'Bandido',
                    'brujo': 'Brujo',
                    'esqueleto': 'Esqueleto',
                    'orco': 'Orco',
                    'sátiro': 'Sátiro',
                    'saurio': 'Saurio',
                    'tumulario': 'Tumulario',
                    'gnoll': 'Gnoll',
                    'sanguijuela': 'Sanguijuela Gigante',
                    'necrófago': 'Necrófago',
                    'hombre bestia': 'Hombre Bestia',
                    'araña': 'Araña Gigante',
                    'ogro': 'Ogro',
                    'nigromante': 'Nigromante',
                    'licántropo': 'Licántropo',
                    'enredador': 'Enredador',
                    'troll': 'Troll Común',
                    'minotauro': 'Minotauro',
                    'momia': 'Momia',
                    'elfo oscuro': 'Elfo Oscuro',
                    'ettin': 'Ettin',
                    'espectro': 'Espectro',
                    'gárgola': 'Gárgola',
                    'wyvern': 'Wyvern',
                    'demonio': 'Demonio de Sangre',
                    'guardian': 'Guardián de la Tumba',
                    'psíquico': 'Psíquico',
                    'esfinge': 'Esfinge',
                    'naga': 'Naga',
                    'scorpion': 'Escorpión Gigante',
                    'vampiro': 'Vampiro',
                    'hidra': 'Hidra',
                    'gigante': 'Gigante',
                    'dragón': 'Dragón'
                };
                
                for (const [clave, valor] of Object.entries(palabrasClave)) {
                    if (nombreLimpio.includes(clave)) {
                        return this.monstruos_exp.monstruos.find(m => m.nombre === valor);
                    }
                }
                
                return null;
            }
            
            evaluarAccion(tipo_accion) {
               
                if (tipo_accion === "heroica") {
                    this.acciones_heroicas++;
                    this.actualizarEstados("heroica");
                } else {
                    this.acciones_deshonrosas++;
                    this.actualizarEstados("deshonrosa");
                }
                
                // Obtener reacción aleatoria del comportamiento.json
                const tipo_reaccion = tipo_accion === "heroica" ? "apoyo" : "desprecio";
                
                // Acceder correctamente a la estructura del JSON
                const reacciones_publico = this.comportamiento.reacciones_publico || {};
                const reacciones = reacciones_publico[tipo_reaccion] || [];
                
                if (reacciones.length > 0) {
                    const reaccion = reacciones[Math.floor(Math.random() * reacciones.length)];
                    this.mostrarMensajeLog(`\nLos héroes realizan una acción ${tipo_accion}:`, tipo_accion);
                    this.mostrarMensajeLog(`» ${reaccion.efecto}`, reaccion.id > 15 ? 'critical' : 'efecto');
                    
                    // Aplicar efectos especiales según el ID
                    this.aplicarEfectoPublico(reaccion.id, tipo_accion === "heroica");
                }
            
                
                // Mostrar estados actualizados
                this.mostrarEstadosActuales();
            }
            
            actualizarEstados(tipo_accion) {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                const cambios = this.estados_config[tipo_accion] || {};
                
                if (cambios.moral) {
                    this.moral_grupo = Math.max(0, Math.min(moral_max, this.moral_grupo + cambios.moral));
                }
                
                if (cambios.cordura) {
                    this.cordura = Math.max(0, Math.min(cordura_max, this.cordura + cambios.cordura));
                }
                
                if (cambios.bonif_critico) {
                    this.bonif_critico = true;
                    this.mostrarMensajeLog("¡BONIFICACIÓN POR CRÍTICO ACTIVADA!", 'critical');
                }
                
                // Mostrar estados actualizados
                this.mostrarEstadosActuales();
            }
            
            mostrarEstadosActuales() {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                this.mostrarMensajeLog(`\nESTADO ACTUAL:`, 'titulo');
                this.mostrarMensajeLog(`Moral del Grupo: ${this.moral_grupo}/${moral_max}`, 'efecto');
                this.mostrarMensajeLog(`Cordura: ${this.cordura}/${cordura_max}`, 'efecto');
                
                if (this.bonif_critico) {
                    this.mostrarMensajeLog("¡BONUS CRÍTICO ACTIVO!", 'critical');
                }
            }
            
            siguienteRonda() {
                // Ocultar la cuadrícula actual si está visible
                if (this.gridVisible) {
                    this.ocultarGrid();
                }
                
                if (this.ronda_actual >= 3) {
                    this.finalizarArena();
                    return;
                }
                
                // Habilitar botones de acción para la nueva ronda
                document.getElementById('btn-heroico').disabled = false;
                document.getElementById('btn-deshonroso').disabled = false;
                
                this.ejecutarRonda(this.ronda_actual + 1);
            }
            
            finalizarArena() {
                this.mostrarMensajeLog("\n=== ¡LA ARENA HA CONCLUIDO! ===", 'titulo');
                
                // Calcular victoria o derrota
                const victoria = this.moral_grupo > 0 && this.cordura > 0;
                
                if (victoria) {
                    this.mostrarMensajeLog("¡VICTORIA DE LOS HÉROES!", 'heroico');
                    this.procesarRecompensas();
                } else {
                    this.mostrarMensajeLog("DERROTA...", 'deshonroso');
                    this.mostrarMensajeLog("Los héroes han caído en la arena", 'enemigo');
                }
                
                // Deshabilitar botones de acción
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                document.getElementById('btn-iniciar').disabled = false;
            }

            procesarRecompensas() {
                // Verificar que tenemos recompensas cargadas
                if (!this.recompensas || Object.keys(this.recompensas).length === 0) {
                    this.mostrarMensajeLog("No se encontraron recompensas configuradas", 'enemigo');
                    return;
                }
                
                // Determinar el grupo de nivel basado en el nivel actual de los héroes
                let grupo_nivel = '';
                if (this.heroes_nivel <= 2) {
                    grupo_nivel = 'nivel_1_2';
                } else if (this.heroes_nivel <= 4) {
                    grupo_nivel = 'nivel_3_4';
                } else if (this.heroes_nivel <= 6) {
                    grupo_nivel = 'nivel_5_6';
                } else if (this.heroes_nivel <= 8) {
                    grupo_nivel = 'nivel_7_8';
                } else {
                    // Para niveles 9-10, usar el grupo más alto disponible
                    grupo_nivel = 'nivel_7_8';
                }
                
                const recompensa = this.recompensas[grupo_nivel];
                
                if (!recompensa) {
                    this.mostrarMensajeLog(`No se encontraron recompensas para el grupo ${grupo_nivel}`, 'enemigo');
                    this.mostrarMensajeLog(`Recompensas disponibles: ${Object.keys(this.recompensas).join(', ')}`, 'enemigo');
                    return;
                }
                
                // Calcular recompensa base (añadiendo la EXP de TODOS los monstruos de todas las rondas)
                let monedas_base = recompensa.monedas || 0;
                let experiencia_base = (recompensa.experiencia || 0) + this.exp_total_acumulada;
                let tesoros = recompensa.tesoros || [];
                
                // Aplicar multiplicador por apuesta si existe
                let multiplicador = 1.0;
                let ganancia_apuesta = 0;
                
                if (this.apuesta_activa && recompensa.multiplicador_monedas) {
                    multiplicador = recompensa.multiplicador_monedas;
                    ganancia_apuesta = parseInt(this.apuesta_monedas * multiplicador);
                }
                
                // Calcular recompensa final (base + ganancia por apuesta)
                const monedas_final = monedas_base + ganancia_apuesta;
                const experiencia_final = experiencia_base;
                
                this.mostrarMensajeLog("\nRECOMPENSAS OBTENIDAS:", 'titulo');
                this.mostrarMensajeLog(`Nivel: ${recompensa.nivel}`, 'recompensa');
                this.mostrarMensajeLog(`${monedas_final} monedas de oro`, 'recompensa');
                this.mostrarMensajeLog(`${experiencia_final} puntos de experiencia`, 'recompensa');

                // Mostrar tesoros integrados en las recompensas
                tesoros.forEach(tesoro => {
                    this.mostrarMensajeLog(`• ${tesoro}`, 'recompensa');
                });
                
                // Mostrar log de recompensas si hay apuesta
                if (this.apuesta_activa) {
                    this.mostrarLogRecompensas(
                        monedas_base, 
                        monedas_final, 
                        multiplicador, 
                        ganancia_apuesta, 
                        tesoros, 
                        experiencia_final,
                        this.exp_total_acumulada
                    );
                }
                
                // Procesar descanso
                this.procesarDescanso();
            }
           
            mostrarLogRecompensas(monedas_base, monedas_final, multiplicador, ganancia_apuesta, tesoros, experiencia_base, exp_monstruos) {
                this.mostrarMensajeLog("\nDESGLOSE DE RECOMPENSA:", 'titulo');
                this.mostrarMensajeLog(`Apuesta inicial: ${this.apuesta_monedas} monedas`, 'recompensa');
                this.mostrarMensajeLog(`Recompensa base: ${monedas_base} monedas`, 'recompensa');
                
                if (exp_monstruos > 0) {
                    // Mostrar experiencia total de todos los monstruos
                    this.mostrarMensajeLog(`Experiencia total de monstruos: +${this.exp_total_acumulada} EXP`, 'recompensa');
                    this.mostrarMensajeLog(`Experiencia base: +${experiencia_base - this.exp_total_acumulada} EXP`, 'recompensa');
                }
                
                this.mostrarMensajeLog(`Multiplicador: x${multiplicador}`, 'recompensa');
                this.mostrarMensajeLog(`Ganancia por apuesta: ${ganancia_apuesta} monedas`, 'recompensa');
                this.mostrarMensajeLog(`TOTAL: ${monedas_final} monedas y ${experiencia_base} EXP`, 'recompensa');
                
                // Mostrar tesoros integrados en el desglose
                tesoros.forEach(tesoro => {
                    this.mostrarMensajeLog(`• ${tesoro}`, 'recompensa');
                });
            }
            
            procesarDescanso() {
                const descanso = this.descansos["largo"];
                
                if (!descanso) {
                    this.mostrarMensajeLog("No se encontró información de descanso largo", 'enemigo');
                    return;
                }
                
                this.mostrarMensajeLog("\nDESCANSO EN LA TABERNA:", 'titulo');
                this.mostrarMensajeLog(descanso.descripcion || "Los héroes descansan y se recuperan", 'efecto');
                this.mostrarMensajeLog(`Duración: ${descanso.duracion}`, 'efecto');
                
                // Mostrar beneficios
                this.mostrarMensajeLog("\nBENEFICIOS:", 'titulo');
                if (descanso.beneficios && Array.isArray(descanso.beneficios)) {
                    descanso.beneficios.forEach(beneficio => {
                        this.mostrarMensajeLog(`• ${beneficio}`, 'lista');
                    });
                }
                
                // Aplicar efectos del descanso largo
                this.aplicarEfectosDescanso(descanso.efectos);
            }
            
            
            mostrarReglas() {
                // Crear un enlace temporal para descargar/abrir el PDF
                const link = document.createElement('a');
                link.href = `${this.BASE_DIR}/assets/data/Arena_V1.4.pdf`;
                link.target = '_blank'; // Abrir en nueva pestaña
                link.download = 'Arena_V1.4.pdf'; // Forzar descarga en algunos navegadores
                
                // Simular clic en el enlace
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.mostrarMensajeLog("\nAbriendo reglas de la arena...", 'publico');
            }
            
            aplicarEfectoPublico(id, esHeroico) {
                // Implementar efectos especiales según el ID de la reacción
                // Esta es una implementación básica que puedes expandir
                if (id > 15) {
                    // Efecto especial para IDs altos
                    if (esHeroico) {
                        this.moral_grupo = Math.min(this.estados_config.limites.moral_max, this.moral_grupo + 5);
                    } else {
                        this.cordura = Math.max(0, this.cordura - 3);
                    }
                }
            }
        }

        // Inicializar la aplicación cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            window.arenaApp = new ArenaApp();
        });
    </script>
</body>
</html>