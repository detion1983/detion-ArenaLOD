[file name]: index.html
[file content begin]
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DETION ARENA: LEAGUE OF DUNGEONEERS</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #2D2D2D;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        /* Contenedor principal */
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Fondo */
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }
        
        /* Panel de configuración */
        .config-panel {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .config-label {
            background-color: transparent;
            color: black;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        
        /* Botones */
        .btn {
            background-color: #2D2D2D;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .btn:hover {
            background-color: #3D3D3D;
        }
        
        .btn:disabled {
            background-color: #555555;
            cursor: not-allowed;
        }
        
        /* Botones principales */
        #main-buttons {
            position: absolute;
            display: flex;
            gap: 12%;
            width: 70%;
            justify-content: center;
        }
        
        /* Log de eventos */
        #event-log {
            position: absolute;
            background-color: transparent;
            color: black;
            border: none;
            text-align: center;
            overflow: auto;
            padding: 10px;
        }
        
        /* Log de recompensas */
        #reward-log {
            position: absolute;
            background-color: transparent;
            color: black;
            border: none;
            text-align: center;
            overflow: auto;
            padding: 10px;
            display: none;
        }
        
        /* Estilos de texto para diferentes tipos de mensajes */
        .log-titulo {
            color: #000000;
            font-weight: bold;
        }
        
        .log-recompensa {
            color: #006400;
        }
        
        .log-enemigo {
            color: #8B0000;
            font-weight: bold;
        }
        
        .log-lista {
            color: #000000;
        }
        
        .log-ronda {
            color: #000000;
            font-weight: bold;
        }
        
        .log-heroico {
            color: #006400;
            font-weight: bold;
        }
        
        .log-deshonroso {
            color: #8B0000;
            font-weight: bold;
        }
        
        .log-publico {
            color: #000000;
            font-style: italic;
        }
        
        .log-efecto {
            color: #000000;
        }
        
        .log-critical {
            color: #8B0000;
            font-weight: bold;
            animation: blink 0.5s infinite;
        }
        
        .log-apuesta {
            color: #006400;
            font-weight: bold;
        }
        
        .log-center {
            color: #000000;
        }
        
        .log-speaker {
            color: #8B4513;
            font-weight: bold;
            font-style: italic;
        }
        
        .log-blink {
            animation: blink 0.5s infinite;
        }
        
        @keyframes blink {
            0% { color: #8b0000; }
            50% { color: #FFCCCB; }
            100% { color: #8b0000; }
        }
        
        /* Scrollbar personalizado */
        #event-log::-webkit-scrollbar, #reward-log::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        
        /* Overlay de inicio para música */
        #music-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #music-overlay p {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #start-audio {
            padding: 15px 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #start-audio:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <!-- Overlay para activar audio -->
    <div id="music-overlay">
        <p>¡Bienvenido a DETION ARENA!</p>
        <p>Haz clic para activar la música de fondo</p>
        <button id="start-audio">Activar Música</button>
    </div>

    <div id="app-container">
        <!-- Fondo -->
        <div id="background"></div>
        
        <!-- Panel de nivel -->
        <div id="nivel-panel" class="config-panel">
            <button id="btn-nivel-down" class="btn"></button>
            <div id="nivel-label" class="config-label">1</div>
            <button id="btn-nivel-up" class="btn"></button>
        </div>
        
        <!-- Panel de apuesta -->
        <div id="apuesta-panel" class="config-panel">
            <button id="btn-apuesta-down" class="btn"></button>
            <div id="apuesta-label" class="config-label">0</div>
            <button id="btn-apuesta-up" class="btn"></button>
        </div>
        
        <!-- Log de eventos -->
        <div id="event-log"></div>
        
        <!-- Log de recompensas -->
        <div id="reward-log"></div>
        
        <!-- Botones principales -->
        <div id="main-buttons">
            <button id="btn-iniciar" class="btn"></button>
            <button id="btn-ronda" class="btn" disabled></button>
            <button id="btn-heroico" class="btn" disabled></button>
            <button id="btn-deshonroso" class="btn" disabled></button>
            <button id="btn-musica-on" class="btn"></button>
            <button id="btn-musica-off" class="btn" style="display:none;"></button>
            <button id="btn-reiniciar" class="btn"></button>
            <button id="btn-reglas" class="btn"></button>
        </div>
    </div>

    <script>
        // Clase principal de la aplicación
        class ArenaApp {
            constructor() {
                this._setupAttributes();
                
                // Configurar el overlay de música primero
                this.setupMusicOverlay();
                
                // Inicializar después de que el usuario interactúe
                document.getElementById('start-audio').addEventListener('click', () => {
                    this.init();
                    document.getElementById('music-overlay').style.display = 'none';
                });
            }
            
            _setupAttributes() {
                // Rutas base
                this.BASE_DIR = window.location.href.replace(/\/[^\/]*$/, '');
                this.IMAGES_DIR = `${this.BASE_DIR}/assets/imagenes`;
                this.AUDIO_DIR = `${this.BASE_DIR}/assets/audio`;
                this.DATA_DIR = `${this.BASE_DIR}/assets/data`;
                
                // Configuraciones
                this.ui_config = null;
                this.estados_config = null;
                this.descansos = null;
                this.recompensas = null;
                this.comportamiento = null;
                
                // Estado del juego
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.moral_grupo = 0;
                this.cordura = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
                
                // Control de música
                this.musica_activada = true;
                this.audioContext = null;
                this.audioElement = null;
                this.audioGain = null;
                
                // Valores de configuración
                this.nivel_valor = 1;
                this.apuesta_valor = 0;
                
                // Efectos
                this.blink_state = false;
                this.blink_interval = null;
                
                // Factores de escala (basado en 1920x1080)
                this.base_width = 1920;
                this.base_height = 1080;
                this.width_scale = 1.0;
                this.height_scale = 1.0;
                this.scale_factor = 1.0;
            }
            
            setupMusicOverlay() {
                // Esta función ya está implementada con el overlay HTML
                // Solo necesitamos asegurarnos de que esté visible al inicio
                document.getElementById('music-overlay').style.display = 'flex';
            }
            
            async init() {
                await this.cargarConfiguraciones();
                this.inicializarUI();
                this.inicializarEstados();
                this.inicializarMusica();
                this.mostrarMensajeBienvenida();
                this.iniciarEfectoParpadeo();
                this.configurarEventos();
                
                // Configurar evento de redimensionamiento
                window.addEventListener('resize', () => {
                    this.calcularFactoresEscala();
                    this.aplicarEscaladoCompleto();
                });
                
                // Calcular factores iniciales
                this.calcularFactoresEscala();
                this.aplicarEscaladoCompleto();
            }
            
            calcularFactoresEscala() {
                this.width_scale = window.innerWidth / this.base_width;
                this.height_scale = window.innerHeight / this.base_height;
                this.scale_factor = Math.min(this.width_scale, this.height_scale);
            }
            
            aplicarEscaladoCompleto() {
                // Ajustar tamaño de botones
                const btnSize = Math.max(40, Math.min(80, 80 * this.scale_factor));
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.style.width = `${btnSize}px`;
                    btn.style.height = `${btnSize}px`;
                });
                
                // Ajustar tamaño de etiquetas
                const labelFontSize = Math.max(30, Math.min(50, 50 * this.scale_factor));
                document.querySelectorAll('.config-label').forEach(label => {
                    label.style.fontSize = `${labelFontSize}px`;
                    label.style.minWidth = `${btnSize}px`;
                });
                
                // Ajustar log de eventos
                const eventLog = document.getElementById('event-log');
                if (eventLog) {
                    const logWidth = Math.max(600, Math.min(1000, 1000 * this.scale_factor));
                    const logHeight = Math.max(180, Math.min(300, 300 * this.scale_factor));
                    const fontSize = Math.max(10, Math.min(14, 14 * this.scale_factor));
                    
                    eventLog.style.width = `${logWidth}px`;
                    eventLog.style.height = `${logHeight}px`;
                    eventLog.style.fontSize = `${fontSize}px`;
                }
                
                // Ajustar log de recompensas
                const rewardLog = document.getElementById('reward-log');
                if (rewardLog) {
                    const rewardWidth = Math.max(270, Math.min(450, 450 * this.scale_factor));
                    const rewardHeight = Math.max(150, Math.min(250, 250 * this.scale_factor));
                    const fontSize = Math.max(8, Math.min(10, 10 * this.scale_factor));
                    
                    rewardLog.style.width = `${rewardWidth}px`;
                    rewardLog.style.height = `${rewardHeight}px`;
                    rewardLog.style.fontSize = `${fontSize}px`;
                }
                
                // Reposicionar elementos
                this.reposicionarElementos();
            }
            
            reposicionarElementos() {
                // Definir posiciones relativas (proporciones de 0 a 1)
                const positions = {
                    'nivel-panel': { x: 0.106, y: 0.43 },
                    'apuesta-panel': { x: 0.846, y: 0.43 },
                    'event-log': { x: 0.5, y: 0.41 },
                    'reward-log': { x: 0.5, y: 0.73 },
                    'main-buttons': { x: 0.5, y: 0.94 }
                };
                
                // Posicionar elementos
                for (const [id, pos] of Object.entries(positions)) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (id === 'main-buttons') {
                            // Centrar el contenedor de botones
                            element.style.bottom = `${window.innerHeight * (1 - pos.y)}px`;
                            element.style.left = '50%';
                            element.style.transform = 'translateX(-50%)';
                        } else {
                            // Posicionar elementos absolutos
                            const x = window.innerWidth * pos.x;
                            const y = window.innerHeight * pos.y;
                            
                            if (id === 'event-log' || id === 'reward-log') {
                                // Centrar logs
                                element.style.left = `${x - element.offsetWidth / 2}px`;
                                element.style.top = `${y - element.offsetHeight / 2}px`;
                            } else {
                                // Posicionar paneles
                                element.style.left = `${x - element.offsetWidth / 2}px`;
                                element.style.top = `${y - element.offsetHeight / 2}px`;
                            }
                        }
                    }
                }
            }
            
            async cargarConfiguraciones() {
                try {
                    // Cargar configuraciones desde archivos JSON
                    const configFiles = [
                        'ui_config.json',
                        'estados.json',
                        'descansos.json',
                        'recompensas.json',
                        'comportamiento.json'
                    ];
                    
                    // Cargar cada archivo de configuración
                    const [uiConfig, estadosConfig, descansosConfig, recompensasConfig, comportamientoConfig] = await Promise.all(
                        configFiles.map(file => 
                            fetch(`${this.DATA_DIR}/${file}`)
                                .then(response => {
                                    if (!response.ok) throw new Error(`No se pudo cargar ${file}`);
                                    return response.json();
                                })
                        )
                    );
                    
                    this.ui_config = uiConfig;
                    this.estados_config = estadosConfig;
                    this.descansos = descansosConfig;
                    this.recompensas = recompensasConfig;
                    this.comportamiento = comportamientoConfig;
                    
                    // Cargar encuentros según el nivel
                    await this.cargarEncuentros();
                    
                } catch (e) {
                    console.error("Error cargando configuraciones:", e);
                    
                    // Configuración de respaldo si no se pueden cargar los archivos
                    this.estados_config = {
                        limites: {
                            moral_max: 10,
                            cordura_max: 10
                        },
                        efectos: {
                            heroico: { moral: 1 },
                            deshonroso: { cordura: -1 }
                        }
                    };
                    
                    this.descansos = {
                        corto: {
                            descripcion: "DESCANSO CORTO",
                            beneficios: [
                                "Los héroes recuperan el aliento",
                                "Curan heridas leves",
                                "Preparan la siguiente ronda"
                            ],
                            efectos: {
                                moral: 1,
                                cordura: "1d4"
                            }
                        }
                    };
                    
                    this.recompensas = {
                        nivel_1_2: {
                            multiplicador_monedas: 1.5,
                            monedas: 100,
                            experiencia: 50,
                            tesoros: ["Poción de curación menor", "Escudo de madera"]
                        },
                        nivel_3_4: {
                            multiplicador_monedas: 2.0,
                            monedas: 200,
                            experiencia: 100,
                            tesoros: ["Espada de acero", "Armadura de cuero"]
                        },
                        nivel_5_6: {
                            multiplicador_monedas: 2.5,
                            monedas: 300,
                            experiencia: 200,
                            tesoros: ["Arco élfico", "Amuleto de protección"]
                        },
                        nivel_7_8: {
                            multiplicador_monedas: 3.0,
                            monedas: 500,
                            experiencia: 400,
                            tesoros: ["Espada legendaria", "Armadura de placas"]
                        }
                    };
                    
                    this.comportamiento = {
                        reacciones_publico: {
                            apoyo: [
                                { id: 1, efecto: "El público vitorea a los héroes" },
                                { id: 4, efecto: "¡Oleada de apoyo! Los héroes se sienten inspirados" },
                                { id: 19, efecto: "El público canta himnos de gloria" }
                            ],
                            desprecio: [
                                { id: 4, efecto: "El público abuchea a los héroes" },
                                { id: 5, efecto: "Gritos de ira afectan la cordura de los héroes" }
                            ]
                        }
                    };
                    
                    // Cargar encuentros de ejemplo
                    this.encuentros = {
                        ronda_1: [
                            { rango: "1-30", enemigos: "Lobos y Jabalíes" },
                            { rango: "31-70", enemigos: "Bandidos y Asaltantes" },
                            { rango: "71-100", enemigos: "Orcos y Goblins" }
                        ],
                        ronda_2: [
                            { rango: "1-25", enemigos: "Trolls y Ogros" },
                            { rango: "26-60", enemigos: "Esqueletos y Zombis" },
                            { rango: "61-100", enemigos: "Magos Oscuros y Necromantes" }
                        ],
                        ronda_3: [
                            { rango: "1-40", enemigos: "Dragón Rojo" },
                            { rango: "41-100", enemigos: "Demonio del Abismo" }
                        ]
                    };
                }
            }
            
            async cargarEncuentros() {
                try {
                    // Determinar archivo según nivel
                    let archivoEncuentros;
                    if (this.nivel_valor >= 1 && this.nivel_valor <= 2) {
                        archivoEncuentros = "nivel_1_2.json";
                    } else if (this.nivel_valor >= 3 && this.nivel_valor <= 4) {
                        archivoEncuentros = "nivel_3_4.json";
                    } else if (this.nivel_valor >= 5 && this.nivel_valor <= 6) {
                        archivoEncuentros = "nivel_5_6.json";
                    } else if (this.nivel_valor >= 7 && this.nivel_valor <= 10) {
                        archivoEncuentros = "nivel_7_8.json";
                    }
                    
                    if (archivoEncuentros) {
                        const response = await fetch(`${this.DATA_DIR}/encuentros/${archivoEncuentros}`);
                        if (response.ok) {
                            this.encuentros = await response.json();
                        } else {
                            throw new Error(`No se pudo cargar ${archivoEncuentros}`);
                        }
                    }
                } catch (e) {
                    console.error("Error cargando encuentros:", e);
                    // Usar encuentros por defecto si hay error
                    this.encuentros = {
                        ronda_1: [
                            { rango: "1-30", enemigos: "Lobos y Jabalíes" },
                            { rango: "31-70", enemigos: "Bandidos y Asaltantes" },
                            { rango: "71-100", enemigos: "Orcos y Goblins" }
                        ],
                        ronda_2: [
                            { rango: "1-25", enemigos: "Trolls y Ogros" },
                            { rango: "26-60", enemigos: "Esqueletos y Zombis" },
                            { rango: "61-100", enemigos: "Magos Oscuros y Necromantes" }
                        ],
                        ronda_3: [
                            { rango: "1-40", enemigos: "Dragón Rojo" },
                            { rango: "41-100", enemigos: "Demonio del Abismo" }
                        ]
                    };
                }
            }
            
            inicializarUI() {
                // Cargar imágenes de fondo y botones
                this.cargarImagenFondo();
                this.cargarImagenesBotones();
            }
            
            cargarImagenFondo() {
                const background = document.getElementById('background');
                // Usar una imagen de fondo por defecto si no existe la específica
                background.style.backgroundImage = `url('${this.IMAGES_DIR}/fondo.png'), url('https://placehold.co/1920x1080/2D2D2D/FFFFFF/png?text=DETION+ARENA')`;
            }
            
            cargarImagenesBotones() {
                // Botones de configuración
                this.cargarImagenBoton('btn-nivel-down', 'btn_nivel_down.png');
                this.cargarImagenBoton('btn-nivel-up', 'btn_nivel_up.png');
                this.cargarImagenBoton('btn-apuesta-down', 'btn_apuesta_down.png');
                this.cargarImagenBoton('btn-apuesta-up', 'btn_apuesta_up.png');
                
                // Botones principales
                this.cargarImagenBoton('btn-iniciar', 'btn_iniciar.png');
                this.cargarImagenBoton('btn-ronda', 'btn_ronda.png');
                this.cargarImagenBoton('btn-heroico', 'btn_heroico.png');
                this.cargarImagenBoton('btn-deshonroso', 'btn_deshonroso.png');
                this.cargarImagenBoton('btn-musica-on', 'btn_con_musica.png');
                this.cargarImagenBoton('btn-musica-off', 'btn_sin_musica.png');
                this.cargarImagenBoton('btn-reiniciar', 'btn_reiniciar.png');
                this.cargarImagenBoton('btn-reglas', 'btn_reglas.png');
            }
            
            cargarImagenBoton(elementId, imageName) {
                const element = document.getElementById(elementId);
                if (element) {
                    // Usar imagen por defecto si no existe la específica
                    element.style.backgroundImage = `url('${this.IMAGES_DIR}/${imageName}'), url('https://placehold.co/80x80/555555/FFFFFF/png?text=${imageName.replace('.png', '')}')`;
                }
            }
            
            inicializarMusica() {
                try {
                    // Crear contexto de audio
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Crear elemento de audio
                    this.audioElement = new Audio();
                    
                    // Configurar para loop
                    this.audioElement.loop = true;
                    
                    // Crear nodo de ganancia para control de volumen
                    this.audioGain = this.audioContext.createGain();
                    this.audioGain.gain.value = 0.7; // 70% de volumen
                    
                    // Conectar la fuente de audio al nodo de ganancia y luego a los altavoces
                    const source = this.audioContext.createMediaElementSource(this.audioElement);
                    source.connect(this.audioGain);
                    this.audioGain.connect(this.audioContext.destination);
                    
                    // Cargar música
                    this.audioElement.src = `${this.AUDIO_DIR}/musica_fondo.mp3`;
                    
                    // Intentar reproducir (ya tenemos interacción del usuario por el overlay)
                    if (this.musica_activada) {
                        this.audioElement.play().catch(e => {
                            console.error("Error al reproducir música:", e);
                            // Si falla, mostrar de nuevo el overlay
                            document.getElementById('music-overlay').style.display = 'flex';
                            document.getElementById('music-overlay').querySelector('p').textContent = 
                                "Error al cargar la música. Haz clic para reintentar.";
                        });
                    }
                } catch (e) {
                    console.error("Error inicializando música:", e);
                    // Mostrar overlay de error
                    document.getElementById('music-overlay').style.display = 'flex';
                    document.getElementById('music-overlay').querySelector('p').textContent = 
                        "Error al inicializar el audio. Haz clic para reintentar.";
                }
            }
            
            activarMusica() {
                this.musica_activada = true;
                document.getElementById('btn-musica-off').style.display = 'none';
                document.getElementById('btn-musica-on').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.play().catch(e => {
                        console.error("Error al reanudar música:", e);
                    });
                }
            }
            
            desactivarMusica() {
                this.musica_activada = false;
                document.getElementById('btn-musica-on').style.display = 'none';
                document.getElementById('btn-musica-off').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.pause();
                }
            }
            
            configurarEventos() {
                // Botones de nivel
                document.getElementById('btn-nivel-up').addEventListener('click', () => this.incrementarNivel());
                document.getElementById('btn-nivel-down').addEventListener('click', () => this.decrementarNivel());
                
                // Botones de apuesta
                document.getElementById('btn-apuesta-up').addEventListener('click', () => this.incrementarApuesta());
                document.getElementById('btn-apuesta-down').addEventListener('click', () => this.decrementarApuesta());
                
                // Botones principales
                document.getElementById('btn-iniciar').addEventListener('click', () => this.iniciarArena());
                document.getElementById('btn-ronda').addEventListener('click', () => this.siguienteRonda());
                document.getElementById('btn-heroico').addEventListener('click', () => this.evaluarAccion('heroica'));
                document.getElementById('btn-deshonroso').addEventListener('click', () => this.evaluarAccion('deshonrosa'));
                document.getElementById('btn-musica-on').addEventListener('click', () => this.desactivarMusica());
                document.getElementById('btn-musica-off').addEventListener('click', () => this.activarMusica());
                document.getElementById('btn-reiniciar').addEventListener('click', () => this.reiniciarArena());
                document.getElementById('btn-reglas').addEventListener('click', () => this.mostrarReglas());
            }
            
            incrementarNivel() {
                if (this.nivel_valor < 10) {
                    this.nivel_valor++;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                }
            }
            
            decrementarNivel() {
                if (this.nivel_valor > 1) {
                    this.nivel_valor--;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                }
            }
            
            incrementarApuesta() {
                if (this.apuesta_valor < 500) {
                    this.apuesta_valor = Math.min(500, this.apuesta_valor + 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            decrementarApuesta() {
                if (this.apuesta_valor > 0) {
                    this.apuesta_valor = Math.max(0, this.apuesta_valor - 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            iniciarEfectoParpadeo() {
                this.blink_interval = setInterval(() => {
                    this.blink_state = !this.blink_state;
                }, 500);
            }
            
            mostrarMensajeLog(mensaje, tag = 'center') {
                const eventLog = document.getElementById('event-log');
                if (!eventLog) return;
                
                const line = document.createElement('div');
                line.className = `log-${tag}`;
                line.textContent = mensaje;
                
                if (tag === 'critical') {
                    const attentionLine = document.createElement('div');
                    attentionLine.className = 'log-blink';
                    attentionLine.textContent = '¡'.repeat(10) + ' ATENCIÓN ' + '¡'.repeat(10);
                    eventLog.appendChild(attentionLine);
                    
                    eventLog.appendChild(line);
                    
                    const bottomLine = document.createElement('div');
                    bottomLine.className = 'log-blink';
                    bottomLine.textContent = '¡'.repeat(30);
                    eventLog.appendChild(bottomLine);
                } else {
                    eventLog.appendChild(line);
                }
                
                eventLog.scrollTop = eventLog.scrollHeight;
            }
            
            mostrarMensajeBienvenida() {
                this.mostrarMensajeLog('\n=== BIENVENIDO A LA ARENA DE LORAINIA ===', 'titulo');
                this.mostrarMensajeLog('¡Atención, ciudadanos de Lorainia! Aventureros de las Tierras Antiguas,\n' +
                                       'estáis bajo la atenta mirada de los dioses y del gran rey Logan III. Aquí hallaréis muerte o gloria.', 'publico');
                this.mostrarMensajeLog('Reglamento escrito por José Manuel Arena v1.3 y aplicacion por Omar Nieto (DETION)', 'enemigo');
            }
            
            inicializarEstados() {
                const limites = this.estados_config.limites;
                this.moral_grupo = limites.moral_max;
                this.cordura = limites.cordura_max;
                
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
            }
            
            reiniciarArena() {
                const eventLog = document.getElementById('event-log');
                if (eventLog) eventLog.innerHTML = '';
                
                this.inicializarEstados();
                
                const rewardLog = document.getElementById('reward-log');
                if (rewardLog) {
                    rewardLog.innerHTML = '';
                    rewardLog.style.display = 'none';
                }
                
                document.getElementById('btn-iniciar').disabled = false;
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                
                this.musica_activada = true;
                document.getElementById('btn-musica-off').style.display = 'none';
                document.getElementById('btn-musica-on').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.play().catch(e => {
                        console.error("Error al reanudar música:", e);
                    });
                }
                
                this.mostrarMensajeBienvenida();
                this.mostrarMensajeLog('\n=== ARENA REINICIADA ===', 'titulo');
            }
            
            async iniciarArena() {
                const nivel = this.nivel_valor;
                const apuesta = this.apuesta_valor;
                
                try {
                    if (apuesta < 0 || apuesta > 500) {
                        throw new Error("La apuesta debe estar entre 0 y 500");
                    }
                    
                    // Cargar encuentros según el nivel
                    await this.cargarEncuentros();
                    
                    // Determinar configuración según nivel
                    let config_seleccionada = null;
                    if (nivel >= 1 && nivel <= 2) {
                        this.heroes_nivel = "1_2";
                        config_seleccionada = "nivel_1_2";
                    } else if (nivel >= 3 && nivel <= 4) {
                        this.heroes_nivel = "3_4";
                        config_seleccionada = "nivel_3_4";
                    } else if (nivel >= 5 && nivel <= 6) {
                        this.heroes_nivel = "5_6";
                        config_seleccionada = "nivel_5_6";
                    } else if (nivel >= 7 && nivel <= 10) {
                        this.heroes_nivel = "7_8";
                        config_seleccionada = "nivel_7_8";
                    } else {
                        throw new Error("Nivel debe estar entre 1 y 10");
                    }
                    
                    this.apuesta_monedas = apuesta;
                    this.apuesta_activa = apuesta > 0;
                    
                    // Obtener el multiplicador de recompensas
                    const recompensa = this.recompensas[config_seleccionada];
                    const multiplicador = recompensa.multiplicador_monedas;
                    
                    // Mostrar mensaje del speaker sobre la apuesta
                    this.mostrarMensajeLog('\n«¡Atención, nobles espectadores!»', 'speaker');
                    
                    if (this.apuesta_activa) {
                        const ganancia_potencial = Math.floor(this.apuesta_monedas * multiplicador);
                        this.mostrarMensajeLog(`«¡Nuestros valientes héroes han apostado ${this.apuesta_monedas} monedas!»`, 'speaker');
                        this.mostrarMensajeLog(`«Si logran la victoria, obtendrán ${ganancia_potencial} monedas adicionales!»`, 'speaker');
                    } else {
                        this.mostrarMensajeLog('«¡Jajaja nuestros héroes no han apostado o eso quiere decir que solo les queda la vida!»', 'speaker');
                    }
                    
                    // Iniciar la arena
                    this.mostrarMensajeLog('\n=== ARENA INICIADA ===', 'titulo');
                    this.mostrarMensajeLog(`Nivel: ${nivel} | Apuesta: ${apuesta} monedas`, 'center');
                    
                    // Habilitar botones
                    document.getElementById('btn-iniciar').disabled = true;
                    document.getElementById('btn-ronda').disabled = false;
                    document.getElementById('btn-heroico').disabled = false;
                    document.getElementById('btn-deshonroso').disabled = false;
                    
                    // Generar primer encuentro
                    this.generarEncuentro();
                    
                } catch (error) {
                    this.mostrarMensajeLog(`Error: ${error.message}`, 'enemigo');
                }
            }
            
            generarEncuentro() {
                const ronda_key = `ronda_${this.ronda_actual}`;
                if (!this.encuentros[ronda_key]) {
                    this.mostrarMensajeLog(`No hay encuentros definidos para la ronda ${this.ronda_actual}`, 'enemigo');
                    return;
                }
                
                const encuentros_ronda = this.encuentros[ronda_key];
                const tirada = Math.floor(Math.random() * 100) + 1;
                
                // Encontrar el encuentro correspondiente a la tirada
                for (const encuentro of encuentros_ronda) {
                    const [min, max] = encuentro.rango.split('-').map(Number);
                    if (tirada >= min && tirada <= max) {
                        this.encuentro_actual = encuentro;
                        break;
                    }
                }
                
                if (this.encuentro_actual) {
                    this.mostrarMensajeLog(`\n=== RONDA ${this.ronda_actual} ===`, 'ronda');
                    this.mostrarMensajeLog(`Tirada: ${tirada} - ${this.encuentro_actual.enemigos}`, 'enemigo');
                    
                    // Mostrar descripción si existe
                    if (this.encuentro_actual.descripcion) {
                        this.mostrarMensajeLog(this.encuentro_actual.descripcion, 'efecto');
                    }
                    
                    // Mostrar efectos si existen
                    if (this.encuentro_actual.efectos) {
                        for (const [estado, valor] of Object.entries(this.encuentro_actual.efectos)) {
                            this.mostrarMensajeLog(`${estado.toUpperCase()}: ${valor}`, 'efecto');
                        }
                    }
                }
            }
            
            siguienteRonda() {
                if (this.ronda_actual >= 3) {
                    this.finalizarArena();
                    return;
                }
                
                this.ronda_actual++;
                this.generarEncuentro();
                
                // Después de cada ronda, aplicar descanso corto
                this.aplicarDescansoCorto();
            }
            
            aplicarDescansoCorto() {
                const descanso = this.descansos.corto;
                
                this.mostrarMensajeLog(`\n${descanso.descripcion}`, 'titulo');
                
                // Mostrar beneficios
                for (const beneficio of descanso.beneficios) {
                    this.mostrarMensajeLog(`✓ ${beneficio}`, 'efecto');
                }
                
                // Aplicar efectos
                if (descanso.efectos) {
                    for (const [estado, valor] of Object.entries(descanso.efectos)) {
                        if (estado === 'moral') {
                            this.moral_grupo = Math.min(this.estados_config.limites.moral_max, this.moral_grupo + Number(valor));
                            this.mostrarMensajeLog(`Moral +${valor}`, 'efecto');
                        } else if (estado === 'cordura') {
                            // Si es un dado (formato XdY)
                            if (typeof valor === 'string' && valor.includes('d')) {
                                const [numDados, caras] = valor.split('d').map(Number);
                                let total = 0;
                                for (let i = 0; i < numDados; i++) {
                                    total += Math.floor(Math.random() * caras) + 1;
                                }
                                this.cordura = Math.min(this.estados_config.limites.cordura_max, this.cordura + total);
                                this.mostrarMensajeLog(`Cordura +${total} (${valor})`, 'efecto');
                            } else {
                                this.cordura = Math.min(this.estados_config.limites.cordura_max, this.cordura + Number(valor));
                                this.mostrarMensajeLog(`Cordura +${valor}`, 'efecto');
                            }
                        }
                    }
                }
                
                // Mostrar estados actualizados
                this.mostrarMensajeLog(`Moral actual: ${this.moral_grupo}/${this.estados_config.limites.moral_max}`, 'center');
                this.mostrarMensajeLog(`Cordura actual: ${this.cordura}/${this.estados_config.limites.cordura_max}`, 'center');
            }
            
            evaluarAccion(tipo) {
                if (tipo === 'heroica') {
                    this.acciones_heroicas++;
                    this.mostrarMensajeLog(`\nAcción Heroica #${this.acciones_heroicas}`, 'heroico');
                    
                    // Aplicar efecto de acción heroica
                    const efecto = this.estados_config.efectos.heroico;
                    if (efecto.moral) {
                        this.moral_grupo = Math.min(this.estados_config.limites.moral_max, this.moral_grupo + efecto.moral);
                        this.mostrarMensajeLog(`Moral +${efecto.moral}`, 'efecto');
                    }
                    
                    // Posible reacción del público
                    this.reaccionPublico('apoyo');
                    
                } else if (tipo === 'deshonrosa') {
                    this.acciones_deshonrosas++;
                    this.mostrarMensajeLog(`\nAcción Deshonrosa #${this.acciones_deshonrosas}`, 'deshonroso');
                    
                    // Aplicar efecto de acción deshonrosa
                    const efecto = this.estados_config.efectos.deshonroso;
                    if (efecto.cordura) {
                        this.cordura = Math.max(0, this.cordura + efecto.cordura);
                        this.mostrarMensajeLog(`Cordura ${efecto.cordura}`, 'efecto');
                    }
                    
                    // Posible reacción del público
                    this.reaccionPublico('desprecio');
                }
                
                // Verificar si se activa bonificación crítica
                this.verificarBonificacionCritica();
                
                // Mostrar estados actualizados
                this.mostrarMensajeLog(`Moral actual: ${this.moral_grupo}/${this.estados_config.limites.moral_max}`, 'center');
                this.mostrarMensajeLog(`Cordura actual: ${this.cordura}/${this.estados_config.limites.cordura_max}`, 'center');
            }
            
            reaccionPublico(tipo) {
                const reacciones = this.comportamiento.reacciones_publico[tipo];
                if (!reacciones) return;
                
                // Elegir una reacción aleatoria
                const reaccion = reacciones[Math.floor(Math.random() * reacciones.length)];
                
                // Mostrar la reacción del público
                this.mostrarMensajeLog(reaccion.efecto, 'publico');
                
                // Aplicar efectos adicionales si los hay
                if (reaccion.efecto_adicional) {
                    for (const [estado, valor] of Object.entries(reaccion.efecto_adicional)) {
                        if (estado === 'moral') {
                            this.moral_grupo = Math.min(this.estados_config.limites.moral_max, this.moral_grupo + Number(valor));
                            this.mostrarMensajeLog(`Moral ${valor > 0 ? '+' : ''}${valor}`, 'efecto');
                        } else if (estado === 'cordura') {
                            this.cordura = Math.min(this.estados_config.limites.cordura_max, this.cordura + Number(valor));
                            this.mostrarMensajeLog(`Cordura ${valor > 0 ? '+' : ''}${valor}`, 'efecto');
                        }
                    }
                }
            }
            
            verificarBonificacionCritica() {
                // Verificar si se activa la bonificación crítica (3 acciones del mismo tipo)
                if (this.acciones_heroicas >= 3 && !this.bonif_critico) {
                    this.bonif_critico = true;
                    this.mostrarMensajeLog('\n¡BONIFICACIÓN CRÍTICA ACTIVADA!', 'critical');
                    this.mostrarMensajeLog('Tres acciones heroicas consecutivas', 'heroico');
                    this.mostrarMensajeLog('+2 a todos los atributos en recompensas finales', 'efecto');
                } else if (this.acciones_deshonrosas >= 3 && !this.bonif_critico) {
                    this.bonif_critico = true;
                    this.mostrarMensajeLog('\n¡PENALIZACIÓN CRÍTICA ACTIVADA!', 'critical');
                    this.mostrarMensajeLog('Tres acciones deshonrosas consecutivas', 'deshonroso');
                    this.mostrarMensajeLog('-2 a todos los atributos en recompensas finales', 'efecto');
                }
            }
            
            finalizarArena() {
                this.mostrarMensajeLog('\n=== FINAL DE LA ARENA ===', 'titulo');
                
                // Determinar recompensas según nivel
                let recompensa_config = null;
                if (this.heroes_nivel === "1_2") {
                    recompensa_config = this.recompensas.nivel_1_2;
                } else if (this.heroes_nivel === "3_4") {
                    recompensa_config = this.recompensas.nivel_3_4;
                } else if (this.heroes_nivel === "5_6") {
                    recompensa_config = this.recompensas.nivel_5_6;
                } else if (this.heroes_nivel === "7_8") {
                    recompensa_config = this.recompensas.nivel_7_8;
                }
                
                if (recompensa_config) {
                    // Calcular recompensas base
                    let monedas_base = recompensa_config.monedas;
                    let experiencia_base = recompensa_config.experiencia;
                    
                    // Aplicar bonificación/penalización crítica
                    if (this.bonif_critico) {
                        if (this.acciones_heroicas >= 3) {
                            monedas_base += 2;
                            experiencia_base += 2;
                        } else if (this.acciones_deshonrosas >= 3) {
                            monedas_base = Math.max(0, monedas_base - 2);
                            experiencia_base = Math.max(0, experiencia_base - 2);
                        }
                    }
                    
                    // Calcular ganancia de apuesta si existe
                    let ganancia_apuesta = 0;
                    if (this.apuesta_activa) {
                        ganancia_apuesta = Math.floor(this.apuesta_monedas * recompensa_config.multiplicador_monedas);
                    }
                    
                    // Mostrar recompensas en el log principal
                    this.mostrarMensajeLog('\n=== RECOMPENSAS ===', 'titulo');
                    this.mostrarMensajeLog(`Monedas: ${monedas_base}`, 'recompensa');
                    this.mostrarMensajeLog(`Experiencia: ${experiencia_base}`, 'recompensa');
                    
                    if (this.apuesta_activa) {
                        this.mostrarMensajeLog(`Ganancia por apuesta: ${ganancia_apuesta} monedas`, 'apuesta');
                        this.mostrarMensajeLog(`Total monedas: ${monedas_base + ganancia_apuesta}`, 'recompensa');
                    }
                    
                    // Mostrar tesoros
                    if (recompensa_config.tesoros && recompensa_config.tesoros.length > 0) {
                        this.mostrarMensajeLog('Tesoros obtenidos:', 'recompensa');
                        for (const tesoro of recompensa_config.tesoros) {
                            this.mostrarMensajeLog(`• ${tesoro}`, 'lista');
                        }
                    }
                    
                    // Mostrar recompensas en el log de recompensas
                    this.mostrarRecompensasEnLogDedicado(monedas_base, experiencia_base, ganancia_apuesta, recompensa_config.tesoros);
                }
                
                // Deshabilitar botones de acciones
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                
                // Habilitar botón de reinicio
                document.getElementById('btn-iniciar').disabled = false;
            }
            
            mostrarRecompensasEnLogDedicado(monedas, experiencia, ganancia_apuesta, tesoros) {
                const rewardLog = document.getElementById('reward-log');
                if (!rewardLog) return;
                
                // Limpiar log anterior
                rewardLog.innerHTML = '';
                
                // Crear contenido de recompensas
                const titulo = document.createElement('div');
                titulo.className = 'log-titulo';
                titulo.textContent = 'RECOMPENSAS OBTENIDAS';
                rewardLog.appendChild(titulo);
                
                const monedasElem = document.createElement('div');
                monedasElem.className = 'log-recompensa';
                monedasElem.textContent = `Monedas: ${monedas}`;
                rewardLog.appendChild(monedasElem);
                
                const expElem = document.createElement('div');
                expElem.className = 'log-recompensa';
                expElem.textContent = `Experiencia: ${experiencia}`;
                rewardLog.appendChild(expElem);
                
                if (ganancia_apuesta > 0) {
                    const apuestaElem = document.createElement('div');
                    apuestaElem.className = 'log-apuesta';
                    apuestaElem.textContent = `Apuesta: +${ganancia_apuesta}`;
                    rewardLog.appendChild(apuestaElem);
                    
                    const totalElem = document.createElement('div');
                    totalElem.className = 'log-recompensa';
                    totalElem.textContent = `Total: ${monedas + ganancia_apuesta}`;
                    rewardLog.appendChild(totalElem);
                }
                
                if (tesoros && tesoros.length > 0) {
                    const tesorosTitulo = document.createElement('div');
                    tesorosTitulo.className = 'log-recompensa';
                    tesorosTitulo.textContent = 'Tesoros:';
                    rewardLog.appendChild(tesorosTitulo);
                    
                    for (const tesoro of tesoros) {
                        const tesoroElem = document.createElement('div');
                        tesoroElem.className = 'log-lista';
                        tesoroElem.textContent = `• ${tesoro}`;
                        rewardLog.appendChild(tesoroElem);
                    }
                }
                
                // Mostrar el log de recompensas
                rewardLog.style.display = 'block';
                this.reward_log_visible = true;
            }
            
            mostrarReglas() {
                this.mostrarMensajeLog('\n=== REGLAS DE LA ARENA ===', 'titulo');
                this.mostrarMensajeLog('1. Selecciona nivel (1-10) y apuesta (0-500 monedas)', 'lista');
                this.mostrarMensajeLog('2. Inicia la arena y enfrenta 3 rondas de enemigos', 'lista');
                this.mostrarMensajeLog('3. Usa acciones heroicas o deshonrosas para afectar moral/cordura', 'lista');
                this.mostrarMensajeLog('4. Tras cada ronda, los héroes descansan y recuperan atributos', 'lista');
                this.mostrarMensajeLog('5. Al finalizar, obtén recompensas según tu desempeño', 'lista');
                this.mostrarMensajeLog('\nDesarrollado por José Manuel Arena y Omar Nieto (DETION)', 'center');
            }
        }
        
        // Inicializar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            window.arenaApp = new ArenaApp();
        });
    </script>
</body>
</html>
[file content end]
