<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DETION ARENA: LEAGUE OF DUNGEONEERS</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #2D2D2D;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        /* Contenedor principal */
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Contenedor del panel de nivel con fondo */
        #nivel-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            /*width: 300px;
            height: 300px;*/
            z-index: 0;
        }

        /* Contenedor del panel de apuesta con fondo */
        #apuesta-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            /*width: 300px;
            height: 300px;*/
            z-index: 0;
        }

        #log-container {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                /*width: 600px;
                height: 300px;*/
                z-index: 5;
                display: flex;
                justify-content: center;
                align-items: center;
                /* background-image: url('assets/imagenes/pergamino.png'), url('https://placehold.co/600x300/DDD/000/png?text=PERGAMINO'); */
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
            }

        /* Ajustar el event-log dentro del contenedor - CORREGIDO */
        #event-log {
            position: relative;
            background-color: transparent;
            margin: 5px 0;
            color: black;
            border: none;
            text-align: center;
            overflow: auto;
            padding: 30px;
            width: 80%;
            height: 70%;
            font-size: 14px;
            z-index: 6;

         }
        /* Ajustar el panel de nivel dentro del contenedor */
        #nivel-panel {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            z-index: 2;
            margin-top: 20px;
        }
        
        /* Ajustar el panel de apuesta dentro del contenedor */
        #apuesta-panel {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            z-index: 2;
            margin-top: 20px;
        }
        
        /* Fondo */
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1;
        }
        
        /* Panel de configuración */
        .config-panel {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .config-label {
            background-color: transparent;
            color: black;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        
        /* Botones */
        .btn {
            background-color: #2D2D2D;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .btn:hover {
            background-color: #3D3D3D;
        }
        
        .btn:disabled {
            background-color: #555555;
            cursor: not-allowed;
        }
        
        /* Botones principales */
        #main-buttons {
            position: absolute;
            display: flex;
            gap: 12%;
            width: 70%;
            justify-content: center;
            z-index: 10;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Estilos de texto para diferentes tipos de mensajes */
        .log-titulo {
            color: #000000;
            font-weight: bold;
        }
        
        .log-recompensa {
            color: #006400;
        }
        
        .log-enemigo {
            color: #8B0000;
            font-weight: bold;
        }
        
        .log-lista {
            color: #000000;
        }
        
        .log-ronda {
            color: #000000;
            font-weight: bold;
        }
        
        .log-heroico {
            color: #006400;
            font-weight: bold;
        }
        
        .log-deshonroso {
            color: #8B0000;
            font-weight: bold;
        }
        
        .log-publico {
            color: #000000;
            font-style: italic;
        }
        
        .log-efecto {
            color: #000000;
        }
        
        .log-critical {
            color: #8B0000;
            font-weight: bold;
            animation: blink 0.5s infinite;
        }
        
        .log-apuesta {
            color: #006400;
            font-weight: bold;
        }
        
        .log-center {
            color: #000000;
        }
        
        .log-speaker {
            color: #8B4513;
            font-weight: bold;
            font-style: italic;
        }
        
        .log-blink {
            animation: blink 0.5s infinite;
        }
        
        @keyframes blink {
            0% { color: #8b0000; }
            50% { color: #FFCCCB; }
            100% { color: #8b0000; }
        }
        
    </style>
</head>
<body>
    <!-- Overlay para activar audio -->
    <div id="music-overlay">
        <p>¡Bienvenido a DETION ARENA!</p>
        <p>Haz clic para activar la música de fondo</p>
        <button id="start-audio">Activar Música</button>
    </div>

    <!-- Fondo -->
    <div id="background"></div>

    <!-- Contenedor del log con fondo de pergamino - ÚNICO CONTENEDOR -->
    <div id="log-container">
        <div id="event-log"></div>
    </div>
        
    <!-- Panel de nivel -->
    <div id="nivel-container">
        <div id="nivel-panel" class="config-panel">
            <button id="btn-nivel-down" class="btn"></button>
            <div id="nivel-label" class="config-label">1</div>
            <button id="btn-nivel-up" class="btn"></button>
        </div>
    </div>

    <!-- Panel de apuesta (SOLO UNO) -->
    <div id="apuesta-container">
        <div id="apuesta-panel" class="config-panel">
            <button id="btn-apuesta-down" class="btn"></button>
            <div id="apuesta-label" class="config-label">0</div>
            <button id="btn-apuesta-up" class="btn"></button>
        </div>
    </div>
        
    <!-- Botones principales -->
    <div id="main-buttons">
        <button id="btn-iniciar" class="btn"></button>
        <button id="btn-ronda" class="btn" disabled></button>
        <button id="btn-heroico" class="btn" disabled></button>
        <button id="btn-deshonroso" class="btn" disabled></button>
        <button id="btn-musica-on" class="btn"></button>
        <button id="btn-musica-off" class="btn" style="display:none;"></button>
        <button id="btn-reiniciar" class="btn"></button>
        <button id="btn-reglas" class="btn"></button>
    </div>

    <script>
        // Clase principal de la aplicación
        class ArenaApp {
            constructor() {
                this._setupAttributes();
                this.init();  
            }
            
            _setupAttributes() {
                // Rutas base
                this.BASE_DIR = window.location.href.replace(/\/[^\/]*$/, '');
                this.IMAGES_DIR = `${this.BASE_DIR}/assets/imagenes`;
                this.AUDIO_DIR = `${this.BASE_DIR}/assets/audio`;
                this.DATA_DIR = `${this.BASE_DIR}/assets/data`;
                
                // Configuraciones
                this.ui_config = null;
                this.estados_config = null;
                this.descansos = null;
                this.recompensas = null;
                this.comportamiento = null;
                
                // Estado del juego
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.moral_grupo = 0;
                this.cordura = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
                
                // Control de música
                this.musica_activada = true;
                this.audioContext = null;
                this.audioElement = null;
                this.audioGain = null;
                
                // Valores de configuración
                this.nivel_valor = 1;
                this.apuesta_valor = 0;
                
                // Efectos
                this.blink_state = false;
                this.blink_interval = null;
                
                // Factores de escala (basado en 1920x1080)
                this.base_width = 1920;
                this.base_height = 1080;
                this.width_scale = 1.0;
                this.height_scale = 1.0;
                this.scale_factor = 1.0;
            }
            
            async init() {
                try {
                    await this.cargarConfiguraciones();
                    this.inicializarUI();
                    this.inicializarEstados();
                    this.inicializarMusica();
                    this.mostrarMensajeBienvenida();
                    this.iniciarEfectoParpadeo();
                    this.configurarEventos();
                    
                    // Configurar evento de redimensionamiento
                    window.addEventListener('resize', () => {
                        this.calcularFactoresEscala();
                        this.aplicarEscaladoCompleto();
                    });
                    
                    // Calcular factores iniciales
                    this.calcularFactoresEscala();
                    this.aplicarEscaladoCompleto();
                    
                } catch (error) {
                    console.error("Error inicializando la aplicación:", error);
                    this.mostrarMensajeLog(`Error al inicializar: ${error.message}`, 'enemigo');
                }
            }
            
            calcularFactoresEscala() {
                this.width_scale = window.innerWidth / this.base_width;
                this.height_scale = window.innerHeight / this.base_height;
                this.scale_factor = Math.min(this.width_scale, this.height_scale);
            }
            
            aplicarEscaladoCompleto() {
                // Ajustar tamaño de botones
                const btnSize = Math.max(40, Math.min(80, 80 * this.scale_factor));
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.style.width = `${btnSize}px`;
                    btn.style.height = `${btnSize}px`;
                });
                
                // Ajustar tamaño de etiquetas
                const labelFontSize = Math.max(30, Math.min(50, 50 * this.scale_factor));
                document.querySelectorAll('.config-label').forEach(label => {
                    label.style.fontSize = `${labelFontSize}px`;
                    label.style.minWidth = `${btnSize}px`;
                });
                
                // Ajustar log de eventos
                const eventLog = document.getElementById('event-log');
                if (eventLog) {
                    const logWidth = Math.max(600, Math.min(1000, 1000 * this.scale_factor));
                    const logHeight = Math.max(180, Math.min(300, 300 * this.scale_factor));
                    const fontSize = Math.max(10, Math.min(14, 14 * this.scale_factor));
                    
                    eventLog.style.width = `${logWidth}px`;
                    eventLog.style.height = `${logHeight}px`;
                    eventLog.style.fontSize = `${fontSize}px`;
                }
                
                // Ajustar tamaño del contenedor de nivel
                const nivelContainer = document.getElementById('nivel-container');
                if (nivelContainer) {
                    const containerSize = Math.max(200, Math.min(300, 250 * this.scale_factor));
                    nivelContainer.style.width = `${containerSize}px`;
                    nivelContainer.style.height = `${containerSize}px`;
                    nivelContainer.style.backgroundImage = `url('${this.IMAGES_DIR}/heroes.png'), url('https://placehold.co/250x250/555555/FFFFFF/png?text=HEROES')`;
                }
                
                // Ajustar tamaño del contenedor de apuesta
                const apuestaContainer = document.getElementById('apuesta-container');
                if (apuestaContainer) {
                    const containerSize = Math.max(200, Math.min(300, 250 * this.scale_factor));
                    apuestaContainer.style.width = `${containerSize}px`;
                    apuestaContainer.style.height = `${containerSize}px`;
                    apuestaContainer.style.backgroundImage = `url('${this.IMAGES_DIR}/recompensas.png'), url('https://placehold.co/250x250/555555/FFFFFF/png?text=RECOMPENSAS')`;
                }
                
                // Ajustar tamaño del contenedor de log - CORREGIDO
                const logContainer = document.getElementById('log-container');
                if (logContainer) {
                    const containerWidth = Math.max(400, Math.min(600, 600 * this.scale_factor));
                    const containerHeight = Math.max(200, Math.min(300, 300 * this.scale_factor));
                    logContainer.style.width = `${containerWidth}px`;
                    logContainer.style.height = `${containerHeight}px`;
                    //logContainer.style.backgroundImage = `url('${this.IMAGES_DIR}/pergamino.png'), url('https://placehold.co/600x300/DDD/000/png?text=PERGAMINO')`;
                    
                }

                // Reposicionar elementos
                this.reposicionarElementos();
            }
            
            reposicionarElementos() {
                // Definir posiciones relativas (proporciones de 0 a 1)
                const positions = {
                    'nivel-container': { x: 0.106, y: 0.43 },
                    'apuesta-container': { x: 0.846, y: 0.43 },
                    
                };
                
                // Posicionar elementos
                for (const [id, pos] of Object.entries(positions)) {
                    const element = document.getElementById(id);
                    if (element) {
                        const x = window.innerWidth * pos.x;
                        const y = window.innerHeight * pos.y;
                        element.style.left = `${x}px`;
                        element.style.top = `${y}px`;
                        element.style.transform = 'translate(-50%, -50%)';
                    }
                }
            }
            
            async cargarConfiguraciones() {
                try {
                    // Cargar configuraciones desde archivos JSON
                    const configFiles = [
                        'ui_config.json',
                        'estados.json',
                        'descansos.json',
                        'recompensas.json',
                        'comportamiento.json'
                    ];
                    
                    const [uiConfig, estadosConfig, descansosConfig, recompensasConfig, comportamientoConfig] = await Promise.all(
                        configFiles.map(file => 
                            fetch(`${this.DATA_DIR}/${file}`)
                                .then(response => {
                                    if (!response.ok) throw new Error(`No se pudo cargar ${file}`);
                                    return response.json();
                                })
                                .catch(error => {
                                    console.error(`Error cargando ${file}:`, error);
                                    // Usar configuraciones por defecto si hay error
                                    return {};
                                })
                        )
                    );
                    
                    this.ui_config = uiConfig || {};
                    this.estados_config = estadosConfig || {limites: {moral_max: 100, cordura_max: 100}};
                    this.descansos = descansosConfig || {};
                    this.recompensas = recompensasConfig || {};
                    this.comportamiento = comportamientoConfig || {};
                    
                    // Cargar encuentros según el nivel
                    await this.cargarEncuentros();
                    
                } catch (e) {
                    console.error("Error cargando configuraciones:", e);
                    this.mostrarMensajeLog(`Error: ${e.message}`, 'enemigo');
                    // Usar configuraciones por defecto
                    this.ui_config = {};
                    this.estados_config = {limites: {moral_max: 100, cordura_max: 100}};
                    this.descansos = {};
                    this.recompensas = {};
                    this.comportamiento = {};
                }
            }
            
            async cargarEncuentros() {
                try {
                    // Determinar archivo según nivel
                    let archivoEncuentros = '';
                    if (this.nivel_valor <= 2) {
                        archivoEncuentros = 'nivel_1_2.json';
                    } else if (this.nivel_valor <= 4) {
                        archivoEncuentros = 'nivel_3_4.json';
                    } else if (this.nivel_valor <= 6) {
                        archivoEncuentros = 'nivel_5_6.json';
                    } else {
                        archivoEncuentros = 'nivel_7_8.json';
                    }
                    
                    const response = await fetch(`${this.DATA_DIR}/encuentros/${archivoEncuentros}`);
                    if (!response.ok) throw new Error(`No se pudo cargar ${archivoEncuentros}`);
                    
                    this.encuentros = await response.json();
                } catch (e) {
                    console.error("Error cargando encuentros:", e);
                    this.mostrarMensajeLog(`No se pudo cargar los encuentros: ${e.message}`, 'enemigo');
                    this.encuentros = {};
                }
            }
            
            inicializarUI() {
                // Cargar imágenes de botones
                this.cargarImagenesBotones();
                
                // Configurar eventos de botones
                this.configurarEventosBotones();
                
                // Cargar fondo
                this.cargarFondo();
            }
            
            cargarImagenesBotones() {
                // Configurar botones con imágenes
                const botonesConfig = {
                    'btn-nivel-down': 'btn_nivel_down.png',
                    'btn-nivel-up': 'btn_nivel_up.png',
                    'btn-apuesta-down': 'btn_apuesta_down.png',
                    'btn-apuesta-up': 'btn_apuesta_up.png',
                    'btn-iniciar': 'btn_iniciar.png',
                    'btn-ronda': 'btn_ronda.png',
                    'btn-heroico': 'btn_heroico.png',
                    'btn-deshonroso': 'btn_deshonroso.png',
                    'btn-musica-on': 'btn_con_musica.png',
                    'btn-musica-off': 'btn_sin_musica.png',
                    'btn-reiniciar': 'btn_reiniciar.png',
                    'btn-reglas': 'btn_reglas.png'
                };
                
                for (const [id, imagen] of Object.entries(botonesConfig)) {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.style.backgroundImage = `url('${this.IMAGES_DIR}/${imagen}')`;
                    }
                }
            }
            
            configurarEventosBotones() {
                // Botones de nivel
                document.getElementById('btn-nivel-up').addEventListener('click', () => this.incrementarNivel());
                document.getElementById('btn-nivel-down').addEventListener('click', () => this.decrementarNivel());
                
                // Botones de apuesta
                document.getElementById('btn-apuesta-up').addEventListener('click', () => this.incrementarApuesta());
                document.getElementById('btn-apuesta-down').addEventListener('click', () => this.decrementarApuesta());
                
                // Botones principales
                document.getElementById('btn-iniciar').addEventListener('click', () => this.iniciarArena());
                document.getElementById('btn-ronda').addEventListener('click', () => this.siguienteRonda());
                document.getElementById('btn-heroico').addEventListener('click', () => this.evaluarAccion('heroica'));
                document.getElementById('btn-deshonroso').addEventListener('click', () => this.evaluarAccion('deshonrosa'));
                document.getElementById('btn-reiniciar').addEventListener('click', () => this.reiniciarArena());
                document.getElementById('btn-reglas').addEventListener('click', () => this.mostrarReglas());
                
                // Botones de música
                document.getElementById('btn-musica-on').addEventListener('click', () => this.desactivarMusica());
                document.getElementById('btn-musica-off').addEventListener('click', () => this.activarMusica());
            }
            
            cargarFondo() {
                const fondo = document.getElementById('background');
                fondo.style.backgroundImage = `url('${this.IMAGES_DIR}/fondo.png')`;
            }
            
            inicializarEstados() {
                // Usar valores de configuración si están disponibles
                const limites = this.estados_config.limites || {};
                this.moral_grupo = limites.moral_max || 10;
                this.cordura = limites.cordura_max || 10;
                
                // Reiniciar otros estados
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
            }
            
            inicializarMusica() {
                // Inicializar música
                this.audioElement = new Audio(`${this.AUDIO_DIR}/musica_fondo.mp3`);
                this.audioElement.loop = true;
                this.audioElement.volume = 0.7;
                
                // Reproducir automáticamente (puede que necesites agregar esto para algunos navegadores)
                this.audioElement.play().catch(e => {
                    console.log("La reproducción automática fue prevenida:", e);
                    // En algunos navegadores puede ser necesario esperar a la interacción del usuario
                });
            }
            
            mostrarMensajeBienvenida() {
                this.mostrarMensajeLog("\n=== BIENVENIDO A LA ARENA DE LORAINIA ===", 'titulo');
                this.mostrarMensajeLog("¡Atención, ciudadanos de Lorainia! Aventureros de las Tierras Antiguas,\n"
                                     + "estáis bajo la atenta mirada de los dioses y del gran rey Logan III. Aquí hallaréis muerte o gloria.", 'publico');
                this.mostrarMensajeLog("Reglamento escrito por José Manuel Arena v1.4 y aplicacion por Omar Nieto (DETION)", 'enemigo');
            }
            
            iniciarEfectoParpadeo() {
                this.blink_interval = setInterval(() => {
                    this.blink_state = !this.blink_state;
                }, 500);
            }
            
            configurarEventos() {
                // Ya configurado en configurarEventosBotones()
            }
            
            incrementarNivel() {
                if (this.nivel_valor < 10) {
                    this.nivel_valor++;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                }
            }
            
            decrementarNivel() {
                if (this.nivel_valor > 1) {
                    this.nivel_valor--;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                }
            }
            
            incrementarApuesta() {
                if (this.apuesta_valor < 500) {
                    this.apuesta_valor = Math.min(500, this.apuesta_valor + 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            decrementarApuesta() {
                if (this.apuesta_valor > 0) {
                    this.apuesta_valor = Math.max(0, this.apuesta_valor - 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            mostrarMensajeLog(mensaje, tipo) {
                const eventLog = document.getElementById('event-log');
                const p = document.createElement('p');
                p.className = `log-${tipo}`;
                p.textContent = mensaje;
                eventLog.appendChild(p);
                
                // Scroll al final
                eventLog.scrollTop = eventLog.scrollHeight;
            }
            
            activarMusica() {
                this.musica_activada = true;
                document.getElementById('btn-musica-off').style.display = 'none';
                document.getElementById('btn-musica-on').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.play().catch(e => {
                        console.log("Error al reactivar música:", e);
                    });
                }
            }
            
            desactivarMusica() {
                this.musica_activada = false;
                document.getElementById('btn-musica-on').style.display = 'none';
                document.getElementById('btn-musica-off').style.display = 'block';
                
                if (this.audioElement) {
                    this.audioElement.pause();
                }
            }
            
            reiniciarArena() {
                const eventLog = document.getElementById('event-log');
                eventLog.innerHTML = '';
                
                this.inicializarEstados();
                
                // Reiniciar estados de botones
                document.getElementById('btn-iniciar').disabled = false;
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                
                // Reactivar música si estaba activa
                if (this.musica_activada && this.audioElement) {
                    this.audioElement.play().catch(e => {
                        console.log("Error al reactivar música:", e);
                    });
                }
                
                this.mostrarMensajeBienvenida();
                this.mostrarMensajeLog("\n=== ARENA REINICIADA ===", 'titulo');
            }
            
            async iniciarArena() {
                const nivel = this.nivel_valor;
                const apuesta = this.apuesta_valor;
                
                try {
                    if (apuesta < 0 || apuesta > 500) {
                        throw new Error("La apuesta debe estar entre 0 y 500");
                    }
                    
                    // Determinar nivel de héroes
                    if (nivel <= 2) {
                        this.heroes_nivel = "1_2";
                    } else if (nivel <= 4) {
                        this.heroes_nivel = "3_4";
                    } else if (nivel <= 6) {
                        this.heroes_nivel = "5_6";
                    } else {
                        this.heroes_nivel = "7_8";
                    }
                    
                    // Cargar encuentros para el nivel
                    await this.cargarEncuentros();
                    
                    if (Object.keys(this.encuentros).length === 0) {
                        throw new Error("No se pudieron cargar los encuentros para este nivel");
                    }
                    
                    this.apuesta_monedas = apuesta;
                    this.apuesta_activa = apuesta > 0;
                    
                    // Obtener el multiplicador de recompensas
                    const recompensa = this.recompensas[`nivel_${this.heroes_nivel}`] || {};
                    const multiplicador = recompensa.multiplicador_monedas || 1.0;
                    
                    // Mostrar mensaje del speaker sobre la apuesta
                    this.mostrarMensajeLog("\n«¡Atención, nobles espectadores!»", 'speaker');
                    
                    if (this.apuesta_activa) {
                        const ganancia_potencial = parseInt(this.apuesta_monedas * multiplicador);
                        this.mostrarMensajeLog(`«¡Nuestros valientes héroes han apostado ${this.apuesta_monedas} monedas!»`, 'speaker');
                        this.mostrarMensajeLog(`«Si logran la victoria, obtendrán ${ganancia_potencial} monedas adicionales!»`, 'speaker');
                    } else {
                        this.mostrarMensajeLog("«¡Jajaja nuestros héroes no han apostado o eso quiere decir que solo les queda la vida!»", 'speaker');
                        this.mostrarMensajeLog("«¡Una muestra de valentía o tal vez de locura!»", 'speaker');
                    }
                    
                    this.mostrarMensajeLog("«¡Que comience el espectáculo!»", 'speaker');
                    
                    // Habilitar botones apropiados
                    document.getElementById('btn-iniciar').disabled = true;
                    document.getElementById('btn-ronda').disabled = false;
                    document.getElementById('btn-heroico').disabled = false;
                    document.getElementById('btn-deshonroso').disabled = false;
                    
                    this.mostrarMensajeLog(`\n=== HÉROES DE NIVEL ${this.heroes_nivel.replace('_', '-')} ===`, 'titulo');
                    if (this.apuesta_activa) {
                        this.mostrarMensajeLog(`¡Has apostado ${this.apuesta_monedas} monedas!`, 'apuesta');
                    } else {
                        this.mostrarMensajeLog("¡No has realizado ninguna apuesta!", 'apuesta');
                    }
                    
                    this.ejecutarRonda(1);
                    
                } catch (error) {
                    console.error("Error iniciando arena:", error);
                    this.mostrarMensajeLog(`No se pudo iniciar la arena: ${error.message}`, 'enemigo');
                    document.getElementById('btn-iniciar').disabled = false;
                }
            }
            
            ejecutarRonda(ronda) {
                this.ronda_actual = ronda;
                const tipo_ronda = ronda === 1 ? "Calentamiento" : ronda === 2 ? "Desafío" : "Jefe Final";
                
                // MOSTRAR DESCANSO CORTO AL INICIO DE RONDAS 2 Y 3
                if (ronda === 2 || ronda === 3) {
                    this.mostrarDescansoCorto();
                }
                
                const encuentros_ronda = this.encuentros[`ronda_${ronda}`];
                if (!encuentros_ronda) {
                    this.mostrarMensajeLog(`No se encontraron encuentros para la ronda ${ronda}`, 'enemigo');
                    return;
                }
                
                const tirada = Math.floor(Math.random() * 100) + 1;
                
                for (const encuentro of encuentros_ronda) {
                    const [rango_min, rango_max] = encuentro.rango.split('-').map(Number);
                    if (tirada >= rango_min && tirada <= rango_max) {
                        this.encuentro_actual = encuentro.enemigos;
                        break;
                    }
                }
                
                // Si no se encuentra encuentro, usar el último
                if (!this.encuentro_actual && encuentros_ronda.length > 0) {
                    this.encuentro_actual = encuentros_ronda[encuentros_ronda.length - 1].enemigos;
                }
                
                this.mostrarMensajeLog(`\n=== RONDA ${ronda}: ${tipo_ronda.toUpperCase()} ===`, 'ronda');
                this.mostrarMensajeLog(`Tirada: ${tirada}`, 'enemigo');
                this.mostrarEnemigos();
                this.bonif_critico = false;
            }

            // Añadir nuevo método para mostrar descanso corto
            mostrarDescansoCorto() {
                const descanso = this.descansos["corto"];
                
                if (!descanso) {
                    this.mostrarMensajeLog("No se encontró información de descanso corto", 'enemigo');
                    return;
                }
                
                this.mostrarMensajeLog("\n=== DESCANSO CORTO ===", 'titulo');
                this.mostrarMensajeLog(descanso.descripcion || "Los héroes toman un breve descanso", 'efecto');
                this.mostrarMensajeLog(`Duración: ${descanso.duracion}`, 'efecto');
                
                // Mostrar beneficios
                this.mostrarMensajeLog("\nBENEFICIOS:", 'titulo');
                if (descanso.beneficios && Array.isArray(descanso.beneficios)) {
                    descanso.beneficios.forEach(beneficio => {
                        this.mostrarMensajeLog(`• ${beneficio}`, 'lista');
                    });
                }
                
                // Aplicar efectos del descanso corto
                this.aplicarEfectosDescanso(descanso.efectos);
            }

            // Añadir método para aplicar efectos del descanso
            aplicarEfectosDescanso(efectos) {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                if (efectos.moral) {
                    this.moral_grupo = Math.min(moral_max, this.moral_grupo + efectos.moral);
                    this.mostrarMensajeLog(`\nMoral del grupo +${efectos.moral}`, 'recompensa');
                }
                
                if (efectos.cordura === "1d3") {
                    const recuperacionCordura = Math.floor(Math.random() * 3) + 1;
                    this.cordura = Math.min(cordura_max, this.cordura + recuperacionCordura);
                    this.mostrarMensajeLog(`Cordura +${recuperacionCordura} (1d3)`, 'recompensa');
                } else if (typeof efectos.cordura === "number") {
                    this.cordura = Math.min(cordura_max, this.cordura + efectos.cordura);
                    this.mostrarMensajeLog(`Cordura +${efectos.cordura}`, 'recompensa');
                }
                
                this.mostrarEstadosActuales();
            }
            
            mostrarEnemigos() {
                if (!this.encuentro_actual) {
                    this.mostrarMensajeLog("No hay enemigos en esta ronda", 'enemigo');
                    return;
                }
                
                const enemigos = this.encuentro_actual.split(" y ");
                this.mostrarMensajeLog("\nENEMIGOS EN LA ARENA:", 'enemigo');
                
                // Diccionario de iconos para tipos de enemigos
                const iconos_enemigos = {
                    "Hechicero": "🧙",
                    "Escudo": "🛡️", 
                    "Espada": "⚔️",
                    "Hacha": "⚔️"
                };
                
                for (const enemigo of enemigos) {
                    let icono = "🐺";  // Por defecto
                    for (const [tipo, emoji] of Object.entries(iconos_enemigos)) {
                        if (enemigo.includes(tipo)) {
                            icono = emoji;
                            break;
                        }
                    }
                    
                    this.mostrarMensajeLog(`${icono} ${enemigo.trim()}`, 'enemigo');
                }
            }
            
            evaluarAccion(tipo_accion) {
                // Deshabilitar ambos botones después de usar uno
                //document.getElementById('btn-heroico').disabled = true;
                //document.getElementById('btn-deshonroso').disabled = true;
                
                if (tipo_accion === "heroica") {
                    this.acciones_heroicas++;
                    this.actualizarEstados("heroica");
                } else {
                    this.acciones_deshonrosas++;
                    this.actualizarEstados("deshonrosa");
                }
                
                // Obtener reacción aleatoria del comportamiento.json
                const tipo_reaccion = tipo_accion === "heroica" ? "apoyo" : "desprecio";
                
                // Acceder correctamente a la estructura del JSON
                const reacciones_publico = this.comportamiento.reacciones_publico || {};
                const reacciones = reacciones_publico[tipo_reaccion] || [];
                
                if (reacciones.length > 0) {
                    const reaccion = reacciones[Math.floor(Math.random() * reacciones.length)];
                    this.mostrarMensajeLog(`\nLos héroes realizan una acción ${tipo_accion}:`, tipo_accion);
                    this.mostrarMensajeLog(`» ${reaccion.efecto}`, reaccion.id > 15 ? 'critical' : 'efecto');
                    
                    // Aplicar efectos especiales según el ID
                    this.aplicarEfectoPublico(reaccion.id, tipo_accion === "heroica");
                }
            
                
                // Mostrar estados actualizados
                this.mostrarEstadosActuales();
            }
            
            actualizarEstados(tipo_accion) {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                const cambios = this.estados_config[tipo_accion] || {};
                
                if (cambios.moral) {
                    this.moral_grupo = Math.max(0, Math.min(moral_max, this.moral_grupo + cambios.moral));
                }
                
                if (cambios.cordura) {
                    this.cordura = Math.max(0, Math.min(cordura_max, this.cordura + cambios.cordura));
                }
                
                if (cambios.bonif_critico) {
                    this.bonif_critico = true;
                    this.mostrarMensajeLog("¡BONIFICACIÓN POR CRÍTICO ACTIVADA!", 'critical');
                }
                
                // Mostrar estados actualizados
                this.mostrarEstadosActuales();
            }
            
            mostrarEstadosActuales() {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                this.mostrarMensajeLog(`\nESTADO ACTUAL:`, 'titulo');
                this.mostrarMensajeLog(`Moral del Grupo: ${this.moral_grupo}/${moral_max}`, 'efecto');
                this.mostrarMensajeLog(`Cordura: ${this.cordura}/${cordura_max}`, 'efecto');
                
                if (this.bonif_critico) {
                    this.mostrarMensajeLog("¡BONUS CRÍTICO ACTIVO!", 'critical');
                }
            }
            
            siguienteRonda() {
                if (this.ronda_actual >= 3) {
                    this.finalizarArena();
                    return;
                }
                
                // Habilitar botones de acción para la nueva ronda
                document.getElementById('btn-heroico').disabled = false;
                document.getElementById('btn-deshonroso').disabled = false;
                
                this.ejecutarRonda(this.ronda_actual + 1);
            }
            
            finalizarArena() {
                this.mostrarMensajeLog("\n=== ¡LA ARENA HA CONCLUIDO! ===", 'titulo');
                
                // Calcular victoria o derrota
                const victoria = this.moral_grupo > 0 && this.cordura > 0;
                
                if (victoria) {
                    this.mostrarMensajeLog("¡VICTORIA DE LOS HÉROES!", 'heroico');
                    this.procesarRecompensas();
                } else {
                    this.mostrarMensajeLog("DERROTA...", 'deshonroso');
                    this.mostrarMensajeLog("Los héroes han caído en la arena", 'enemigo');
                }
                
                // Deshabilitar botones de acción
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                document.getElementById('btn-iniciar').disabled = false;
            }
            
            procesarRecompensas() {
                const nivel_key = `nivel_${this.heroes_nivel}`;
                const recompensa = this.recompensas[nivel_key];
                
                if (!recompensa) {
                    this.mostrarMensajeLog("No se encontraron recompensas para este nivel", 'enemigo');
                    return;
                }
                
                // Calcular recompensa base
                let monedas_base = recompensa.monedas || 0;
                let experiencia_base = recompensa.experiencia || 0;
                
                // Aplicar multiplicador por apuesta si existe
                let multiplicador = 1.0;
                if (this.apuesta_activa && recompensa.multiplicador_monedas) {
                    multiplicador = recompensa.multiplicador_monedas;
                }
                
                // Calcular recompensa final
                const monedas_final = parseInt(monedas_base * multiplicador);
                const experiencia_final = experiencia_base;
                
                // Mostrar recompensas
                this.mostrarMensajeLog("\nRECOMPENSAS OBTENIDAS:", 'titulo');
                this.mostrarMensajeLog(`${monedas_final} monedas de oro`, 'recompensa');
                this.mostrarMensajeLog(`${experiencia_final} puntos de experiencia`, 'recompensa');
                
                // Mostrar log de recompensas si hay apuesta
                if (this.apuesta_activa) {
                    this.mostrarLogRecompensas(monedas_base, monedas_final, multiplicador);
                }
                
                // Procesar descanso
                this.procesarDescanso();
            }
            
            mostrarLogRecompensas(monedas_base, monedas_final, multiplicador) {
                // CORREGIDO: Usar this.apuesta_monedas que ya está definido
                this.mostrarMensajeLog("\nDESGLOSE DE RECOMPENSA:", 'titulo');
                this.mostrarMensajeLog(`Apuesta inicial: ${this.apuesta_monedas} monedas`, 'recompensa');
                this.mostrarMensajeLog(`Recompensa base: ${monedas_base} monedas`, 'recompensa');
                this.mostrarMensajeLog(`Multiplicador: x${multiplicador}`, 'recompensa');
                this.mostrarMensajeLog(`Ganancia por apuesta: ${monedas_final - monedas_base} monedas`, 'recompensa');
                this.mostrarMensajeLog(`TOTAL: ${monedas_final} monedas`, 'recompensa');
            }
            
            procesarDescanso() {
                const descanso = this.descansos[`nivel_${this.heroes_nivel}`];
                
                if (!descanso) {
                    this.mostrarMensajeLog("No se encontró información de descanso para este nivel", 'enemigo');
                    return;
                }
                
                this.mostrarMensajeLog("\nDESCANSO EN LA TABERNA:", 'titulo');
                this.mostrarMensajeLog(descanso.descripcion || "Los héroes descansan y se recuperan", 'efecto');
                
                if (descanso.recuperacion_moral) {
                    this.moral_grupo = Math.min(this.estados_config.limites?.moral_max || 100, 
                                               this.moral_grupo + descanso.recuperacion_moral);
                }
                
                if (descanso.recuperacion_cordura) {
                    this.cordura = Math.min(this.estados_config.limites?.cordura_max || 100, 
                                           this.cordura + descanso.recuperacion_cordura);
                }
                
                this.mostrarEstadosActuales();
            }
            
            mostrarReglas() {
                this.mostrarMensajeLog("\n=== REGLAS DE LA ARENA ===", 'titulo');
                this.mostrarMensajeLog("1. Selecciona el nivel de tus héroes (1-10)", 'lista');
                this.mostrarMensajeLog("2. Opcional: Apuesta monedas (0-500)", 'lista');
                this.mostrarMensajeLog("3. Haz clic en INICIAR para comenzar", 'lista');
                this.mostrarMensajeLog("4. En cada ronda, enfrentarás diferentes enemigos", 'lista');
                this.mostrarMensajeLog("5. Usa ACCIÓN HEROICA o DESHONROSA según la situación", 'lista');
                this.mostrarMensajeLog("6. Supera las 3 rondas para ganar", 'lista');
                this.mostrarMensajeLog("7. Si ganas, obtienes recompensas según tu apuesta", 'lista');
            }
        }

        // Inicializar la aplicación cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            window.arenaApp = new ArenaApp();
        });
    </script>
</body>
</html>