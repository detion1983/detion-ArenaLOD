<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DETION ARENA: LEAGUE OF DUNGEONEERS</title>
    <style>
        /* ESTILOS GENERALES */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: Arial, sans-serif; 
        }
        
        body { 
            background-color: #2D2D2D; 
            color: white; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw; 
        }
        
        /* CONTENEDOR PRINCIPAL */
        #app-container { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            display: flex; 
        }
        
        /* PANEL IZQUIERDO */
        #left-panel { 
            flex: 3; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* PANEL DERECHO */
        #right-panel { 
            flex: 2; 
            position: relative; 
            min-width: 300px; 
        }
        
        /* CONTENEDOR DEL LOG */
        #log-container { 
            position: absolute; 
            left: 5%; 
            top: 45%; 
            transform: translateY(-50%); 
            width: 55vw; 
            max-width: 1200px; 
            height: 45vw; 
            max-height: 700px; 
            z-index: 3; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background-image: url('assets/imagenes/pergamino.png'); 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: center; 
        }
        
        /* CONTENEDORES DE NIVEL Y APUESTA */
        #nivel-container { 
            position: absolute; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: center; 
            z-index: 3; 
            width: 13vw; 
            max-width: 150px; 
            height: 13vw; 
            max-height: 150px; 
            /* POSICIÓN MODIFICADA: más abajo que el valor original (38%) */
            top: 70%; 
        } 

        #apuesta-container { 
            position: absolute; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: center; 
            z-index: 3; 
            width: 13vw; 
            max-width: 150px; 
            height: 13vw; 
            max-height: 150px; 
            /* POSICIÓN MODIFICADA: más abajo que el valor original (38%) */
            top: 70%; 
        }
        
        /* CONTENEDOR DEL NIVEL DE ARENA */
        #nivel-arena-container { 
            position: absolute; 
            left: 10.6%; 
            /* POSICIÓN MODIFICADA: más abajo que el valor original (62%) */
            top: 68%; 
            transform: translateY(-40%); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 4; 
            width: auto; 
            min-width: 120px; 
            max-width: 150px; 
            white-space: nowrap; 
        }
        
        /* ETIQUETA DEL NIVEL DE ARENA */
        #nivel-arena-label { 
            background-color: rgba(139, 69, 19, 0.8); 
            color: gold; 
            font-weight: bold; 
            padding: 5px 10px; 
            border-radius: 5px; 
            text-align: center; 
            font-size: 1.2vw; 
            max-font-size: 16px; 
            border: 2px solid #8B4513; 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7); 
            white-space: nowrap; 
        }
        
        /* ESTILOS INDIVIDUALES PARA NIVEL Y APUESTA */
        #nivel-container { 
            left: 10.6%; 
            background-image: url('assets/imagenes/heroes.png'), url('https://placehold.co/250x250/555555/FFFFFF/png?text=HEROES'); 
            /* POSICIÓN MODIFICADA: más abajo que el valor original (38%) */
            top: 70%; 
        }
        
        #apuesta-container { 
            right: 10.6%; 
            background-image: url('assets/imagenes/recompensas.png'), url('https://placehold.co/250x250/555555/FFFFFF/png?text=RECOMPENSAS'); 
        }
        
        /* ÁREA DEL EVENT LOG */
        #event-log { 
            position: absolute; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -58%); 
            background-color: transparent; 
            margin: 5px 0; 
            color: black; 
            border: none; 
            text-align: center; 
            overflow: auto; 
            padding: 2.5%; 
            z-index: 6; 
            width: 45%; 
            height: 35%; 
            font-size: 1.5vw; 
            max-font-size: 14px; 
        }
        
        /* PANELES DE CONFIGURACIÓN */
        #nivel-panel, 
        #apuesta-panel { 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            z-index: 4; 
            margin-top: 20px; 
        }
        
        /* FONDO */
        #background { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-size: cover; 
            background-position: center; 
            z-index: -1; 
        }
        
        /* CLASES DE CONFIGURACIÓN */
        .config-panel { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        }
        
        .config-label { 
            background-color: transparent; 
            color: black; 
            font-weight: bold; 
            min-width: 80px; 
            text-align: center; 
            font-size: 2.6vw; 
            max-font-size: 50px; 
        }
        
        /* BOTONES */
        .btn { 
            background-color: #2D2D2D; 
            border: none; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: center; 
            width: 4.2vw; 
            max-width: 80px; 
            height: 4.2vw; 
            max-height: 80px; 
        }
        
        .btn:hover { 
            background-color: #3D3D3D; 
        }
        
        .btn:disabled { 
            background-color: #555555; 
            cursor: not-allowed; 
        }
        
        #main-buttons { 
            position: absolute; 
            display: flex; 
            gap: 2vw; 
            justify-content: center; 
            align-items: center;
            z-index: 10; 
            bottom: 3%; 
            left: 50%; 
            transform: translateX(-50%);
            width: auto;
            padding: 0.5vw 2vw;
            background-color: rgba(45, 45, 45, 0.8);
            border-radius: 12px;
            border: 2px solid #8B4513;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        /* ESTILOS DE TEXTO PARA LOGS */
        .log-titulo { 
            color: #000000; 
            font-weight: bold; 
        }
        
        .log-recompensa { 
            color: #006400; 
        }
        
        .log-enemigo { 
            color: #8B0000; 
            font-weight: bold; 
        }
        
        .log-lista { 
            color: #000000; 
        }
        
        .log-ronda { 
            color: #000000; 
            font-weight: bold; 
        }
        
        .log-heroico { 
            color: #006400; 
            font-weight: bold; 
        }
        
        .log-deshonroso { 
            color: #8B0000; 
            font-weight: bold; 
        }
        
        .log-publico { 
            color: #000000; 
            font-style: italic; 
        }
        
        .log-efecto { 
            color: #000000; 
        }
        
        .log-critical { 
            color: #8B0000; 
            font-weight: bold; 
            animation: blink 0.5s infinite; 
        }
        
        .log-apuesta { 
            color: #006400; 
            font-weight: bold; 
        }
        
        .log-center { 
            color: #000000; 
        }
        
        .log-speaker { 
            color: #8B4513; 
            font-weight: bold; 
            font-style: italic; 
        }
        
        .log-blink { 
            animation: blink 0.5s infinite; 
        }
        
        /* ANIMACIÓN DE PARPADEO */
        @keyframes blink { 
            0% { color: #8b0000; } 
            50% { color: #FFCCCB; } 
            100% { color: #8b0000; } 
        }
        
        /* CONTENEDOR DE LA CUADRICULA */
        #grid-container { 
            position: absolute; 
            cursor: move; 
            user-select: none; 
            top: 60%; 
            right: 40px; 
            transform: translateY(-40%); 
            width: 70vmin; 
            height: 50vmin; 
            background-image: url('assets/imagenes/arena_grid.png'); 
            background-size: cover; 
            background-position: center; 
            border: 3px solid #8B4513; 
            border-radius: 5px; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7); 
            z-index: 100; 
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.5s ease, visibility 0.5s; 
        }
        
        /* CONTENIDO DE LA CUADRICULA */
        #grid-content { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            grid-template-rows: repeat(6, 1fr); 
            gap: 2px; 
            padding: 1vmin; 
        }
        

        
        /* CELDAS DE LA CUADRICULA */
        .grid-cell { 
            background-color: rgba(139, 69, 19, 0.3); 
            border: 1px solid rgba(139, 69, 19, 0.5); 
            border-radius: 3px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
        }
        
        /* TOKENS DE ENEMIGOS */
        .enemy-token.normal { 
            width: 80%; 
            height: 80%; 
            border-radius: 5px; 
            display: flex; 
            align-items: end; 
            justify-content: center; 
            font-size: 1.8vmin; 
            font-weight: bold; 
            color: white; 
            text-shadow: 1px 1px 2px black; 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7); 
            animation: appear 0.5s ease-out; 
            cursor: pointer; 
            transition: transform 0.2s; 
            background-size:contain; 
            background-position: center; 
            background-repeat: no-repeat; 
            border: 2px solid #8B4513; 
        }
        
        .enemy-token.enorme { 
            font-size: 1.4vmin; 
            z-index: 3;
            display: flex; 
            align-items: end;
            border: 3px solid #8B4513;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.9);
            background-size: contain; 
            background-position: center; 
            background-repeat: no-repeat;
        }
        
        .enemy-token.extraenorme { 
            font-size: 1.2vmin; 
            z-index: 4;
            display: flex; 
            align-items: end; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 1); 
            background-size: contain; 
            background-position: center; 
            background-repeat: no-repeat;
        }
        
        .enemy-token:hover { 
            transform: scale(1.1); 
        }
        
        /* ANIMACIÓN DE APARICIÓN */
        @keyframes appear { 
            from { opacity: 0; transform: scale(0) rotate(-10deg); } 
            to { opacity: 1; transform: scale(1) rotate(0deg); } 
        }
        
        /* BOTÓN DE CERRAR CUADRICULA */
        #close-grid { 
            position: absolute; 
            display: none;
            top: -15px; 
            right: -15px; 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            background-color: #8B0000; 
            color: white; 
            border: 2px solid white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            cursor: pointer; 
            z-index: 101; 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7); 
        }
        
        #close-grid:hover { 
            background-color: #FF0000; 
            border: 4px solid #8B4513; 
        }
        
        /* MEDIA QUERIES PARA RESPONSIVIDAD */
        
        /* Pantallas grandes (más de 1200px) - ya están definidos los estilos base */
        
        /* Tablets (hasta 1200px) */
        @media (max-width: 1200px) { 
            #event-log { 
                font-size: 3vw; 
            } 
            
            .config-label { 
                font-size: 3vw; 
            } 
            
            #grid-container { 
                width: 45vmin; 
                height: 33.75vmin; 
            }
        }
        
        /* Tablets pequeñas y móviles en horizontal (hasta 768px) */
        @media (max-width: 768px) { 
            #app-container { 
                flex-direction: column; 
            }
            
            #right-panel { 
                height: 40vh; 
            }
            
            #grid-container { 
                position: relative; 
                top: 0; 
                right: 0; 
                transform: none; 
                margin: 10px auto; 
                width: 95vmin; 
                height: 71.25vmin; 
            }
            
            #titulo-container { 
                width: 95vw; 
                height: 45.6vw; 
                transform: translate(-50%, 0); 
                top: 5%; 
            }
            
            #log-container { 
                width: 95vw; 
                height: 28.5vw; 
            }
            
            #nivel-container, 
            #apuesta-container { 
                width: 20vw; 
                height: 20vw; 
                /* POSICIÓN MODIFICADA para dispositivos móviles */
                top: 42%; 
            }
            
            #event-log { 
                font-size: 2.2vw; 
                padding: 5%; 
            }
            
            .config-label { 
                font-size: 4vw; 
            }
            
            .btn { 
                width: 6vw; 
                height: 6vw; 
            }
            
            #main-buttons { 
                gap: 3vw; 
                bottom: 2%; 
            }
            
            #nivel-arena-container { 
                width: auto; 
                min-width: 100px; 
                /* POSICIÓN MODIFICADA para dispositivos móviles */
                top: 72%; 
            }
            
            #nivel-arena-label { 
                font-size: 2vw; 
                white-space: nowrap; 
            }
            
            #nivel-container { 
                /* POSICIÓN MODIFICADA para dispositivos móviles */
                top: 38%; 
            }
        }
        
        /* Móviles (hasta 480px) */
        @media (max-width: 480px) { 
            #titulo-container { 
                width: 90vw; 
                height: 43.2vw; 
                transform: translate(-50%, 0); 
                top: 3%; 
            }
            
            #nivel-container, 
            #apuesta-container { 
                width: 25vw; 
                height: 25vw; 
                /* POSICIÓN MODIFICADA para móviles pequeños */
                top: 50%; 
            }
            
            #nivel-container { 
                left: 5%; 
            }
            
            #apuesta-container { 
                right: 5%; 
            }
            
            #event-log { 
                font-size: 2.5vw; 
            }
            
            .config-label { 
                font-size: 5vw; 
            }
            
            .btn { 
                width: 8vw; 
                height: 8vw; 
            }
            
            #main-buttons { 
                gap: 2vw; 
                bottom: 1%; 
            }
            
            #nivel-arena-container { 
                width: auto; 
                min-width: 80px; 
                /* POSICIÓN MODIFICADA para móviles pequeños */
                top: 75%; 
            }
            
            #nivel-arena-label { 
                font-size: 2.5vw; 
                white-space: nowrap; 
            }
            
            #nivel-container { 
                /* POSICIÓN MODIFICADA para móviles pequeños */
                top: 35%; 
            }
        }
    </style>
</head>
<body>
    <div id="background"></div>
    <div id="app-container">
        <div id="left-panel">
            <div id="log-container"><div id="event-log"></div></div>
            <div id="titulo-container"></div>
            <div id="nivel-container">
                <div id="nivel-panel" class="config-panel">
                    <button id="btn-nivel-up" class="btn"></button>
                    <div id="nivel-label" class="config-label">1</div>
                    <button id="btn-nivel-down" class="btn"></button>
                </div>
            </div>
            <div id="nivel-arena-container"><div id="nivel-arena-label">Nivel arena COBRE</div></div>
            <div id="apuesta-container">
                <div id="apuesta-panel" class="config-panel">
                    <button id="btn-apuesta-up" class="btn"></button>
                    <div id="apuesta-label" class="config-label">0</div>
                    <button id="btn-apuesta-down" class="btn"></button>
                </div>
            </div>
            <div id="main-buttons">
                <button id="btn-iniciar" class="btn"></button>
                <button id="btn-ronda" class="btn" disabled></button>
                <button id="btn-heroico" class="btn" disabled></button>
                <button id="btn-deshonroso" class="btn" disabled></button>
                <button id="btn-musica-on" class="btn"></button>
                <button id="btn-musica-off" class="btn" style="display:none;"></button>
                <button id="btn-reiniciar" class="btn"></button>
                <button id="btn-reglas" class="btn"></button>
            </div>
        </div>
        
        <div id="right-panel">
            <div id="grid-container">
                <div id="grid-content"></div>
            </div>
        </div>
    </div>

    <script>
        class ArenaApp {
            constructor() {
                this._setupAttributes();
                this.init();  
            }
            
            _setupAttributes() {
                this.BASE_DIR = window.location.href.replace(/\/[^\/]*$/, '');
                this.IMAGES_DIR = `${this.BASE_DIR}/assets/imagenes`;
                this.AUDIO_DIR = `${this.BASE_DIR}/assets/audio`;
                this.DATA_DIR = `${this.BASE_DIR}/assets/data`;
                this.TOKENS_DIR = `${this.BASE_DIR}/assets/tokens`;
                
                this.ui_config = null;
                this.estados_config = null;
                this.descansos = null;
                this.recompensas = null;
                this.comportamiento = null;
                
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.moral_grupo = 0;
                this.cordura = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
                this.exp_total_acumulada = 0;
                
                this.musica_activada = true;
                this.audioContext = null;
                this.audioElement = null;
                this.audioGain = null;
                
                this.nivel_valor = 1;
                this.apuesta_valor = 0;
                
                this.blink_state = false;
                this.blink_interval = null;
                
                this.gridVisible = false;
                this.enemyTokens = [];
                this.enemigosProcesados = [];
            }
            
            async init() {
                try {
                    await this.cargarConfiguraciones();
                    this.inicializarUI();
                    this.inicializarEstados();
                    this.inicializarMusica();
                    this.mostrarMensajeBienvenida();
                    this.iniciarEfectoParpadeo();
                    this.configurarEventos();
                    
                    window.addEventListener('resize', () => this.ajustarUIResponsive());
                    this.ajustarUIResponsive();
                    this.inicializarGrid();
                    this.actualizarNivelArena();
                } catch (error) {
                    console.error("Error inicializando la aplicación:", error);
                    this.mostrarMensajeLog(`Error al inicializar: ${error.message}`, 'enemigo');
                }
            }
            
            inicializarGrid() {
                const gridContainer = document.getElementById('grid-container');
                const closeButton = document.getElementById('close-grid');
                
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                
                const gridContent = document.getElementById('grid-content');
                for (let i = 0; i < 48; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = i;
                    gridContent.appendChild(cell);
                }
                
                closeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.ocultarGrid();
                });
                
                gridContainer.addEventListener('mousedown', (e) => {
                    if (e.target === gridContainer || e.target === gridContent) {
                        this.isDragging = true;
                        this.dragOffset = { x: e.clientX - gridContainer.offsetLeft, y: e.clientY - gridContainer.offsetTop };
                        gridContainer.style.cursor = 'grabbing';
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (this.isDragging) {
                        // Limitar el movimiento al área del panel derecho
                        const rightPanel = document.getElementById('right-panel');
                        const rightPanelRect = rightPanel.getBoundingClientRect();
                        const gridRect = gridContainer.getBoundingClientRect();
                        
                        let newLeft = e.clientX - this.dragOffset.x;
                        let newTop = e.clientY - this.dragOffset.y;
                        
                        // Limitar a los bordes del panel derecho
                        newLeft = Math.max(rightPanelRect.left, Math.min(newLeft, rightPanelRect.right - gridRect.width));
                        newTop = Math.max(rightPanelRect.top, Math.min(newTop, rightPanelRect.bottom - gridRect.height));
                        
                        gridContainer.style.left = newLeft + 'px';
                        gridContainer.style.top = newTop + 'px';
                        gridContainer.style.transform = 'none';
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    gridContainer.style.cursor = 'move';
                });
                
                gridContainer.addEventListener('touchstart', (e) => {
                    if (e.target === gridContainer || e.target === gridContent) {
                        this.isDragging = true;
                        const touch = e.touches[0];
                        this.dragOffset = { x: touch.clientX - gridContainer.offsetLeft, y: touch.clientY - gridContainer.offsetTop };
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (this.isDragging) {
                        const touch = e.touches[0];
                        
                        // Limitar el movimiento al área del panel derecho
                        const rightPanel = document.getElementById('right-panel');
                        const rightPanelRect = rightPanel.getBoundingClientRect();
                        const gridRect = gridContainer.getBoundingClientRect();
                        
                        let newLeft = touch.clientX - this.dragOffset.x;
                        let newTop = touch.clientY - this.dragOffset.y;
                        
                        // Limitar a los bordes del panel derecho
                        newLeft = Math.max(rightPanelRect.left, Math.min(newLeft, rightPanelRect.right - gridRect.width));
                        newTop = Math.max(rightPanelRect.top, Math.min(newTop, rightPanelRect.bottom - gridRect.height));
                        
                        gridContainer.style.left = newLeft + 'px';
                        gridContainer.style.top = newTop + 'px';
                        gridContainer.style.transform = 'none';
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('touchend', () => this.isDragging = false);
            }

            limpiarGrid() {
                this.enemyTokens.forEach(token => token.remove());
                this.enemyTokens = [];
                
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    while (cell.firstChild) cell.removeChild(cell.firstChild);
                });
            }
            
            mostrarGridConEnemigos(enemigos) {
                this.limpiarGrid();
                this.enemigosProcesados = enemigos;
                
                const gridContainer = document.getElementById('grid-container');
                
                const obtenerDimensiones = (tamano) => {
                    switch (tamano) {
                        case 'ENORME': return { ancho: 2, alto: 2 };
                        case 'EXTRAENORME': return { ancho: 3, alto: 2 };
                        default: return { ancho: 1, alto: 1 };
                    }
                };
                
                // Función para verificar si un área está disponible
                const areaDisponible = (inicioIndex, ancho, alto) => {
                    const inicioFila = Math.floor(inicioIndex / 8);
                    const inicioColumna = inicioIndex % 8;
                    
                    // Verificar que no se sale de los límites
                    if (inicioFila + alto > 6 || inicioColumna + ancho > 8) {
                        return false;
                    }
                    
                    // Verificar que todas las celdas del área estén disponibles
                    for (let fila = 0; fila < alto; fila++) {
                        for (let columna = 0; columna < ancho; columna++) {
                            const celdaIndex = (inicioFila + fila) * 8 + (inicioColumna + columna);
                            if (!posicionesDisponibles.includes(celdaIndex)) {
                                return false;
                            }
                        }
                    }
                    
                    return true;
                };
                
                // Función para reservar un área
                const reservarArea = (inicioIndex, ancho, alto) => {
                    const inicioFila = Math.floor(inicioIndex / 8);
                    const inicioColumna = inicioIndex % 8;
                    const celdasReservadas = [];
                    
                    for (let fila = 0; fila < alto; fila++) {
                        for (let columna = 0; columna < ancho; columna++) {
                            const celdaIndex = (inicioFila + fila) * 8 + (inicioColumna + columna);
                            const indexEnArray = posicionesDisponibles.indexOf(celdaIndex);
                            if (indexEnArray !== -1) {
                                posicionesDisponibles.splice(indexEnArray, 1);
                                celdasReservadas.push(celdaIndex);
                            }
                        }
                    }
                    
                    return celdasReservadas;
                };
                
                let posicionesDisponibles = Array.from({length: 48}, (_, i) => i);
                
                // Ordenar enemigos por tamaño (los más grandes primero)
                enemigos.sort((a, b) => {
                    const tamanoA = this.obtenerTamanoMonstruo(a.nombre);
                    const tamanoB = this.obtenerTamanoMonstruo(b.nombre);
                    
                    const prioridad = { "EXTRAENORME": 3, "ENORME": 2, "NORMAL": 1 };
                    return prioridad[tamanoB] - prioridad[tamanoA];
                });
                
                enemigos.forEach(enemigo => {
                    if (posicionesDisponibles.length === 0) return;
                    
                    const tamano = this.obtenerTamanoMonstruo(enemigo.nombre);
                    const dimensiones = obtenerDimensiones(tamano);
                    
                    for (let i = 0; i < enemigo.cantidad; i++) {
                        if (posicionesDisponibles.length === 0) break;
                        
                        let posicionValida = false;
                        let intentos = 0;
                        let posIndex, cellIndex;
                        
                        // Buscar una posición válida
                        while (!posicionValida && intentos < 100 && posicionesDisponibles.length > 0) {
                            posIndex = Math.floor(Math.random() * posicionesDisponibles.length);
                            cellIndex = posicionesDisponibles[posIndex];
                            
                            // Verificar si el área está disponible
                            posicionValida = areaDisponible(cellIndex, dimensiones.ancho, dimensiones.alto);
                            
                            if (!posicionValida) {
                                intentos++;
                                // Remover esta celda de las disponibles si no es válida
                                const indexToRemove = posicionesDisponibles.indexOf(cellIndex);
                                if (indexToRemove !== -1) {
                                    posicionesDisponibles.splice(indexToRemove, 1);
                                }
                            }
                        }
                        
                        if (!posicionValida) {
                            // Si no encontramos posición después de muchos intentos, saltamos este enemigo
                            console.warn(`No se pudo colocar al enemigo: ${enemigo.nombre}`);
                            continue;
                        }
                        
                        // Reservar el área completa
                        const celdasReservadas = reservarArea(cellIndex, dimensiones.ancho, dimensiones.alto);
                        
                        const inicioFila = Math.floor(cellIndex / 8);
                        const inicioColumna = cellIndex % 8;
                        
                        const token = document.createElement('div');
                        token.className = 'enemy-token';
                        token.classList.add(tamano.toLowerCase());
                        
                        // Obtener y establecer la imagen del token
                        const imagenToken = this.obtenerImagenToken(enemigo.nombre);
                        token.style.backgroundImage = `url('${imagenToken}')`;
                        
                        const cellWidth = 100 / 8;
                        const cellHeight = 100 / 6;
                        
                        token.style.position = 'absolute';
                        token.style.width = `${cellWidth * dimensiones.ancho}%`;
                        token.style.height = `${cellHeight * dimensiones.alto}%`;
                        token.style.left = `${inicioColumna * cellWidth}%`;
                        token.style.top = `${inicioFila * cellHeight}%`;
                        
                        token.textContent = this.obtenerAbreviatura(enemigo.nombre);
                        token.title = `${enemigo.nombre} (${tamano})`;
                        
                        document.getElementById('grid-content').appendChild(token);
                        this.enemyTokens.push(token);
                    }
                });
                
                document.getElementById('grid-container').classList.add('visible');
                this.gridVisible = true;
            }

            
            obtenerImagenToken(nombre) {
                if (!this.monstruos_imagenes || !this.monstruos_imagenes.mapeo_imagenes) {
                    return `${this.TOKENS_DIR}/default.png`;
                }
                
                // Primero, convertir a minúsculas y limpiar el nombre
                let nombreLimpio = nombre.toLowerCase().trim();
                
                // Si el nombre contiene un número al inicio, eliminarlo (ej: "2 lobos temibles" -> "lobos temibles")
                nombreLimpio = nombreLimpio.replace(/^\d+\s+/, '');
                  // Normalizar ñ -> n para coincidencias
                nombreLimpio = nombreLimpio.replace(/ñ/g, 'n');

                nombreLimpio = nombreLimpio
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Eliminar tildes
                    .replace(/[^a-z0-9\s]/g, "") // Eliminar caracteres especiales
                    .replace(/\s+/g, ' '); // Espacios múltiples a uno
                
                // Buscar si el nombre está en el diccionario de plurales
                if (this.monstruos_imagenes.plurales) {
                    for (const [plural, singular] of Object.entries(this.monstruos_imagenes.plurales)) {
                        if (nombreLimpio === plural) {
                            nombreLimpio = singular;
                            break;
                        }
                    }
                }
                
                // Si no se encontró en el diccionario, aplicar reglas generales
                if (nombreLimpio.endsWith('es')) {
                    nombreLimpio = nombreLimpio.slice(0, -2);
                } else if (nombreLimpio.endsWith('s')) {
                    nombreLimpio = nombreLimpio.slice(0, -1);
                }
                
                // Obtener todas las claves y ordenarlas de más largas a más cortas
                // Esto asegura que "goblin chamán" se busque antes que "goblin"
                const clavesOrdenadas = Object.keys(this.monstruos_imagenes.mapeo_imagenes)
                    .sort((a, b) => b.length - a.length);
                
                // Buscar coincidencia en el mapeo (empezando por las claves más largas)
                for (const clave of clavesOrdenadas) {
                    if (nombreLimpio.includes(clave)) {
                        return `${this.TOKENS_DIR}/${this.monstruos_imagenes.mapeo_imagenes[clave]}`;
                    }
                }
                
                // Imagen por defecto si no se encuentra coincidencia
                return `${this.TOKENS_DIR}/default.png`;
            }

            obtenerTipoEnemigo(nombre) {
                nombre = nombre.toLowerCase();
                if (nombre.includes('goblin') || nombre.includes('orco') || nombre.includes('ogro')) return 'humanoide';
                else if (nombre.includes('esqueleto') || nombre.includes('zombi') || nombre.includes('muerto')) return 'no-muerto';
                else if (nombre.includes('dragón') || nombre.includes('wyvern') || nombre.includes('grifo')) return 'dragón';
                else if (nombre.includes('demonio') || nombre.includes('diablo') || nombre.includes('infernal')) return 'demonio';
                else if (nombre.includes('lobo') || nombre.includes('rata') || nombre.includes('araña')) return 'bestia';
                else if (nombre.includes('hechicero') || nombre.includes('mago') || nombre.includes('brujo')) return 'magico';
                else return 'otros';
            }
            
            obtenerColorPorTipo(tipo) {
                const colores = {
                    'humanoide': '#8B4513', 'no-muerto': '#696969', 'dragón': '#B22222',
                    'demonio': '#4B0082', 'bestia': '#556B2F', 'magico': '#9370DB', 'otros': '#2F4F4F'
                };
                return colores[tipo] || '#2F4F4F';
            }
            
            obtenerAbreviatura(nombre) {
                if (nombre.length <= 3) return nombre.substring(0, 3);
                const palabras = nombre.split(' ');
                if (palabras.length > 1) return palabras.map(p => p[0]).join('').toUpperCase().substring(0, 3);
                return nombre.substring(0, 3).toUpperCase();
            }
            
            
            
            ajustarUIResponsive() {
                const eventLog = document.getElementById('event-log');
                if (window.innerWidth > 1000) eventLog.style.fontSize = '14px';
            }
            
            async cargarConfiguraciones() {
                try {
                    this.BASE_DIR = window.location.href.replace(/\/[^\/]*$/, '');
                    this.IMAGES_DIR = `${this.BASE_DIR}/assets/imagenes`;
                    this.AUDIO_DIR = `${this.BASE_DIR}/assets/audio`;
                    this.DATA_DIR = `${this.BASE_DIR}/assets/data`;
                    this.TOKENS_DIR = `${this.BASE_DIR}/assets/tokens`;
                    
                    const configFiles = ['ui_config.json', 'estados.json', 'descansos.json', 'recompensas.json', 'comportamiento.json'];
                    
                    // Cargar archivos de configuración principales
                    const [uiConfig, estadosConfig, descansosConfig, recompensasConfig, comportamientoConfig] = await Promise.all(
                        configFiles.map(file => 
                            fetch(`${this.DATA_DIR}/${file}`)
                                .then(response => {
                                    if (!response.ok) throw new Error(`No se pudo cargar ${file}`);
                                    return response.json();
                                })
                                .catch(error => {
                                    console.error(`Error cargando ${file}:`, error);
                                    return {};
                                })
                        )
                    );
                    
                    // Cargar archivos específicos de monstruos
                    const [tamanosResponse, monstruosExpResponse, monstruosImagenesResponse] = await Promise.all([
                        fetch(`${this.DATA_DIR}/encuentros/tamanos_monstruos.json`),
                        fetch(`${this.DATA_DIR}/encuentros/monstruos-exp.json`),
                        fetch(`${this.DATA_DIR}/monstruos-imagenes.json`)
                    ]);
                    
                    if (!tamanosResponse.ok) throw new Error("No se pudo cargar tamanos_monstruos.json");
                    if (!monstruosExpResponse.ok) throw new Error("No se pudo cargar monstruos-exp.json");
                    if (!monstruosImagenesResponse.ok) throw new Error("No se pudo cargar monstruos-imagenes.json");
                    
                    this.tamanos_monstruos = await tamanosResponse.json();
                    this.monstruos_exp = await monstruosExpResponse.json();
                    this.monstruos_imagenes = await monstruosImagenesResponse.json();
                    
                    this.ui_config = uiConfig || {};
                    this.estados_config = estadosConfig || {limites: {moral_max: 100, cordura_max: 100}};
                    this.descansos = descansosConfig || {};
                    this.recompensas = recompensasConfig || {};
                    this.comportamiento = comportamientoConfig || {};
                    
                    await this.cargarEncuentros();
                    
                } catch (e) {
                    console.error("Error cargando configuraciones:", e);
                    this.mostrarMensajeLog(`Error: ${e.message}`, 'enemigo');
                    this.ui_config = {};
                    this.estados_config = {limites: {moral_max: 100, cordura_max: 100}};
                    this.descansos = {};
                    this.recompensas = {};
                    this.comportamiento = {};
                    this.monstruos_exp = {monstruos: []};
                    this.monstruos_imagenes = {mapeo_imagenes: {}, plurales: {}};
                    this.tamanos_monstruos = {tamaños: {}};
                }
            }

            
            async cargarEncuentros() {
                try {
                    let archivoEncuentros = '';
                    if (this.nivel_valor <= 2) archivoEncuentros = 'nivel_1_2.json';
                    else if (this.nivel_valor <= 4) archivoEncuentros = 'nivel_3_4.json';
                    else if (this.nivel_valor <= 6) archivoEncuentros = 'nivel_5_6.json';
                    else archivoEncuentros = 'nivel_7_8.json';
                    
                    const response = await fetch(`${this.DATA_DIR}/encuentros/${archivoEncuentros}`);
                    if (!response.ok) throw new Error(`No se pudo cargar ${archivoEncuentros}`);
                    
                    this.encuentros = await response.json();
                } catch (e) {
                    console.error("Error cargando encuentros:", e);
                    this.mostrarMensajeLog(`No se pudo cargar los encuentros: ${e.message}`, 'enemigo');
                    this.encuentros = {};
                }
            }

            
            inicializarUI() {
                this.cargarImagenesBotones();
                this.configurarEventosBotones();
                this.cargarFondo();
            }

            obtenerTamanoMonstruo(nombre) {
                if (this.tamanos_monstruos.tamaños && this.tamanos_monstruos.tamaños[nombre]) {
                    return this.tamanos_monstruos.tamaños[nombre];
                }
                
                for (const key in this.tamanos_monstruos.tamaños) {
                    if (nombre.includes(key) || key.includes(nombre)) {
                        return this.tamanos_monstruos.tamaños[key];
                    }
                }
                
                return "NORMAL";
            }
            
            cargarImagenesBotones() {
                const botonesConfig = {
                    'btn-nivel-down': 'btn_nivel_down.png', 'btn-nivel-up': 'btn_nivel_up.png',
                    'btn-apuesta-down': 'btn_apuesta_down.png', 'btn-apuesta-up': 'btn_apuesta_up.png',
                    'btn-iniciar': 'btn_iniciar.png', 'btn-ronda': 'btn_ronda.png',
                    'btn-heroico': 'btn_heroico.png', 'btn-deshonroso': 'btn_deshonroso.png',
                    'btn-musica-on': 'btn_con_musica.png', 'btn-musica-off': 'btn_sin_musica.png',
                    'btn-reiniciar': 'btn_reiniciar.png', 'btn-reglas': 'btn_reglas.png'
                };
                
                for (const [id, imagen] of Object.entries(botonesConfig)) {
                    const btn = document.getElementById(id);
                    if (btn) btn.style.backgroundImage = `url('${this.IMAGES_DIR}/${imagen}')`;
                }
            }
            
            configurarEventosBotones() {
                document.getElementById('btn-nivel-up').addEventListener('click', () => this.incrementarNivel());
                document.getElementById('btn-nivel-down').addEventListener('click', () => this.decrementarNivel());
                document.getElementById('btn-apuesta-up').addEventListener('click', () => this.incrementarApuesta());
                document.getElementById('btn-apuesta-down').addEventListener('click', () => this.decrementarApuesta());
                document.getElementById('btn-iniciar').addEventListener('click', () => this.iniciarArena());
                document.getElementById('btn-ronda').addEventListener('click', () => this.siguienteRonda());
                document.getElementById('btn-heroico').addEventListener('click', () => this.evaluarAccion('heroica'));
                document.getElementById('btn-deshonroso').addEventListener('click', () => this.evaluarAccion('deshonrosa'));
                document.getElementById('btn-reiniciar').addEventListener('click', () => this.reiniciarArena());
                document.getElementById('btn-reglas').addEventListener('click', () => this.mostrarReglas());
                document.getElementById('btn-musica-on').addEventListener('click', () => this.desactivarMusica());
                document.getElementById('btn-musica-off').addEventListener('click', () => this.activarMusica());
            }
            
            cargarFondo() {
                const fondo = document.getElementById('background');
                fondo.style.backgroundImage = `url('${this.IMAGES_DIR}/fondo.png')`;
            }
            
            inicializarEstados() {
                const limites = this.estados_config.limites || {};
                this.moral_grupo = limites.moral_max || 10;
                this.cordura = limites.cordura_max || 10;
                
                this.heroes_nivel = null;
                this.ronda_actual = 1;
                this.encuentro_actual = null;
                this.encuentros = {};
                this.acciones_heroicas = 0;
                this.acciones_deshonrosas = 0;
                this.bonif_critico = false;
                this.apuesta_activa = false;
                this.apuesta_monedas = 0;
                this.reward_log_visible = false;
                this.exp_total_acumulada = 0;
            }
            
            inicializarMusica() {
                this.audioElement = new Audio(`${this.AUDIO_DIR}/musica_fondo.mp3`);
                this.audioElement.loop = true;
                this.audioElement.volume = 0.7;
                this.audioElement.play().catch(e => console.log("Error al reproducir música automáticamente:", e));
            }
            
            mostrarMensajeBienvenida() {
                this.mostrarMensajeLog("\n=== BIENVENIDO A LA ARENA DE LORAINIA ===", 'titulo');
                this.mostrarMensajeLog("¡Atención, ciudadanos de Lorainia! Aventureros de las Tierras Antiguas,\n"
                                     + "estáis bajo la atenta mirada de los dioses y del gran rey Logan III.", 'publico');
                this.mostrarMensajeLog("Reglamento escrito por José Manuel Arena v1.4 y aplicacion por Omar Nieto (DETION)", 'enemigo');
            }
            
            iniciarEfectoParpadeo() {
                this.blink_interval = setInterval(() => this.blink_state = !this.blink_state, 500);
            }
            
            configurarEventos() {}
            
            incrementarNivel() {
                if (this.nivel_valor < 10) {
                    this.nivel_valor++;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                    this.actualizarNivelArena();
                }
            }
            
            decrementarNivel() {
                if (this.nivel_valor > 1) {
                    this.nivel_valor--;
                    document.getElementById('nivel-label').textContent = this.nivel_valor;
                    this.actualizarNivelArena();
                }
            }

            actualizarNivelArena() {
                let nivelArena = "", color = "";
                if (this.nivel_valor <= 2) { nivelArena = "COBRE"; color = "#CD7F32"; }
                else if (this.nivel_valor <= 4) { nivelArena = "BRONCE"; color = "#B87333"; }
                else if (this.nivel_valor <= 6) { nivelArena = "PLATA"; color = "#C0C0C0"; }
                else { nivelArena = "ORO"; color = "#FFD700"; }
                
                const nivelArenaLabel = document.getElementById('nivel-arena-label');
                nivelArenaLabel.textContent = `Nivel arena ${nivelArena}`;
                nivelArenaLabel.style.color = color;
            }
            
            incrementarApuesta() {
                if (this.apuesta_valor < 500) {
                    this.apuesta_valor = Math.min(500, this.apuesta_valor + 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            decrementarApuesta() {
                if (this.apuesta_valor > 0) {
                    this.apuesta_valor = Math.max(0, this.apuesta_valor - 10);
                    document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                }
            }
            
            mostrarMensajeLog(mensaje, tipo) {
                const eventLog = document.getElementById('event-log');
                const p = document.createElement('p');
                p.className = `log-${tipo}`;
                p.textContent = mensaje;
                eventLog.appendChild(p);
                eventLog.scrollTop = eventLog.scrollHeight;
            }
            
            activarMusica() {
                this.musica_activada = true;
                document.getElementById('btn-musica-off').style.display = 'none';
                document.getElementById('btn-musica-on').style.display = 'block';
                if (this.audioElement) this.audioElement.play().catch(e => console.log("Error al reactivar música:", e));
            }
            
            desactivarMusica() {
                this.musica_activada = false;
                document.getElementById('btn-musica-on').style.display = 'none';
                document.getElementById('btn-musica-off').style.display = 'block';
                if (this.audioElement) this.audioElement.pause();
            }
            
            reiniciarArena() {
                const eventLog = document.getElementById('event-log');
                eventLog.innerHTML = '';
                this.inicializarEstados();
                document.getElementById('btn-iniciar').disabled = false;
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                this.nivel_valor = 1;
                this.apuesta_valor = 0;
                document.getElementById('nivel-label').textContent = this.nivel_valor;
                document.getElementById('apuesta-label').textContent = this.apuesta_valor;
                if (this.gridVisible) this.ocultarGrid();
                this.mostrarMensajeBienvenida();
            }
            
            mostrarReglas() {
                this.mostrarMensajeLog("\n=== REGLAS DE LA ARENA ===", 'titulo');
                this.mostrarMensajeLog("1. Selecciona el nivel de tus héroes y la apuesta inicial", 'lista');
                this.mostrarMensajeLog("2. Haz clic en 'Iniciar Arena' para comenzar", 'lista');
                this.mostrarMensajeLog("3. En cada ronda, enfrentarás enemigos aleatorios", 'lista');
                this.mostrarMensajeLog("4. Después de cada encuentro, puedes realizar acciones heroicas o deshonrosas", 'lista');
                this.mostrarMensajeLog("5. Gana experiencia y recompensas al completar rondas", 'lista');
                this.mostrarMensajeLog("6. ¡Cuidado con la moral y cordura de tu grupo!", 'lista');
            }
            
            async iniciarArena() {
                this.heroes_nivel = this.nivel_valor;
                await this.cargarEncuentros();
                document.getElementById('btn-iniciar').disabled = true;
                document.getElementById('btn-ronda').disabled = false;
                document.getElementById('btn-heroico').disabled = false;
                document.getElementById('btn-deshonroso').disabled = false;
                
                if (this.apuesta_valor > 0) {
                    this.apuesta_activa = true;
                    this.apuesta_monedas = this.apuesta_valor;
                    this.mostrarMensajeLog(`\nHas apostado ${this.apuesta_valor} monedas de oro. ¡Buena suerte!`, 'apuesta');
                }
                
                this.mostrarMensajeLog(`\n=== INICIANDO ARENA NIVEL ${this.nivel_valor} ===`, 'titulo');
                this.mostrarMensajeLog(`Ronda ${this.ronda_actual}`, 'ronda');
                this.ejecutarRonda(this.ronda_actual);
            }
            
            ejecutarRonda(ronda) {
                this.ronda_actual = ronda;
                const tipo_ronda = ronda === 1 ? "Calentamiento" : ronda === 2 ? "Desafío" : "Jefe Final";
                
                if (ronda === 2 || ronda === 3) this.mostrarDescansoCorto();
                
                const encuentros_ronda = this.encuentros[`ronda_${ronda}`];
                if (!encuentros_ronda) {
                    this.mostrarMensajeLog(`No se encontraron encuentros para la ronda ${ronda}`, 'enemigo');
                    return;
                }
                
                const tirada = Math.floor(Math.random() * 100) + 1;
                
                for (const encuentro of encuentros_ronda) {
                    const [rango_min, rango_max] = encuentro.rango.split('-').map(Number);
                    if (tirada >= rango_min && tirada <= rango_max) {
                        this.encuentro_actual = encuentro.enemigos;
                        break;
                    }
                }
                
                if (!this.encuentro_actual && encuentros_ronda.length > 0) {
                    this.encuentro_actual = encuentros_ronda[encuentros_ronda.length - 1].enemigos;
                }
                
                this.mostrarMensajeLog(`\n=== RONDA ${ronda}: ${tipo_ronda.toUpperCase()} ===`, 'ronda');
                this.mostrarMensajeLog(`Tirada: ${tirada}`, 'enemigo');
                this.mostrarEnemigos();
                this.bonif_critico = false;
            }

            mostrarEnemigos() {
                if (!this.encuentro_actual) {
                    this.mostrarMensajeLog("No hay enemigos en esta ronda", 'enemigo');
                    return 0;
                }
                
                const encuentroProcesado = this.procesarExpresionDados(this.encuentro_actual);
                const gruposEnemigos = encuentroProcesado.split(" y ");
                
                this.mostrarMensajeLog("\nENEMIGOS EN LA ARENA:", 'enemigo');
                
                const iconos_enemigos = {
                    "Hechicero": "🧙", "Escudo": "🛡️", "Espada": "⚔️", "Hacha": "⚔️",
                    "Nigromante": "🧙", "Brujo": "🧙", "Chamán": "🧙", "Psíquico": "🧠",
                    "Acechador": "👁️", "Lobo": "🐺", "Rata": "🐀", "Araña": "🕷️",
                    "Ogro": "👹", "Orco": "👹", "Goblin": "👺", "Esqueleto": "💀",
                    "Zombi": "🧟", "Demonio": "😈", "Dragón": "🐲", "Troll": "👹",
                    "Gigante": "👣", "Sátiro": "🐐", "Gárgola": "🗿", "Hidra": "🐍",
                    "Grifo": "🦅", "Wyvern": "🐉", "Vampiro": "🦇", "Momia": "🧟"
                };
                
                let expTotal = 0;
                let expDesglose = [];
                let enemigosParaGrid = [];
                
                for (const grupo of gruposEnemigos) {
                    const grupoTrim = grupo.trim();
                    let cantidad = 1;
                    let nombreCompleto = grupoTrim;
                    let equipamiento = "";
                    
                    // Extraer equipamiento (texto entre paréntesis)
                    const equipamientoMatch = grupoTrim.match(/\((.*?)\)/);
                    if (equipamientoMatch) {
                        equipamiento = equipamientoMatch[1];
                        nombreCompleto = grupoTrim.replace(/\s*\(.*?\)/, '');
                    }
                    
                    const matchCantidad = nombreCompleto.match(/^(\d+)\s+(.+)$/);
                    if (matchCantidad) {
                        cantidad = parseInt(matchCantidad[1]);
                        nombreCompleto = matchCantidad[2];
                    }
                    
                    let nombreLimpio = nombreCompleto.replace(/\s*\(.*\)$/, '')
                        .replace(/\s*\+.*$/, '')
                        .trim();
                    
                    const monstruoInfo = this.buscarMonstruoPorNombre(nombreLimpio);
                    
                    let expMonstruo = 0;
                    if (monstruoInfo) {
                        expMonstruo = monstruoInfo.exp * cantidad;
                        expTotal += expMonstruo;
                        expDesglose.push({ nombre: nombreLimpio, cantidad: cantidad, expIndividual: monstruoInfo.exp, expTotal: expMonstruo });
                    } else {
                        const expPorDefecto = this.nivel_valor * 100;
                        expMonstruo = expPorDefecto * cantidad;
                        expTotal += expMonstruo;
                    }
                    
                    enemigosParaGrid.push({ nombre: nombreLimpio, cantidad: cantidad });
                    
                    let icono = "👹";
                    for (const [tipo, emoji] of Object.entries(iconos_enemigos)) {
                        if (nombreLimpio.includes(tipo)) {
                            icono = emoji;
                            break;
                        }
                    }
                    
                    if (monstruoInfo) {
                        let mensajeEnemigo = `${icono} ${cantidad} ${nombreLimpio} (EXP: ${expMonstruo} = ${cantidad} × ${monstruoInfo.exp})`;
                        if (equipamiento) {
                            mensajeEnemigo += ` - Equipamiento: ${equipamiento}`;
                        }
                        this.mostrarMensajeLog(mensajeEnemigo, 'enemigo');
                    } else {
                        let mensajeEnemigo = `${icono} ${cantidad} ${nombreLimpio} (EXP: ${expMonstruo})`;
                        if (equipamiento) {
                            mensajeEnemigo += ` - Equipamiento: ${equipamiento}`;
                        }
                        this.mostrarMensajeLog(mensajeEnemigo, 'enemigo');
                    }
                }
                
                this.mostrarGridConEnemigos(enemigosParaGrid);
                
                if (expTotal > 0) {
                    this.exp_total_acumulada += expTotal;
                    this.exp_encuentro_actual = expTotal;
                }
                
                return expTotal;
            }
          

            mostrarDescansoCorto() {
                const descanso = this.descansos["corto"];
                if (!descanso) {
                    this.mostrarMensajeLog("No se encontró información de descanso corto", 'enemigo');
                    return;
                }
                
                this.mostrarMensajeLog("\n=== DESCANSO CORTO ===", 'titulo');
                this.mostrarMensajeLog(descanso.descripcion || "Los héroes toman un breve descanso", 'efecto');
                this.mostrarMensajeLog(`Duración: ${descanso.duracion}`, 'efecto');
                this.mostrarMensajeLog("\nBENEFICIOS:", 'titulo');
                
                if (descanso.beneficios && Array.isArray(descanso.beneficios)) {
                    descanso.beneficios.forEach(beneficio => this.mostrarMensajeLog(`• ${beneficio}`, 'lista'));
                }
                
                this.aplicarEfectosDescanso(descanso.efectos);
            }

            aplicarEfectosDescanso(efectos) {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                if (efectos.moral) {
                    this.moral_grupo = Math.min(moral_max, this.moral_grupo + efectos.moral);
                    this.mostrarMensajeLog(`\nMoral del grupo +${efectos.moral}`, 'recompensa');
                }
                
                if (efectos.cordura === "1d3") {
                    const recuperacionCordura = Math.floor(Math.random() * 3) + 1;
                    this.cordura = Math.min(cordura_max, this.cordura + recuperacionCordura);
                    this.mostrarMensajeLog(`Cordura +${recuperacionCordura} (1d3)`, 'recompensa');
                } else if (typeof efectos.cordura === "number") {
                    this.cordura = Math.min(cordura_max, this.cordura + efectos.cordura);
                    this.mostrarMensajeLog(`Cordura +${efectos.cordura}`, 'recompensa');
                }
                
                this.mostrarEstadosActuales();
            }
            
            procesarExpresionDados(expresion, mostrarDetalle = true) {
                const regexDados = /(\d+)d(\d+)([+-]\d+)?/g;
                let resultado = expresion;
                let match;
                
                while ((match = regexDados.exec(expresion)) !== null) {
                    const cantidad = parseInt(match[1]);
                    const caras = parseInt(match[2]);
                    const modificador = match[3] ? parseInt(match[3]) : 0;
                    
                    let total = 0;
                    let tiradas = [];
                    for (let i = 0; i < cantidad; i++) {
                        const tirada = Math.floor(Math.random() * caras) + 1;
                        tiradas.push(tirada);
                        total += tirada;
                    }
                    total += modificador;
                    
                    let textoReemplazo = `${total}`;
                    if (mostrarDetalle && cantidad > 1) {
                        textoReemplazo = `${total} [${match[0]}: ${tiradas.join("+")}${modificador ? modificador : ""}]`;
                    }
                    
                    resultado = resultado.replace(match[0], textoReemplazo);
                }
                
                const regexCantidadFija = /^(\d+)\s+([^0-9].*)$/;
                const matchFijo = resultado.match(regexCantidadFija);
                
                if (matchFijo && !resultado.includes('d')) {
                    const cantidad = parseInt(matchFijo[1]);
                    const nombre = matchFijo[2];
                    resultado = `${cantidad} ${nombre}`;
                }
                
                return resultado;
            }

            buscarMonstruoPorNombre(nombreBuscado) {
                if (!this.monstruos_exp.monstruos || this.monstruos_exp.monstruos.length === 0) return null;
                
                const nombreLimpio = nombreBuscado.trim().toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^a-z0-9\s]/g, "")
                    .replace(/\s+/g, ' ');
                
                // PRIMERA BÚSQUEDA: Coincidencia exacta con cualquier forma del nombre
                let monstruo = this.monstruos_exp.monstruos.find(m => {
                    // Modificación: ahora m.nombre puede ser string o array
                    const nombresMonstruo = Array.isArray(m.nombre) ? m.nombre : [m.nombre];
                    
                    return nombresMonstruo.some(nombre => {
                        const nombreMonstruoLimpio = nombre.toLowerCase()
                            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                            .replace(/[^a-z0-9\s]/g, "")
                            .replace(/\s+/g, ' ');
                        return nombreMonstruoLimpio === nombreLimpio;
                    });
                });
                
                if (monstruo) return monstruo;
                
                // SEGUNDA BÚSQUEDA: Coincidencia parcial (incluye o está incluido)
                monstruo = this.monstruos_exp.monstruos.find(m => {
                    const nombresMonstruo = Array.isArray(m.nombre) ? m.nombre : [m.nombre];
                    
                    return nombresMonstruo.some(nombre => {
                        const nombreMonstruoLimpio = nombre.toLowerCase()
                            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                            .replace(/[^a-z0-9\s]/g, "")
                            .replace(/\s+/g, ' ');
                        
                        return nombreLimpio.includes(nombreMonstruoLimpio) || 
                            nombreMonstruoLimpio.includes(nombreLimpio);
                    });
                });
                
                if (monstruo) return monstruo;
                
                // TERCERA BÚSQUEDA: Por palabras clave (tu sistema de respaldo)
                const palabrasClave = {
                    'goblin': 'Goblin', 'zombi': 'Zombi', 'lobo': 'Lobo Gigante', 'bandido': 'Bandido',
                    'brujo': 'Brujo', 'esqueleto': 'Esqueleto', 'orco': 'Orco', 'sátiro': 'Sátiro',
                    'saurio': 'Saurio', 'tumulario': 'Tumulario', 'gnoll': 'Gnoll', 'sanguijuela': 'Sanguijuela Gigante',
                    'necrófago': 'Necrófago', 'hombre bestia': 'Hombre Bestia', 'araña': 'Araña Gigante',
                    'ogro': 'Ogro', 'nigromante': 'Nigromante', 'licántropo': 'Licántropo','licantropo': 'Licántropo','enredador': 'Enredador',
                    'troll': 'Troll Común', 'minotauro': 'Minotauro', 'momia': 'Momia', 'elfo oscuro': 'Elfo Oscuro',
                    'ettin': 'Ettin', 'espectro': 'Espectro', 'gárgola': 'Gárgola', 'wyvern': 'Wyvern',
                    'demonio': 'Demonio de Sangre', 'guardian': 'Guardián de la Tumba', 'psíquico': 'Psíquico',
                    'esfinge': 'Esfinge', 'naga': 'Naga', 'scorpion': 'Escorpión Gigante', 'vampiro': 'Vampiro',
                    'hidra': 'Hidra', 'gigante': 'Gigante', 'dragón': 'Dragón'
                };
                
                for (const [clave, valor] of Object.entries(palabrasClave)) {
                    if (nombreLimpio.includes(clave)) {
                        return this.monstruos_exp.monstruos.find(m => {
                            const nombresMonstruo = Array.isArray(m.nombre) ? m.nombre : [m.nombre];
                            return nombresMonstruo.includes(valor);
                        });
                    }
                }
                
                return null;
            }

            evaluarAccion(tipo_accion) {
                if (tipo_accion === "heroica") {
                    this.acciones_heroicas++;
                    this.actualizarEstados("heroica");
                } else {
                    this.acciones_deshonrosas++;
                    this.actualizarEstados("deshonrosa");
                }
                
                const tipo_reaccion = tipo_accion === "heroica" ? "apoyo" : "desprecio";
                const reacciones_publico = this.comportamiento.reacciones_publico || {};
                const reacciones = reacciones_publico[tipo_reaccion] || [];
                
                if (reacciones.length > 0) {
                    const reaccion = reacciones[Math.floor(Math.random() * reacciones.length)];
                    this.mostrarMensajeLog(`\nLos héroes realizan una acción ${tipo_accion}:`, tipo_accion);
                    this.mostrarMensajeLog(`» ${reaccion.efecto}`, reaccion.id > 15 ? 'critical' : 'efecto');
                    this.aplicarEfectoPublico(reaccion.id, tipo_accion === "heroica");
                }
                
                this.mostrarEstadosActuales();
            }
            
            actualizarEstados(tipo_accion) {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                const cambios = this.estados_config[tipo_accion] || {};
                
                if (cambios.moral) this.moral_grupo = Math.max(0, Math.min(moral_max, this.moral_grupo + cambios.moral));
                if (cambios.cordura) this.cordura = Math.max(0, Math.min(cordura_max, this.cordura + cambios.cordura));
                if (cambios.bonif_critico) {
                    this.bonif_critico = true;
                    this.mostrarMensajeLog("¡BONIFICACIÓN POR CRÍTICO ACTIVADA!", 'critical');
                }
                
                this.mostrarEstadosActuales();
            }
            
            mostrarEstadosActuales() {
                const limites = this.estados_config.limites || {};
                const moral_max = limites.moral_max || 100;
                const cordura_max = limites.cordura_max || 100;
                
                this.mostrarMensajeLog(`\nESTADO ACTUAL:`, 'titulo');
                this.mostrarMensajeLog(`Moral del Grupo: ${this.moral_grupo}/${moral_max}`, 'efecto');
                this.mostrarMensajeLog(`Cordura: ${this.cordura}/${cordura_max}`, 'efecto');
                if (this.bonif_critico) this.mostrarMensajeLog("¡BONUS CRÍTICO ACTIVO!", 'critical');
            }
            
            siguienteRonda() {
                
                if (this.ronda_actual >= 3) {
                    this.finalizarArena();
                    return;
                }
                
                document.getElementById('btn-heroico').disabled = false;
                document.getElementById('btn-deshonroso').disabled = false;
                this.ejecutarRonda(this.ronda_actual + 1);
            }
            
            finalizarArena() {
                this.mostrarMensajeLog("\n=== ¡LA ARENA HA CONCLUIDO! ===", 'titulo');
                const victoria = this.moral_grupo > 0 && this.cordura > 0;
                
                if (victoria) {
                    this.mostrarMensajeLog("¡VICTORIA DE LOS HÉROES!", 'heroico');
                    this.procesarRecompensas();
                } else {
                    this.mostrarMensajeLog("DERROTA...", 'deshonroso');
                    this.mostrarMensajeLog("Los héroes han caído en la arena", 'enemigo');
                }
                
                document.getElementById('btn-ronda').disabled = true;
                document.getElementById('btn-heroico').disabled = true;
                document.getElementById('btn-deshonroso').disabled = true;
                document.getElementById('btn-iniciar').disabled = false;
            }

            procesarRecompensas() {
                if (!this.recompensas || Object.keys(this.recompensas).length === 0) {
                    this.mostrarMensajeLog("No se encontraron recompensas configuradas", 'enemigo');
                    return;
                }
                
                let grupo_nivel = '';
                if (this.heroes_nivel <= 2) grupo_nivel = 'nivel_1_2';
                else if (this.heroes_nivel <= 4) grupo_nivel = 'nivel_3_4';
                else if (this.heroes_nivel <= 6) grupo_nivel = 'nivel_5_6';
                else if (this.heroes_nivel <= 8) grupo_nivel = 'nivel_7_8';
                else grupo_nivel = 'nivel_7_8';
                
                const recompensa = this.recompensas[grupo_nivel];
                
                if (!recompensa) {
                    this.mostrarMensajeLog(`No se encontraron recompensas para el grupo ${grupo_nivel}`, 'enemigo');
                    this.mostrarMensajeLog(`Recompensas disponibles: ${Object.keys(this.recompensas).join(', ')}`, 'enemigo');
                    return;
                }
                
                let monedas_base = recompensa.monedas || 0;
                let experiencia_base = (recompensa.experiencia || 0) + this.exp_total_acumulada;
                let tesoros = recompensa.tesoros || [];
                
                let multiplicador = 1.0;
                let ganancia_apuesta = 0;
                
                if (this.apuesta_activa && recompensa.multiplicador_monedas) {
                    multiplicador = recompensa.multiplicador_monedas;
                    ganancia_apuesta = parseInt(this.apuesta_monedas * multiplicador);
                }
                
                const monedas_final = monedas_base + ganancia_apuesta;
                const experiencia_final = experiencia_base;
                
                this.mostrarMensajeLog("\nRECOMPENSAS OBTENIDAS:", 'titulo');
                this.mostrarMensajeLog(`Nivel: ${recompensa.nivel}`, 'recompensa');
                this.mostrarMensajeLog(`${monedas_final} monedas de oro`, 'recompensa');
                this.mostrarMensajeLog(`${experiencia_final} puntos de experiencia`, 'recompensa');

                tesoros.forEach(tesoro => this.mostrarMensajeLog(`• ${tesoro}`, 'recompensa'));
                
                if (this.apuesta_activa) {
                    this.mostrarLogRecompensas(monedas_base, monedas_final, multiplicador, ganancia_apuesta, tesoros, experiencia_final, this.exp_total_acumulada);
                }
                
                this.procesarDescanso();
            }
           
            mostrarLogRecompensas(monedas_base, monedas_final, multiplicador, ganancia_apuesta, tesoros, experiencia_base, exp_monstruos) {
                this.mostrarMensajeLog("\nDESGLOSE DE RECOMPENSA:", 'titulo');
                this.mostrarMensajeLog(`Apuesta inicial: ${this.apuesta_monedas} monedas`, 'recompensa');
                this.mostrarMensajeLog(`Recompensa base: ${monedas_base} monedas`, 'recompensa');
                
                if (exp_monstruos > 0) {
                    this.mostrarMensajeLog(`Experiencia total de monstruos: +${this.exp_total_acumulada} EXP`, 'recompensa');
                    this.mostrarMensajeLog(`Experiencia base: +${experiencia_base - this.exp_total_acumulada} EXP`, 'recompensa');
                }
                
                this.mostrarMensajeLog(`Multiplicador: x${multiplicador}`, 'recompensa');
                this.mostrarMensajeLog(`Ganancia por apuesta: ${ganancia_apuesta} monedas`, 'recompensa');
                this.mostrarMensajeLog(`TOTAL: ${monedas_final} monedas y ${experiencia_base} EXP`, 'recompensa');
                
                tesoros.forEach(tesoro => this.mostrarMensajeLog(`• ${tesoro}`, 'recompensa'));
            }
            
            procesarDescanso() {
                const descanso = this.descansos["largo"];
                if (!descanso) {
                    this.mostrarMensajeLog("No se encontró información de descanso largo", 'enemigo');
                    return;
                }
                
                this.mostrarMensajeLog("\nDESCANSO EN LA TABERNA:", 'titulo');
                this.mostrarMensajeLog(descanso.descripcion || "Los héroes descansan y se recuperan", 'efecto');
                this.mostrarMensajeLog(`Duración: ${descanso.duracion}`, 'efecto');
                this.mostrarMensajeLog("\nBENEFICIOS:", 'titulo');
                
                if (descanso.beneficios && Array.isArray(descanso.beneficios)) {
                    descanso.beneficios.forEach(beneficio => this.mostrarMensajeLog(`• ${beneficio}`, 'lista'));
                }
                
                this.aplicarEfectosDescanso(descanso.efectos);
            }
            
            mostrarReglas() {
                const link = document.createElement('a');
                link.href = `${this.BASE_DIR}/assets/data/Arena_V1.4.pdf`;
                link.target = '_blank';
                link.download = 'Arena_V1.4.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.mostrarMensajeLog("\nAbriendo reglas de la arena...", 'publico');
            }
            
            aplicarEfectoPublico(id, esHeroico) {
                if (id > 15) {
                    if (esHeroico) this.moral_grupo = Math.min(this.estados_config.limites.moral_max, this.moral_grupo + 5);
                    else this.cordura = Math.max(0, this.cordura - 3);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => window.arenaApp = new ArenaApp());
    </script>
</body>
</html>